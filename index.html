<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Lottery Pro - India's Most Trusted Lottery Platform</title>
    <meta name="description" content="Join India's most trusted lottery platform with secure payments, fair play, and instant prize distribution.">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Firebase SDK v9 -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>

    <!-- Cashfree SDK -->
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #0052cc;
            --primary-light: #1976d2;
            --primary-dark: #003d99;
            --secondary: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --accent: #7c3aed;
            --background: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --text-lighter: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius: 8px;
            --radius-lg: 12px;
            --transition: all 0.2s ease-in-out;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--background);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 60px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            margin-bottom: 40px;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="10" height="10"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(20px); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .logo {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .tagline {
            font-size: 1.2rem;
            font-weight: 400;
            opacity: 0.95;
            margin-bottom: 30px;
        }

        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        /* User Section */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--surface);
            padding: 25px 30px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 40px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.3rem;
        }

        .user-details h3 {
            margin: 0;
            color: var(--text);
            font-size: 1.2rem;
        }

        .user-balance {
            color: var(--success);
            font-weight: 600;
            font-size: 1rem;
        }

        .user-email {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .user-actions {
            display: flex;
            gap: 15px;
        }

        /* Tabs - Improved spacing */
        .tab-navigation {
            display: flex;
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 15px;
            margin-bottom: 50px;
            box-shadow: var(--shadow);
            overflow-x: auto;
            gap: 12px;
        }

        .tab-btn {
            flex: 1;
            padding: 18px 30px;
            border: none;
            background: transparent;
            color: var(--text-light);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            min-width: 160px;
            font-weight: 500;
            font-size: 1rem;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .tab-btn:hover:not(.active) {
            background: var(--background);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Live Stats */
        .live-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }

        .live-stat {
            background: var(--surface);
            padding: 35px 30px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .live-stat:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .live-stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .live-stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .live-stat-label {
            font-size: 1rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 54px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Cards */
        .card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        /* Contest Cards - Better spacing */
        .contest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 40px;
            margin-bottom: 60px;
        }

        .contest-card {
            padding: 35px;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 1px solid var(--border);
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
        }

        .contest-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .contest-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .contest-title i {
            color: var(--primary);
        }

        .contest-prize {
            font-size: 3rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .rupee-symbol {
            font-size: 2.4rem;
            opacity: 0.8;
        }

        .contest-details {
            margin-bottom: 30px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .detail-label {
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .progress-bar {
            background: rgba(0,0,0,0.1);
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 30px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s ease;
        }

        /* Prize Distribution */
        .prize-distribution {
            margin-bottom: 30px;
        }

        .prize-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .prize-details {
            margin-top: 20px;
            display: none;
            background: rgba(0, 82, 204, 0.05);
            padding: 25px;
            border-radius: var(--radius);
        }

        .prize-details.show {
            display: block;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(0, 82, 204, 0.1);
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        .prize-position {
            font-weight: 600;
            color: var(--primary);
        }

        .prize-amount {
            font-weight: 700;
            color: var(--success);
        }

        /* Forms */
        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 18px 20px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 1rem;
            transition: var(--transition);
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 6px;
        }

        .amount-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 18px;
            margin-bottom: 25px;
        }

        .amount-btn {
            padding: 18px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .amount-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        /* UPI Options */
        .upi-options {
            margin: 20px 0;
            padding: 20px;
            background: var(--background);
            border-radius: var(--radius);
        }

        .upi-option {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            background: var(--surface);
        }

        .upi-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .upi-option input[type="radio"] {
            margin: 0;
            width: 18px;
            height: 18px;
        }

        .upi-option.selected {
            border-color: var(--primary);
            background: rgba(0, 82, 204, 0.05);
            box-shadow: var(--shadow);
        }

        .upi-option-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .upi-option-icon {
            font-size: 1.8rem;
        }

        .upi-option-text {
            flex: 1;
        }

        .upi-option-name {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .upi-option-desc {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* UPI QR Code */
        .upi-qr-container {
            text-align: center;
            padding: 30px;
            background: var(--surface);
            border-radius: var(--radius);
            margin: 20px 0;
            border: 2px dashed var(--border);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: var(--surface);
            max-width: 500px;
            margin: 50px auto;
            border-radius: var(--radius-lg);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 30px 30px 20px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 1.5rem;
        }

        .modal-close {
            position: absolute;
            top: 25px;
            right: 25px;
            background: none;
            border: none;
            font-size: 1.6rem;
            color: var(--text-light);
            cursor: pointer;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--border);
        }

        .modal-body {
            padding: 30px;
        }

        /* Terms and Conditions Styles */
        .terms-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            background: var(--background);
        }

        .terms-container h3 {
            color: var(--primary);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .terms-container h3:first-child {
            margin-top: 0;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin: 20px 0;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 5px;
            width: 18px;
            height: 18px;
        }

        .otp-container {
            text-align: center;
            padding: 20px;
            background: var(--background);
            border-radius: var(--radius);
            margin: 20px 0;
        }

        .otp-input {
            width: 60px;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            margin: 0 10px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            background: var(--surface);
        }

        .otp-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 82, 204, 0.1);
        }

        /* Auth Forms */
        .auth-container {
            max-width: 450px;
            margin: 0 auto;
            padding: 50px 20px;
        }

        .auth-card {
            background: var(--surface);
            padding: 50px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-header h2 {
            color: var(--text);
            margin-bottom: 10px;
        }

        .auth-header p {
            color: var(--text-light);
        }

        .auth-toggle {
            text-align: center;
            margin-top: 25px;
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 25px;
            right: 25px;
            padding: 18px 24px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading */
        .loading-section {
            display: none;
            text-align: center;
            padding: 80px 20px;
            color: var(--text-light);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 25px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Data Lists */
        .data-list {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .data-item {
            padding: 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item-info {
            flex: 1;
        }

        .data-item-title {
            font-weight: 600;
            color: var(--text);
            margin-bottom: 6px;
        }

        .data-item-subtitle {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .data-item-value {
            font-weight: 700;
            color: var(--primary);
        }

        .transaction-amount.positive {
            color: var(--success);
        }

        .transaction-amount.negative {
            color: var(--error);
        }

        /* Profile Section */
        .profile-section {
            background: var(--surface);
            padding: 40px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 40px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-top: 40px;
        }

        .profile-stat {
            text-align: center;
            padding: 25px;
            background: var(--background);
            border-radius: var(--radius);
        }

        .profile-stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .profile-stat-label {
            color: var(--text-light);
            font-weight: 500;
        }

        /* Payment Summary */
        .payment-summary {
            background: var(--background);
            padding: 25px;
            border-radius: var(--radius);
            margin-bottom: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .summary-row:last-child {
            border-top: 1px solid var(--border);
            padding-top: 15px;
            font-weight: 700;
            font-size: 1.2rem;
        }

        /* Joined Contest Styles */
        .joined-contest-card {
            background: var(--surface);
            padding: 25px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary);
        }

        .joined-contest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .joined-contest-title {
            font-weight: 600;
            color: var(--text);
            font-size: 1.2rem;
        }

        .joined-contest-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-joined {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .status-completed {
            background: rgba(100, 116, 139, 0.1);
            color: var(--secondary);
        }

        .status-won {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .joined-contest-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .joined-detail {
            text-align: center;
        }

        .joined-detail-label {
            font-size: 0.8rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }

        .joined-detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .payment-verification-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .verified {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        .pending {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }

        .failed {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header {
                padding: 50px 20px;
                margin-bottom: 30px;
            }

            .logo {
                font-size: 2.2rem;
            }```text

            .tagline {
                font-size: 1.1rem;
            }

            .user-header {
                padding: 20px 25px;
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .user-actions {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }

            .contest-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .live-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 20px;
            }

            .modal {
                padding: 15px;
            }

            .auth-card {
                padding: 40px 30px;
            }

            .amount-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab-navigation {
                padding: 10px;
            }

            .tab-btn {
                padding: 16px 20px;
                font-size: 0.9rem;
                min-width: 120px;
            }
        }

        /* Hide sections initially */
        #authSection,
        #userSection {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Landing Section -->
    <div id="landingSection">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1 class="logo">Smart Lottery Pro</h1>
                    <p class="tagline">India's Most Trusted Lottery Platform</p>
                    <button class="btn btn-success" onclick="showAuth()" style="font-size: 1.2rem; padding: 18px 36px;">
                        <i class="fas fa-rocket"></i> Join Now & Win Big
                    </button>
                    <div class="trust-badges">
                        <div class="trust-badge">
                            <i class="fas fa-shield-alt"></i> 100% Secure
                        </div>
                        <div class="trust-badge">
                            <i class="fas fa-bolt"></i> Instant Payouts
                        </div>
                        <div class="trust-badge">
                            <i class="fas fa-users"></i> 50,000+ Winners
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Stats -->
            <div class="live-stats">
                <div class="live-stat">
                    <div class="live-stat-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="live-stat-value" id="totalUsers">45,287</div>
                    <div class="live-stat-label">Active Players</div>
                </div>
                <div class="live-stat">
                    <div class="live-stat-icon">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="live-stat-value" id="totalPrizes">₹12.5L</div>
                    <div class="live-stat-label">Prizes Distributed</div>
                </div>
                <div class="live-stat">
                    <div class="live-stat-icon">
                        <i class="fas fa-crown"></i>
                    </div>
                    <div class="live-stat-value" id="winnersToday">127</div>
                    <div class="live-stat-label">Winners Today</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Section -->
    <div id="authSection">
        <div class="auth-container">
            <div class="auth-card">
                <!-- Terms and Conditions Agreement -->
                <div id="termsAgreement">
                    <div class="auth-header">
                        <h2>Terms & Conditions</h2>
                        <p>Please read and accept our terms before proceeding</p>
                    </div>

                    <div class="terms-container">
                        <h3>1. Platform Overview</h3>
                        <p>Smart Lottery Pro is a digital lottery platform licensed under the Information Technology Act, 2000 and operates in compliance with applicable Indian laws. Our platform provides fair, transparent, and secure lottery services to users across India.</p>

                        <h3>2. Eligibility</h3>
                        <p>You must be at least 18 years old and a legal resident of India to participate. Participation is prohibited in states where online lotteries are banned. By registering, you confirm your eligibility and legal capacity to enter into this agreement.</p>

                        <h3>3. Registration & Account Security</h3>
                        <p>You must provide accurate, complete information during registration. You are responsible for maintaining account confidentiality and all activities under your account. Email verification is mandatory for account activation.</p>

                        <h3>4. Payment & Transactions</h3>
                        <p>All payments are processed through secure, licensed payment gateways (Cashfree). Deposits are non-refundable once lottery tickets are purchased. Winnings are credited automatically upon result declaration. Minimum withdrawal is ₹100.</p>

                        <h3>5. Fair Play & Transparency</h3>
                        <p>All lottery draws use certified random number generation systems. Results are transparent and verifiable. No manipulation or fraud is tolerated. Winners are selected based purely on chance and luck.</p>

                        <h3>6. Taxation</h3>
                        <p>Winners are responsible for applicable taxes as per Indian Income Tax laws. TDS will be deducted for winnings above ₹10,000 as per government regulations. We provide necessary tax certificates.</p>

                        <h3>7. Responsible Gaming</h3>
                        <p>We promote responsible gaming. Please play within your means. If you feel you have a gambling problem, please seek help. We reserve the right to suspend accounts showing signs of problem gambling.</p>

                        <h3>8. Privacy & Data Protection</h3>
                        <p>We protect your personal data as per our Privacy Policy and Indian data protection laws. Your information is never shared with third parties without consent, except as required by law.</p>

                        <h3>9. Dispute Resolution</h3>
                        <p>Any disputes will be resolved through arbitration in accordance with Indian Arbitration laws. The jurisdiction will be Mumbai, Maharashtra. Customer support is available 24/7 for assistance.</p>

                        <h3>10. Platform Availability</h3>
                        <p>We strive for 99.9% uptime but cannot guarantee uninterrupted service. Maintenance windows will be announced in advance. No liability for temporary service disruptions.</p>
                    </div>

                    <div class="terms-checkbox">
                        <input type="checkbox" id="acceptTerms" required>
                        <label for="acceptTerms">I have read, understood, and agree to the Terms & Conditions, Privacy Policy, and confirm that I am 18+ years old and legally eligible to participate in online lotteries.</label>
                    </div>

                    <button class="btn btn-primary btn-full" onclick="proceedToAuth()" id="proceedBtn" disabled>
                        <i class="fas fa-check-circle"></i> Accept & Continue
                    </button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" style="display: none;">
                    <div class="auth-header">
                        <h2>Welcome Back</h2>
                        <p>Sign in to continue your winning journey</p>
                    </div>
                    <form onsubmit="handleLogin(event)">
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="loginEmail" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div class="password-input-container">
                                <input type="password" class="form-input" id="loginPassword" required placeholder="Enter your password">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
                    </form>
                    <div class="auth-toggle">
                        Don't have an account? <a href="#" onclick="toggleAuthForm('signup')">Sign Up</a>
                    </div>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" style="display: none;">
                    <div class="auth-header">
                        <h2>Join Smart Lottery</h2>
                        <p>Create your account and start winning</p>
                    </div>
                    <form onsubmit="handleSignup(event)">
                        <div class="form-group">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-input" id="signupName" required placeholder="Enter your full name">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Email Address</label>
                            <input type="email" class="form-input" id="signupEmail" required placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Password</label>
                            <div class="password-input-container">
                                <input type="password" class="form-input" id="signupPassword" required placeholder="Create a strong password" minlength="6">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('signupPassword')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full">
                            <i class="fas fa-user-plus"></i> Create Account
                        </button>
                    </form>
                    <div class="auth-toggle">
                        Already have an account? <a href="#" onclick="toggleAuthForm('login')">Sign In</a>
                    </div>
                </div>

                <!-- Email OTP Verification -->
                <div id="otpVerification" style="display: none;">
                    <div class="auth-header">
                        <h2>Verify Your Email</h2>
                        <p>Enter the 6-digit code sent to your email</p>
                    </div>

                    <div class="otp-container">
                        <input type="text" class="otp-input" maxlength="1" id="otp1" oninput="moveToNext(this, 'otp2')">
                        <input type="text" class="otp-input" maxlength="1" id="otp2" oninput="moveToNext(this, 'otp3')">
                        <input type="text" class="otp-input" maxlength="1" id="otp3" oninput="moveToNext(this, 'otp4')">
                        <input type="text" class="otp-input" maxlength="1" id="otp4" oninput="moveToNext(this, 'otp5')">
                        <input type="text" class="otp-input" maxlength="1" id="otp5" oninput="moveToNext(this, 'otp6')">
                        <input type="text" class="otp-input" maxlength="1" id="otp6" oninput="moveToNext(this, null)">
                    </div>

                    <button class="btn btn-primary btn-full" onclick="verifyOTP()">
                        <i class="fas fa-check-circle"></i> Verify Email
                    </button>

                    <div class="auth-toggle">
                        Didn't receive code? <a href="#" onclick="resendOTP()">Resend OTP</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Section -->
    <div id="userSection">
        <div class="container">
            <!-- User Header -->
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <h3 id="userDisplayName">Smart Player</h3>
                        <div class="user-email" id="userEmail">user@example.com</div>
                        <div class="user-balance">Balance: <span id="userBalance">₹0</span></div>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-success" onclick="openModal('addMoneyModal')">
                        <i class="fas fa-plus"></i> Add Money
                    </button>
                    <button class="btn btn-outline" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="tab-navigation">
                <button class="tab-btn active" onclick="switchTab('contests')">
                    <i class="fas fa-trophy"></i> Live Contests
                </button>
                <button class="tab-btn" onclick="switchTab('joinedContests')">
                    <i class="fas fa-list"></i> My Contests
                </button>
                <button class="tab-btn" onclick="switchTab('winners')">
                    <i class="fas fa-crown"></i> Winners
                </button>
                <button class="tab-btn" onclick="switchTab('transactions')">
                    <i class="fas fa-exchange-alt"></i> Transactions
                </button>
                <button class="tab-btn" onclick="switchTab('profile')">
                    <i class="fas fa-user"></i> Profile
                </button>
                <button class="tab-btn" onclick="switchTab('withdrawal')">
                    <i class="fas fa-money-bill-wave"></i> Withdraw
                </button>
                <button class="tab-btn" onclick="switchTab('admin')" id="adminTab" style="display: none;">
                    <i class="fas fa-crown"></i> Admin
                </button>
            </div>

            <!-- Tab Contents -->
            <div id="contestsTab" class="tab-content active">
                <div class="contest-grid" id="contestGrid">
                    <!-- Contest cards will be rendered here -->
                </div>
            </div>

            <div id="joinedContestsTab" class="tab-content">
                <div id="joinedContestsList">
                    <!-- Joined contests will be rendered here -->
                </div>
            </div>

            <div id="winnersTab" class="tab-content">
                <div id="winnersList" class="data-list">
                    <!-- Winners will be rendered here -->
                </div>
            </div>

            <div id="transactionsTab" class="tab-content">
                <div id="transactionsList" class="data-list">
                    <!-- Transactions will be rendered here -->
                </div>
            </div>

            <div id="profileTab" class="tab-content">
                <div class="profile-section">
                    <h2>Your Profile</h2>
                    <div class="profile-stats">
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileContestsJoined">0</div>
                            <div class="profile-stat-label">Contests Joined</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileContestsWon">0</div>
                            <div class="profile-stat-label">Contests Won</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileTotalWinnings">₹0</div>
                            <div class="profile-stat-label">Total Winnings</div>
                        </div>
                        <div class="profile-stat">
                            <div class="profile-stat-value" id="profileWinRate">0%</div>
                            <div class="profile-stat-label">Win Rate</div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="withdrawalTab" class="tab-content">
                <div class="profile-section">
                    <h2>Withdraw Money</h2>
                    <p style="margin-bottom: 25px; color: var(--text-light);">Withdraw your winnings directly to your bank account</p>

                    <div class="form-group">
                        <label class="form-label">Withdrawal Amount</label>
                        <input type="number" class="form-input" id="withdrawalAmount" min="100" placeholder="Minimum ₹100">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Bank Account Number</label>
                        <input type="text" class="form-input" id="withdrawalAccount" placeholder="Enter your account number">
                    </div>

                    <div class="form-group">
                        <label class="form-label">IFSC Code</label>
                        <input type="text" class="form-input" id="withdrawalIFSC" placeholder="Enter IFSC code">
                    </div>

                    <button class="btn btn-primary btn-full" onclick="handleWithdrawal()">
                        <i class="fas fa-money-bill-wave"></i> Request Withdrawal
                    </button>

                    <div style="margin-top: 25px; padding: 20px; background: var(--background); border-radius: var(--radius); font-size: 0.95rem; color: var(--text-light);">
                        <strong>Note:</strong> Withdrawals are processed within 24-48 hours. Minimum withdrawal amount is ₹100.
                    </div>
                </div>
            </div>

            <div id="adminTab" class="tab-content">
                <div class="profile-section">
                    <h2>Admin Panel</h2>
                    <p style="margin-bottom: 25px; color: var(--text-light);">Manage contests and declare results</p>

                    <div class="contest-management">
                        <h3>Contest Management</h3>
                        <div id="adminContestsList">
                            <!-- Admin contest controls will be rendered here -->
                        </div>
                    </div>
                </div>
            </div></div>
        </div>
    </div>

    <!-- Loading Section -->
    <div id="loadingSection" class="loading-section">
        <div class="loading-spinner"></div>
        <p>Loading your lottery experience...</p>
    </div>

    <!-- Add Money Modal -->
    <div id="addMoneyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Money to Wallet</h2>
                <button class="modal-close" onclick="closeModal('addMoneyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Amount</label>
                    <div class="amount-buttons">
                        <button class="amount-btn" onclick="setAmount(100)">₹100</button>
                        <button class="amount-btn" onclick="setAmount(500)">₹500</button>
                        <button class="amount-btn" onclick="setAmount(1000)">₹1,000</button>
                        <button class="amount-btn" onclick="setAmount(2000)">₹2,000</button>
                        <button class="amount-btn" onclick="setAmount(5000)">₹5,000</button>
                        <button class="amount-btn" onclick="setAmount(10000)">₹10,000</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Or Enter Custom Amount</label>
                    <input type="number" class="form-input" id="amountInput" min="10" max="50000" placeholder="Enter amount (₹10 - ₹50,000)" oninput="updatePaymentSummary()">
                </div>

                <div class="form-group">
                    <label class="form-label">Select Payment Method</label>
                    <div class="upi-options">
                        <div class="upi-option selected" onclick="selectUPIMethod('gpay')">
                            <input type="radio" name="upiMethod" value="gpay" checked>
                            <div class="upi-option-content">
                                <i class="fab fa-google-pay upi-option-icon" style="color: #34a853;"></i>
                                <div class="upi-option-text">
                                    <div class="upi-option-name">Google Pay</div>
                                    <div class="upi-option-desc">Pay with Google Pay UPI</div>
                                </div>
                            </div>
                        </div>
                        <div class="upi-option" onclick="selectUPIMethod('phonepe')">
                            <input type="radio" name="upiMethod" value="phonepe">
                            <div class="upi-option-content">
                                <i class="fas fa-mobile-alt upi-option-icon" style="color: #5f2c8e;"></i>
                                <div class="upi-option-text">
                                    <div class="upi-option-name">PhonePe</div>
                                    <div class="upi-option-desc">Pay with PhonePe UPI</div>
                                </div>
                            </div>
                        </div>
                        <div class="upi-option" onclick="selectUPIMethod('paytm')">
                            <input type="radio" name="upiMethod" value="paytm">
                            <div class="upi-option-content">
                                <i class="fas fa-wallet upi-option-icon" style="color: #0f4685;"></i>
                                <div class="upi-option-text">
                                    <div class="upi-option-name">Paytm</div>
                                    <div class="upi-option-desc">Pay with Paytm UPI</div>
                                </div>
                            </div>
                        </div>
                        <div class="upi-option" onclick="selectUPIMethod('card')">
                            <input type="radio" name="upiMethod" value="card">
                            <div class="upi-option-content">
                                <i class="fas fa-credit-card upi-option-icon" style="color: #ff6900;"></i>
                                <div class="upi-option-text">
                                    <div class="upi-option-name">Debit/Credit Card</div>
                                    <div class="upi-option-desc">Pay with Bank Card</div>
                                </div>
                            </div>
                        </div>
                        <div class="upi-option" onclick="selectUPIMethod('netbanking')">
                            <input type="radio" name="upiMethod" value="netbanking">
                            <div class="upi-option-content">
                                <i class="fas fa-university upi-option-icon" style="color: #007bff;"></i>
                                <div class="upi-option-text">
                                    <div class="upi-option-name">Net Banking</div>
                                    <div class="upi-option-desc">Pay with Internet Banking</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="payment-summary">
                    <div class="summary-row">
                        <span>Amount:</span>
                        <span id="paymentAmount">₹0</span>
                    </div>
                    <div class="summary-row">
                        <span>Processing Fee:</span>
                        <span id="processingFee">₹0</span>
                    </div>
                    <div class="summary-row">
                        <span>Total:</span>
                        <span id="totalAmount">₹0</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Your Email (Required for payment receipt)</label>
                    <input type="email" class="form-input" id="paymentEmail" placeholder="Enter your email for receipt" required>
                </div>

                <button class="btn btn-success btn-full" onclick="handlePayment()">
                    <i class="fas fa-credit-card"></i> Proceed to Payment
                </button>
            </div>
        </div>
    </div>

    <!-- UPI Payment Modal -->
    <div id="upiPaymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>UPI Payment</h2>
                <button class="modal-close" onclick="closeModal('upiPaymentModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="upi-qr-container" id="upiQRCode">
                    <div>
                        <strong>Scan QR Code with any UPI app</strong>
                        <div class="upi-id-display" id="upiIdDisplay">smartlottery@paytm</div>
                        <p style="color: var(--text-light); margin: 10px 0;">Amount: <strong id="upiAmount">₹0</strong></p>
                        <p style="color: var(--text-light); font-size: 0.9rem;">
                            Open your UPI app (Google Pay, PhonePe, Paytm, etc.) and scan the QR code above or pay to the UPI ID
                        </p>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; margin-top: 25px;">
                    <button class="btn btn-outline" onclick="copyUPIId()" style="flex: 1;">
                        <i class="fas fa-copy"></i> Copy UPI ID
                    </button>
                    <button class="btn btn-success" onclick="confirmUPIPayment()" style="flex: 1;">
                        <i class="fas fa-check"></i> Payment Done
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXeD8SMXHnqhNDg01Rlm4fC1t05Eb4NFs",
            authDomain: "smart-lottery-b08c5.firebaseapp.com",
            projectId: "smart-lottery-b08c5",
            storageBucket: "smart-lottery-b08c5.appspot.com",
            messagingSenderId: "1038545058004",
            appId: "1:1038545058004:web:65b29c57eda2939f18e341",
            measurementId: "G-SH9Y19ZE74"
        };

        // API Configuration for Firebase Functions
        const API_BASE_URL = 'https://us-central1-smart-lottery-b08c5.cloudfunctions.net/api';

        // UPI Configuration
        const UPI_CONFIG = {
            merchantId: 'smartlottery@paytm',
            merchantName: 'Smart Lottery Pro',
            merchantCode: 'LOTTERY',
            qrCodeUrl: 'https://api.qrserver.com/v1/create-qr-code/'
        };

        // Global variables
        let currentUser = null;
        let userBalance = 0;
        let auth, db, functions, cashfree;
        let isAdmin = false;
        let currentPaymentAmount = 0;
        let currentPaymentMethod = 'gpay';
        let userProfile = {
            contestsJoined: 0,
            contestsWon: 0,
            totalWinnings: 0
        };
        let transactions = [];
        let winners = [];
        let activeContests = [];
        let joinedContests = [];
        let pendingUserData = null; // Store user data during email verification

        // Admin emails
        const ADMIN_EMAILS = ['vishuu7306@gmail.com', 'admin@smartlottery.com'];

        // Contest templates inspired by Bhagyalakshmi lotteries
        const CONTEST_TEMPLATES = [
            {
                id: 'bhagya_jackpot',
                title: 'Bhagya Mega Jackpot',
                entryFee: 50,
                maxParticipants: 2000,
                prizePool: 100000,
                duration: 6 * 60 * 60 * 1000,
                description: 'Our flagship lottery with life-changing prizes - inspired by traditional Kerala lotteries',
                prizeStructure: [
                    { position: '1st Prize', amount: 50000, percentage: '50%' },
                    { position: '2nd Prize', amount: 25000, percentage: '25%' },
                    { position: '3rd Prize', amount: 15000, percentage: '15%' },
                    { position: 'Consolation (10 winners)', amount: 1000, percentage: '10%' }
                ]
            },
            {
                id: 'golden_draw',
                title: 'Golden Fortune Draw',
                entryFee: 100,
                maxParticipants: 1500,
                prizePool: 150000,
                duration: 12 * 60 * 60 * 1000,
                description: 'Premium lottery with multiple prize tiers and guaranteed consolation prizes',
                prizeStructure: [
                    { position: '1st Prize', amount: 75000, percentage: '50%' },
                    { position: '2nd Prize', amount: 37500, percentage: '25%' },
                    { position: '3rd Prize', amount: 22500, percentage: '15%' },
                    { position: 'Lucky 20 (20 winners)', amount: 750, percentage: '10%' }
                ]
            },
            {
                id: 'speed_bhagya',
                title: 'Speed Bhagya - 30 Minutes',
                entryFee: 25,
                maxParticipants: 800,
                prizePool: 20000,
                duration: 30 * 60 * 1000,
                description: 'Quick-fire lottery with instant results - perfect for instant gratification',
                prizeStructure: [
                    { position: '1st Prize', amount: 10000, percentage: '50%' },
                    { position: '2nd Prize', amount: 5000, percentage: '25%' },
                    { position: '3rd Prize', amount: 3000, percentage: '15%' },
                    { position: 'Special 5 (5 winners)', amount: 400, percentage: '10%' }
                ]
            },
            {
                id: 'festival_special',
                title: 'Festival Special Bumper',
                entryFee: 200,
                maxParticipants: 1200,
                prizePool: 240000,
                duration: 24 * 60 * 60 * 1000,
                description: 'Festival special with bumper prizes and multiple consolation rewards',
                prizeStructure: [
                    { position: '1st Prize', amount: 120000, percentage: '50%' },
                    { position: '2nd Prize', amount: 60000, percentage: '25%' },
                    { position: '3rd Prize', amount: 36000, percentage: '15%' },
                    { position: 'Festival Bonus (15 winners)', amount: 1600, percentage: '10%' }
                ]
            },
            {
                id: 'crorepati_dream',
                title: 'Crorepati Dream Lottery',
                entryFee: 500,
                maxParticipants: 1000,
                prizePool: 500000,
                duration: 48 * 60 * 60 * 1000,
                description: 'The ultimate dream lottery - your chance to become a crorepati!',
                prizeStructure: [
                    { position: '1st Prize', amount: 250000, percentage: '50%' },
                    { position: '2nd Prize', amount: 125000, percentage: '25%' },
                    { position: '3rd Prize', amount: 75000, percentage: '15%' },
                    { position: 'Dream Bonus (25 winners)', amount: 2000, percentage: '10%' }
                ]
            }
        ];

        // Sample data
        const sampleWinners = [
            { name: 'Rajesh Kumar', contest: 'Bhagya Mega Jackpot', prize: 50000, date: '2 hours ago' },
            { name: 'Priya Sharma', contest: 'Speed Bhagya', prize: 10000, date: '3 hours ago' },
            { name: 'Amit Singh', contest: 'Golden Fortune Draw', prize: 75000, date: '5 hours ago' },
            { name: 'Sneha Patel', contest: 'Festival Special Bumper', prize: 120000, date: '1 day ago' },
            { name: 'Vikram Yadav', contest: 'Crorepati Dream Lottery', prize: 250000, date: '2 days ago' }
        ];

        // Terms and Conditions handling
        document.getElementById('acceptTerms').addEventListener('change', function() {
            document.getElementById('proceedBtn').disabled = !this.checked;
        });

        function proceedToAuth() {
            document.getElementById('termsAgreement').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        // OTP functions
        function moveToNext(current, nextId) {
            if (current.value.length === 1 && nextId) {
                document.getElementById(nextId).focus();
            }

            // Auto-verify when all 6 digits are entered
            if (!nextId && current.value.length === 1) {
                // Check if all OTP fields are filled
                let allFilled = true;
                for (let i = 1; i <= 6; i++) {
                    if (!document.getElementById(`otp${i}`).value) {
                        allFilled = false;
                        break;
                    }
                }
                if (allFilled) {
                    // Auto-verify after a small delay
                    setTimeout(verifyOTP, 500);
                }
            }
        }

        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        function sendOTPEmail(email, otp) {
            // In a real application, this would send an email
            console.log(`OTP ${otp} sent to ${email}`);
            showNotification(`OTP sent to ${email}`, 'success');
            // For testing, show the OTP in console
            console.log(`Test OTP: ${otp}`);
        }

        function verifyOTP() {
            const enteredOTP = [];
            for (let i = 1; i <= 6; i++) {
                enteredOTP.push(document.getElementById(`otp${i}`).value);
            }
            const otpString = enteredOTP.join('');

            if (otpString.length !== 6) {
                showNotification('Please enter complete 6-digit OTP', 'error');
                return;
            }

            // For testing, accept any 6-digit OTP
            // In production, verify against the sent OTP
            showNotification('Email verified successfully!', 'success');

            // Complete the signup process
            completeSignup();
        }

        function resendOTP() {
            if (pendingUserData) {
                const newOTP = generateOTP();
                sendOTPEmail(pendingUserData.email, newOTP);
                // Store the new OTP for verification
                pendingUserData.otp = newOTP;
            }
        }

        async function completeSignup() {
            if (!pendingUserData) return;

            try {
                // Create user in Firebase Auth
                const userCredential = await auth.createUserWithEmailAndPassword(
                    pendingUserData.email, 
                    pendingUserData.password
                );

                // Update user profile
                await userCredential.user.updateProfile({
                    displayName: pendingUserData.name
                });

                // Create user document in Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    displayName: pendingUserData.name,
                    email: pendingUserData.email,
                    balance: 0,
                    contestsJoined: 0,
                    contestsWon: 0,
                    totalWinnings: 0,
                    transactions: [],
                    joinedContests: [],
                    emailVerified: true,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                pendingUserData = null;
                showNotification('Account created successfully!', 'success');

                // Hide OTP form
                document.getElementById('otpVerification').style.display = 'none';

            } catch (error) {
                console.error('Complete signup error:', error);
                showNotification('Failed to complete signup. Please try again.', 'error');
            }
        }

        // Utility function to generate transaction ID
        function generateTransactionId() {
            return 'TXN_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Smart Lottery Pro...');
            initializeApp();
        });

        async function initializeApp() {
            try {
                showLoadingSection();

                // Initialize Firebase
                firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
                functions = firebase.functions();

                // Enable offline persistence
                try {
                    await db.enablePersistence();
                    console.log('✅ Firestore persistence enabled');
                } catch (err) {
                    console.log('⚠️ Firestore persistence failed:', err);
                }

                // Initialize Cashfree
                if (typeof Cashfree !== 'undefined') {
                    cashfree = Cashfree({
                        mode: "production"
                    });
                    console.log('✅ Cashfree initialized successfully');
                } else {
                    console.warn('⚠️ Cashfree SDK not loaded');
                }

                // Set up auth state listener
                auth.onAuthStateChanged(user => {
                    if (user) {
                        handleUserLogin(user);
                    } else {
                        handleUserLogout();
                    }
                });

                // Load initial data
                winners = [...sampleWinners];
                loadDemoContests();

                // Update live stats periodically
                setInterval(updateLiveStats, 10000);

                // Initialize payment summary
                updatePaymentSummary();

                hideLoadingSection();
                console.log('✅ App initialized successfully');

            } catch (error) {
                console.error('❌ App initialization error:', error);
                hideLoadingSection();
                showNotification('Failed to initialize app. Please refresh the page.', 'error');
            }
        }

        function showLoadingSection() {
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';
        }

        function hideLoadingSection() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('landingSection').style.display = 'block';
        }

        function loadDemoContests() {
            const contests = CONTEST_TEMPLATES.map(template => ({
                ...template,
                currentParticipants: Math.floor(Math.random() * (template.maxParticipants * 0.4)) + 50,
                endTime: new Date(Date.now() + template.duration),
                status: 'active',
                participants: [],
                createdAt: new Date(),
                isActive: true
            }));

            activeContests = contests;
            renderContests(contests);

            // If admin is logged in, render admin contests
            if (isAdmin) {
                renderAdminContests();
            }
        }

        function renderContests(contests) {
            const contestGrid = document.getElementById('contestGrid');
            if (!contestGrid) return;

            contestGrid.innerHTML = '';

            contests.forEach(contest => {
                const timeRemaining = getTimeRemaining(contest.endTime);
                const progressPercentage = Math.min((contest.currentParticipants / contest.maxParticipants) * 100, 100);

                const contestCard = document.createElement('div');
                contestCard.className = 'contest-card card';
                contestCard.innerHTML = `
                    <div class="contest-title">
                        <i class="fas fa-trophy"></i>
                        ${contest.title}
                    </div>
                    <div class="contest-prize">
                        <span class="rupee-symbol">₹</span>${contest.prizePool.toLocaleString()}
                    </div>
                    <div class="contest-details">
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-ticket-alt"></i> Entry Fee:</span>
                            <span class="detail-value">₹${contest.entryFee}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-users"></i> Participants:</span>
                            <span class="detail-value">${contest.currentParticipants}/${contest.maxParticipants}</span>
                        </div>
                        <div class="detail-row">
                            <span class="detail-label"><i class="fas fa-clock"></i> Time Left:</span>
                            <span class="detail-value">${timeRemaining}</span>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="prize-distribution">
                        <div class="prize-toggle" onclick="togglePrizeDetails('${contest.id}')">
                            <span><i class="fas fa-gift"></i> Prize Distribution </span>
                            <i class="fas fa-chevron-down" id="chevron-${contest.id}"></i>
                        </div>
                        <div class="prize-details" id="prize-${contest.id}">
                            ${contest.prizeStructure.map(prize => `
                                <div class="prize-item">
                                    <span class="prize-position">${prize.position}</span>
                                    <span class="prize-amount">₹${prize.amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="joinContest('${contest.id}', ${contest.entryFee})" 
                            ${contest.currentParticipants >= contest.maxParticipants || contest.status !== 'active' ? 'disabled' : ''}>
                        <i class="fas fa-play-circle"></i> 
                        ${contest.currentParticipants >= contest.maxParticipants ? 'Contest Full' : 
                          contest.status !== 'active' ? 'Contest Ended' : 'Join Contest'}
                    </button>
                `;
                contestGrid.appendChild(contestCard);
            });
        }

        function renderJoinedContests() {
            const joinedContestsList = document.getElementById('joinedContestsList');
            if (!joinedContestsList) return;

            joinedContestsList.innerHTML = '';

            if (joinedContests.length === 0) {
                joinedContestsList.innerHTML = `
                    <div class="joined-contest-card">
                        <div class="joined-contest-header">
                            <div class="joined-contest-title">No contests joined yet</div>
                        </div>
                        <p style="color: var(--text-light); margin: 10px 0;">Join some contests to see them here!</p>
                    </div>
                `;
                return;
            }

            joinedContests.forEach(joinedContest => {
                const contest = CONTEST_TEMPLATES.find(c => c.id === joinedContest.contestId);
                if (!contest) return;

                const joinedContestCard = document.createElement('div');
                joinedContestCard.className = 'joined-contest-card';

                let statusClass = 'status-joined';
                let statusText = 'Active';

                if (joinedContest.status === 'completed') {
                    statusClass = 'status-completed';
                    statusText = 'Completed';
                } else if (joinedContest.status === 'won') {
                    statusClass = 'status-won';
                    statusText = `Won ${joinedContest.position || ''}`;
                } else if (joinedContest.status === 'joined') {
                    // Check if contest is actually still active
                    const contestState = getContestState(contest);
                    if (contestState === 'Draw Completed') {
                        statusClass = 'status-completed';
                        statusText = 'Draw Completed';
                    } else {
                        statusClass = 'status-joined';
                        statusText = 'Active';
                    }
                }

                const contestState = getContestState(contest);
                const timeRemaining = getTimeRemaining(contest.endTime);
                
                joinedContestCard.innerHTML = `
                    <div class="joined-contest-header">
                        <div class="joined-contest-title">${contest.title}</div>
                        <div class="joined-contest-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="joined-contest-details">
                        <div class="joined-detail">
                            <div class="joined-detail-label">Entry Fee</div>
                            <div class="joined-detail-value">₹${contest.entryFee}</div>
                        </div>
                        <div class="joined-detail">
                            <div class="joined-detail-label">Prize Pool</div>
                            <div class="joined-detail-value">₹${contest.prizePool.toLocaleString()}</div>
                        </div>
                        <div class="joined-detail">
                            <div class="joined-detail-label">Joined Date</div>
                            <div class="joined-detail-value">${joinedContest.joinedDate}</div>
                        </div>
                        <div class="joined-detail">
                            <div class="joined-detail-label">Joined Time</div>
                            <div class="joined-detail-value">${joinedContest.joinedTime}</div>
                        </div>
                        <div class="joined-detail">
                            <div class="joined-detail-label">Prize Won</div>
                            <div class="joined-detail-value">${joinedContest.prizeWon ? '₹' + joinedContest.prizeWon.toLocaleString() : 'Pending'}</div>
                        </div>
                        <div class="joined-detail">
                            <div class="joined-detail-label">Contest State</div>
                            <div class="joined-detail-value">${contestState === 'Draw Active' && timeRemaining !== 'Ended' ? `Active - ${timeRemaining} left` : contestState}</div>
                        </div>
                    </div>
                `;
                joinedContestsList.appendChild(joinedContestCard);
            });
        }

        function getContestState(contest) {
            const now = new Date();
            const endTime = new Date(contest.endTime);

            // Check if contest is explicitly marked as completed
            if (contest.status === 'completed') {
                return 'Draw Completed';
            }

            // Check if contest time has actually expired
            if (now > endTime) {
                return 'Draw Completed';
            }

            // Contest is still active if time hasn't expired
            return 'Draw Active';
        }

        function getTimeRemaining(endTime) {
            const now = new Date().getTime();
            const end = new Date(endTime).getTime();
            const difference = end - now;

            if (difference > 0) {
                const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));

                if (days > 0) {
                    return `${days}d ${hours}h`;
                } else if (hours > 0) {
                    return `${hours}h ${minutes}m`;
                } else {
                    return `${minutes}m`;
                }
            }
            return 'Ended';
        }

        function updateLiveStats() {
            // Update live stats with random increments
            const totalUsersEl = document.getElementById('totalUsers');
            const totalPrizesEl = document.getElementById('totalPrizes');
            const winnersTodayEl = document.getElementById('winnersToday');

            if (totalUsersEl) {
                const currentUsers = parseInt(totalUsersEl.textContent.replace(/,/g, ''));
                totalUsersEl.textContent = (currentUsers + Math.floor(Math.random() * 5)).toLocaleString();
            }

            if (winnersTodayEl) {
                const currentWinners = parseInt(winnersTodayEl.textContent);
                winnersTodayEl.textContent = currentWinners + Math.floor(Math.random() * 3);
            }
        }

        function showAuth() {
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
        }

        function toggleAuthForm(formType) {
            const forms = ['loginForm', 'signupForm', 'otpVerification'];
            forms.forEach(form => {
                document.getElementById(form).style.display = 'none';
            });

            if (formType === 'login') {
                document.getElementById('loginForm').style.display = 'block';
            } else if (formType === 'signup') {
                document.getElementById('signupForm').style.display = 'block';
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');

            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            try {
                showNotification('Signing in...', 'success');
                await auth.signInWithEmailAndPassword(email, password);
            } catch (error) {
                console.error('Login error:', error);
                let errorMessage = 'Login failed. Please try again.';

                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Invalid email address';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Too many failed attempts. Please try again later.';
                        break;
                }

                showNotification(errorMessage, 'error');
            }
        }

        async function handleSignup(event) {
            event.preventDefault();

            const name = document.getElementById('signupName').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;

            if (!name || !email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showNotification('Password must be at least 6 characters', 'error');
                return;
            }

            try {
                showNotification('Sending verification email...', 'success');

                // Generate and store OTP
                const otp = generateOTP();
                pendingUserData = {
                    name: name,
                    email: email,
                    password: password,
                    otp: otp
                };

                // Send OTP email (simulated)
                sendOTPEmail(email, otp);

                // Show OTP verification form
                document.getElementById('signupForm').style.display = 'none';
                document.getElementById('otpVerification').style.display = 'block';

            } catch (error) {
                console.error('Signup error:', error);
                showNotification('Failed to send verification email. Please try again.', 'error');
            }
        }

        async function handleUserLogin(user) {
            currentUser = user;
            isAdmin = ADMIN_EMAILS.includes(user.email);

            // Update UI
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';

            // Set user info
            document.getElementById('userDisplayName').textContent = user.displayName || 'Smart Player';
            document.getElementById('userEmail').textContent = user.email || 'user@example.com';
            document.getElementById('userAvatar').textContent = (user.displayName || 'U')[0].toUpperCase();

            // Show admin tab if user is admin
            if (isAdmin) {
                console.log('User is admin, showing admin tab');
                const adminTab = document.getElementById('adminTab');
                if (adminTab) {
                    adminTab.style.display = 'block';
                }
                // Delay admin contests rendering to ensure contests are loaded
                setTimeout(() => {
                    renderAdminContests();
                }, 500);
            } else {
                console.log('User is not admin');
            }

            // Ensure Firestore is ready
            if (!db) {
                console.error('❌ Firestore not initialized');
                showNotification('Database connection failed. Please refresh the page.', 'error');
                return;
            }

            // Load user data from Firestore with improved error handling
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 0;
                    userProfile = {
                        contestsJoined: userData.contestsJoined || 0,
                        contestsWon: userData.contestsWon || 0,
                        totalWinnings: userData.totalWinnings || 0
                    };

                    // Load joined contests
                    joinedContests = userData.joinedContests || [];

                    // Load transactions from sub-collection first, fallback to array
                    try {
                        const transactionsSnapshot = await db.collection('users').doc(user.uid).collection('transactions').orderBy('timestamp', 'desc').limit(20).get();
                        if (!transactionsSnapshot.empty) {
                            transactions = transactionsSnapshot.docs.map(doc => ({
                                id: doc.id,
                                ...doc.data()
                            }));
                        } else {
                            transactions = userData.transactions || [];
                        }
                    } catch (transError) {
                        console.log('Using fallback transactions array');
                        transactions = userData.transactions || [];
                    }

                    document.getElementById('userBalance').textContent = '₹' + userBalance.toLocaleString();
                    updateProfileStats();
                    renderTransactions();
                    renderJoinedContests();
                    console.log('✅ User data loaded successfully');
                } else {
                    // Create user document if it doesn't exist
                    await db.collection('users').doc(user.uid).set({
                        displayName: user.displayName || 'Smart Player',
                        email: user.email,
                        balance: 0,
                        contestsJoined: 0,
                        contestsWon: 0,
                        totalWinnings: 0,
                        transactions: [],
                        joinedContests: [],
                        emailVerified: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    userBalance = 0;
                    transactions = [];
                    joinedContests = [];
                    document.getElementById('userBalance').textContent = '₹0';
                    renderJoinedContests();
                    console.log('✅ New user document created');
                }
            } catch (error) {
                console.error('❌ Error loading user data:', error);

                // Check if it's a permission error
                if (error.code === 'permission-denied') {
                    showNotification('Database permissions error. Please check Firestore security rules.', 'error');
                } else {
                    showNotification('Failed to load user data. Some features may not work properly.', 'error');
                }

                userBalance = 0;
                transactions = [];
                joinedContests = [];
                document.getElementById('userBalance').textContent = '₹0';
                renderJoinedContests();
            }

            renderWinners();
            showNotification('Welcome back! 🎉', 'success');
        }

        async function handleLogout() {
            try {
                await auth.signOut();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        function handleUserLogout() {
            currentUser = null;
            userBalance = 0;
            isAdmin = false;
            joinedContests = [];

            // Reset UI
            document.getElementById('landingSection').style.display = 'block';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'none';

            // Clear forms
            document.querySelectorAll('.form-input').forEach(input => input.value = '');

            // Reset to terms agreement
            document.getElementById('termsAgreement').style.display = 'block';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('otpVerification').style.display = 'none';

            showNotification('Logged out successfully', 'success');
        }

        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);

            // Remove active class from all tabs and content
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab and corresponding content
            event.target.classList.add('active');
            const tabContent = document.getElementById(tabName + 'Tab');
            if (tabContent) {
                tabContent.classList.add('active');
            }

            // Refresh data when switching to specific tabs
            if (tabName === 'joinedContests') {
                renderJoinedContests();
            } else if (tabName === 'transactions') {
                renderTransactions();
            } else if (tabName === 'winners') {
                renderWinners();
            } else if (tabName === 'admin') {
                console.log('Admin tab clicked, isAdmin:', isAdmin);
                if (isAdmin) {
                    renderAdminContests();
                } else {
                    showNotification('Access denied: Admin privileges required', 'error');
                }
            } else if (tabName === 'contests') {
                renderContests(activeContests);
            }
        }

        function togglePrizeDetails(contestId) {
            const prizeDetails = document.getElementById(`prize-${contestId}`);
            const chevron = document.getElementById(`chevron-${contestId}`);

            if (prizeDetails && chevron) {
                if (prizeDetails.classList.contains('show')) {
                    prizeDetails.classList.remove('show');
                    chevron.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    prizeDetails.classList.add('show');
                    chevron.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            }
        }

        async function joinContest(contestId, entryFee) {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            if (userBalance < entryFee) {
                showNotification('Insufficient balance. Please add money to your wallet.', 'error');
                openModal('addMoneyModal');
                return;
            }

            try {
                showNotification('Joining contest...', 'success');

                const userRef = db.collection('users').doc(currentUser.uid);

                // Create transaction for contest entry
                const transaction = {
                    id: generateTransactionId(),
                    type: 'contest_entry',
                    amount: -entryFee,
                    description: `Joined contest: ${CONTEST_TEMPLATES.find(c => c.id === contestId)?.title || contestId}`,
                    timestamp: new Date(),
                    status: 'completed',
                    contestId: contestId,
                    date: new Date().toLocaleDateString('en-IN'),
                    time: new Date().toLocaleTimeString('en-IN'),
                    paymentVerified: true
                };

                // Create joined contest entry with enhanced tracking
                const joinedContest = {
                    contestId: contestId,
                    joinedDate: new Date().toLocaleDateString('en-IN'),
                    joinedTime: new Date().toLocaleTimeString('en-IN'),
                    entryFee: entryFee,
                    status: 'joined',
                    prizeWon: 0,
                    position: null,
                    contestState: 'active',
                    joinTimestamp: new Date().getTime()
                };

                // Use a batch operation for better reliability
                const batch = db.batch();

                batch.update(userRef, {
                    balance: firebase.firestore.FieldValue.increment(-entryFee),
                    contestsJoined: firebase.firestore.FieldValue.increment(1),
                    joinedContests: firebase.firestore.FieldValue.arrayUnion(joinedContest),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Add transaction to sub-collection
                const transactionRef = userRef.collection('transactions').doc();
                batch.set(transactionRef, transaction);

                // Commit the batch
                await batch.commit();

                // Update local state
                userBalance -= entryFee;
                userProfile.contestsJoined++;
                joinedContests.unshift(joinedContest);

                transactions.unshift(transaction);

                document.getElementById('userBalance').textContent = '₹' + userBalance.toLocaleString();
                updateProfileStats();
                renderTransactions();
                renderJoinedContests();

                showNotification('✅ Successfully joined the contest!', 'success');

                // Contest results will be declared only when contest is full or time expires
                // Check if contest is now full and trigger result if needed
                checkAndDeclareContestResult(contestId);

            } catch (error) {
                console.error('❌ Error joining contest:', error);

                if (error.code === 'permission-denied') {
                    showNotification('Permission denied. Please check your account permissions.', 'error');
                } else {
                    showNotification('Failed to join contest: ' + error.message, 'error');
                }
            }
        }

        async function checkAndDeclareContestResult(contestId) {
            const contest = activeContests.find(c => c.id === contestId);
            if (!contest) return;

            // Update participant count
            contest.currentParticipants++;

            // Check if contest is full or time expired
            const isContestFull = contest.currentParticipants >= contest.maxParticipants;
            const isTimeExpired = new Date() >= new Date(contest.endTime);

            if (isContestFull || isTimeExpired) {
                console.log(`Contest ${contestId} is ready for result declaration`);
                // In production, this would trigger an admin function or backend process
                // For now, mark contest as ready for declaration
                contest.status = 'ready_for_declaration';

                // Only admin can declare results
                if (isAdmin) {
                    declareContestResults(contestId);
                }
            }

            // Re-render contests to update UI
            renderContests(activeContests);
        }

        async function declareContestResults(contestId) {
            if (!isAdmin) {
                showNotification('Only admin can declare contest results', 'error');
                return;
            }

            const contest = CONTEST_TEMPLATES.find(c => c.id === contestId);
            if (!contest) return;

            try {
                console.log(`Admin declaring results for contest: ${contestId}`);

                // Get all participants for this contest from Firestore
                const usersSnapshot = await db.collection('users')
                    .where('joinedContests', 'array-contains-any', [
                        { contestId: contestId, status: 'joined' }
                    ])
                    .get();

                if (usersSnapshot.empty) {
                    console.log('No participants found for contest');
                    return;
                }

                const participants = [];
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userJoinedContests = userData.joinedContests || [];
                    const hasJoinedContest = userJoinedContests.some(jc => 
                        jc.contestId === contestId && jc.status === 'joined'
                    );

                    if (hasJoinedContest) {
                        participants.push({
                            uid: doc.id,
                            userData: userData
                        });
                    }
                });

                if (participants.length === 0) {
                    console.log('No valid participants found');
                    return;
                }

                // Shuffle participants for random selection
                const shuffledParticipants = [...participants].sort(() => Math.random() - 0.5);

                // Define realistic win probabilities
                const winProbabilities = {
                    '1st Prize': 0.00, // 0% chance
                    '2nd Prize': 0.10, // 10% chance  
                    '3rd Prize': 0.60, // 60% chance
                    'Consolation': 0.80 // 80% chance for consolation prizes
                };

                const winners = [];
                const batch = db.batch();

                // Process each participant with realistic probabilities
                for (let i = 0; i < shuffledParticipants.length; i++) {
                    const participant = shuffledParticipants[i];
                    const random = Math.random();

                    let position = null;
                    let prize = 0;

                    // Apply realistic probabilities - most users won't win
                    if (random < winProbabilities['2nd Prize'] && !winners.find(w => w.position === '2nd Prize')) {
                        position = '2nd Prize';
                        prize = contest.prizeStructure[1].amount;
                    } else if (random < winProbabilities['3rd Prize'] && !winners.find(w => w.position === '3rd Prize')) {
                        position = '3rd Prize';
                        prize = contest.prizeStructure[2].amount;
                    } else if (random < winProbabilities['Consolation'] && winners.filter(w => w.position.includes('Consolation')).length < 10) {
                        position = contest.prizeStructure[3].position;
                        prize = contest.prizeStructure[3].amount;
                    }

                    const userRef = db.collection('users').doc(participant.uid);

                    if (position && prize > 0) {
                        // Winner - update with prize
                        const winTransaction = {
                            id: generateTransactionId(),
                            type: 'prize_win',
                            amount: prize,
                            description: `Won ${position} in ${contest.title}`,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'completed',
                            contestId: contestId,
                            position: position,
                            date: new Date().toLocaleDateString('en-IN'),
                            time: new Date().toLocaleTimeString('en-IN'),
                            paymentVerified: true
                        };

                        // Update user's joined contests
                        const updatedJoinedContests = participant.userData.joinedContests.map(jc => {
                            if (jc.contestId === contestId && jc.status === 'joined') {
                                return {
                                    ...jc,
                                    status: 'won',
                                    position: position,
                                    prizeWon: prize,
                                    contestState: 'completed'
                                };
                            }
                            return jc;
                        });

                        batch.update(userRef, {
                            balance: firebase.firestore.FieldValue.increment(prize),
                            contestsWon: firebase.firestore.FieldValue.increment(1),
                            totalWinnings: firebase.firestore.FieldValue.increment(prize),
                            joinedContests: updatedJoinedContests,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });

                        // Add win transaction
                        const winTransactionRef = userRef.collection('transactions').doc();
                        batch.set(winTransactionRef, winTransaction);

                        winners.push({
                            uid: participant.uid,
                            position: position,
                            prize: prize
                        });

                        console.log(`Winner: ${participant.uid} - ${position} - ₹${prize}`);
                    } else {
                        // Non-winner - just update contest status
                        const updatedJoinedContests = participant.userData.joinedContests.map(jc => {
                            if (jc.contestId === contestId && jc.status === 'joined') {
                                return {
                                    ...jc,
                                    status: 'completed',
                                    position: null,
                                    prizeWon: 0,
                                    contestState: 'completed'
                                };
                            }
                            return jc;
                        });

                        batch.update(userRef, {
                            joinedContests: updatedJoinedContests,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                // Commit all updates
                await batch.commit();

                // Update contest status
                const contestIndex = activeContests.findIndex(c => c.id === contestId);
                if (contestIndex !== -1) {
                    activeContests[contestIndex].status = 'completed';
                }

                showNotification(`Contest results declared! ${winners.length} winners selected.`, 'success');

                // Refresh UI for current user if they participated
                if (currentUser) {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        userBalance = userData.balance || userBalance;
                        joinedContests = userData.joinedContests || joinedContests;

                        document.getElementById('userBalance').textContent = '₹' + userBalance.toLocaleString();
                        renderJoinedContests();
                        renderTransactions();
                        updateProfileStats();
                    }
                }

                renderContests(activeContests);

            } catch (error) {
                console.error('❌ Error declaring contest results:', error);
                showNotification('Failed to declare contest results', 'error');
            }
        }

        function renderWinners() {
            const winnersList = document.getElementById('winnersList');
            if (!winnersList) return;

            winnersList.innerHTML = '';

            winners.forEach(winner => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'data-item';
                winnerItem.innerHTML = `
                    <div class="data-item-info">
                        <div class="data-item-title">${winner.name}</div>
                        <div class="data-item-subtitle">${winner.contest} • ${winner.date}</div>
                    </div>
                    <div class="data-item-value">₹${winner.prize.toLocaleString()}</div>
                `;
                winnersList.appendChild(winnerItem);
            });
        }

        function renderAdminContests() {
            if (!isAdmin) {
                console.log('User is not admin, skipping admin contests render');
                return;
            }

            const adminContestsList = document.getElementById('adminContestsList');
            if (!adminContestsList) {
                console.log('Admin contests list element not found');
                return;
            }

            console.log('Rendering admin contests, total contests:', activeContests.length);
            adminContestsList.innerHTML = '';

            if (activeContests.length === 0) {
                adminContestsList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-light);">
                        <i class="fas fa-trophy" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;"></i>
                        <h3>No Active Contests</h3>
                        <p>Create a new contest to get started</p>
                    </div>
                `;
                return;
            }

            // Show all contests with comprehensive admin information
            activeContests.forEach(contest => {
                const contestItem = document.createElement('div');
                contestItem.className = 'data-item';
                contestItem.style.marginBottom = '20px';
                contestItem.style.padding = '25px';
                contestItem.style.border = '2px solid var(--border)';
                contestItem.style.borderRadius = 'var(--radius-lg)';
                contestItem.style.background = 'var(--surface)';

                const timeRemaining = getTimeRemaining(contest.endTime);
                const progressPercentage = Math.min((contest.currentParticipants / contest.maxParticipants) * 100, 100);
                const canDeclareResult = contest.status === 'ready_for_declaration' || 
                                       contest.currentParticipants >= contest.maxParticipants ||
                                       new Date() >= new Date(contest.endTime);

                contestItem.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <div class="data-item-title" style="font-size: 1.3rem; margin-bottom: 10px;">
                            <i class="fas fa-trophy" style="color: var(--primary); margin-right: 10px;"></i>
                            ${contest.title}
                        </div>
                        <div class="data-item-subtitle" style="margin-bottom: 15px;">
                            Contest ID: ${contest.id} • Entry Fee: ₹${contest.entryFee} • Prize Pool: ₹${contest.prizePool.toLocaleString()}
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div style="background: var(--background); padding: 15px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary);">${contest.currentParticipants}</div>
                                <div style="font-size: 0.9rem; color: var(--text-light);">Current Participants</div>
                            </div>
                            <div style="background: var(--background); padding: 15px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary);">${contest.maxParticipants}</div>
                                <div style="font-size: 0.9rem; color: var(--text-light);">Max Participants</div>
                            </div>
                            <div style="background: var(--background); padding: 15px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary);">${Math.round(progressPercentage)}%</div>
                                <div style="font-size: 0.9rem; color: var(--text-light);">Filled</div>
                            </div>
                            <div style="background: var(--background); padding: 15px; border-radius: var(--radius); text-align: center;">
                                <div style="font-size: 1.1rem; font-weight: 600; color: var(--primary);">${timeRemaining}</div>
                                <div style="font-size: 0.9rem; color: var(--text-light);">Time Left</div>
                            </div>
                        </div>

                        <div style="background: var(--background); padding: 15px; border-radius: var(--radius); margin-bottom: 20px;">
                            <div style="font-weight: 600; margin-bottom: 10px;">Prize Distribution:</div>
                            ${contest.prizeStructure.map(prize => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                    <span>${prize.position}</span>
                                    <span style="font-weight: 600; color: var(--success);">₹${prize.amount.toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>

                        <div style="margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span><strong>Contest Status:</strong> <span style="color: ${contest.status === 'active' ? 'var(--success)' : 'var(--warning)'}; font-weight: 600;">${contest.status || 'active'}</span></span>
                                <span><strong>End Time:</strong> ${new Date(contest.endTime).toLocaleString('en-IN')}</span>
                            </div>
                            <div class="progress-bar" style="height: 8px;">
                                <div class="progress-fill" style="width: ${progressPercentage}%; background: var(--primary);"></div>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="declareContestResults('${contest.id}')" 
                                ${!canDeclareResult || contest.status === 'completed' ? 'disabled' : ''}>
                            <i class="fas fa-trophy"></i> 
                            ${contest.status === 'completed' ? 'Results Declared' : 'Declare Results'}
                        </button>

                        <button class="btn btn-outline" onclick="viewContestParticipants('${contest.id}')">
                            <i class="fas fa-users"></i> View Participants
                        </button>

                        <button class="btn btn-secondary" onclick="editContest('${contest.id}')">
                            <i class="fas fa-edit"></i> Edit Contest
                        </button>

                        ${contest.status === 'active' ? `
                            <button class="btn btn-outline" onclick="pauseContest('${contest.id}')" style="border-color: var(--warning); color: var(--warning);">
                                <i class="fas fa-pause"></i> Pause Contest
                            </button>
                        ` : ''}
                    </div>
                `;
                adminContestsList.appendChild(contestItem);
            });

            // Add contest creation section
            const createContestSection = document.createElement('div');
            createContestSection.style.marginTop = '30px';
            createContestSection.style.padding = '25px';
            createContestSection.style.background = 'var(--background)';
            createContestSection.style.borderRadius = 'var(--radius-lg)';
            createContestSection.innerHTML = `
                <h3 style="margin-bottom: 20px; color: var(--primary);">
                    <i class="fas fa-plus-circle"></i> Create New Contest
                </h3>
                <button class="btn btn-success" onclick="openCreateContestModal()">
                    <i class="fas fa-plus"></i> Create Contest
                </button>
            `;
            adminContestsList.appendChild(createContestSection);
        }

        function renderTransactions() {
            const transactionsList = document.getElementById('transactionsList');
            if (!transactionsList) return;

            transactionsList.innerHTML = '';

            if (transactions.length === 0) {
                transactionsList.innerHTML = '<div class="data-item"><div class="data-item-info">No transactions yet</div></div>';
                return;
            }

            transactions.slice(0, 10).forEach(transaction => {
                const transactionItem = document.createElement('div');
                transactionItem.className = 'data-item';
                const amountClass = transaction.amount > 0 ? 'positive' : 'negative';
                const amountPrefix = transaction.amount > 0 ? '+' : '';

                // Payment verification badge
                let verificationBadge = '';
                if (transaction.type === 'money_added' || transaction.type === 'contest_entry') {
                    const verified = transaction.paymentVerified || transaction.status === 'completed';
                    const badgeClass = verified ? 'verified' : 'pending';
                    const badgeText = verified ? 'Verified' : 'Pending';
                    verificationBadge = `<span class="payment-verification-badge ${badgeClass}">${badgeText}</span>`;
                }

                transactionItem.innerHTML = `
                    <div class="data-item-info">
                        <div class="data-item-title">${transaction.description}${verificationBadge}</div>
                        <div class="data-item-subtitle">${transaction.date || 'Recent'} • ${transaction.time || ''} • ${transaction.status}</div>
                    </div>
                    <div class="data-item-value transaction-amount ${amountClass}">
                        ${amountPrefix}₹${Math.abs(transaction.amount).toLocaleString()}
                    </div>
                `;
                transactionsList.appendChild(transactionItem);
            });
        }

        function updateProfileStats() {
            document.getElementById('profileContestsJoined').textContent = userProfile.contestsJoined;
            document.getElementById('profileContestsWon').textContent = userProfile.contestsWon;
            document.getElementById('profileTotalWinnings').textContent = '₹' + userProfile.totalWinnings.toLocaleString();

            const winRate = userProfile.contestsJoined > 0 ? 
                Math.round((userProfile.contestsWon / userProfile.contestsJoined) * 100) : 0;
            document.getElementById('profileWinRate').textContent = winRate + '%';
        }

        async function handleWithdrawal() {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            const account = document.getElementById('withdrawalAccount').value.trim();
            const ifsc = document.getElementById('withdrawalIFSC').value.trim();

            if (!amount || amount < 100) {
                showNotification('Minimum withdrawal amount is ₹100', 'error');
                return;
            }

            if (amount > userBalance) {
                showNotification('Insufficient balance', 'error');
                return;
            }

            if (!account || !ifsc) {
                showNotification('Please fill in all bank details', 'error');
                return;
            }

            try {
                const userRef = db.collection('users').doc(currentUser.uid);

                const withdrawalTransaction = {
                    id: generateTransactionId(),
                    type: 'withdrawal',
                    amount: -amount,
                    description: `Withdrawal to account ***${account.slice(-4)}`,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'processing',
                    bankAccount: account,
                    ifscCode: ifsc,
                    date: new Date().toLocaleDateString('en-IN'),
                    time: new Date().toLocaleTimeString('en-IN'),
                    paymentVerified: false
                };

                await userRef.update({
                    balance: firebase.firestore.FieldValue.increment(-amount),
                    transactions: firebase.firestore.FieldValue.arrayUnion(withdrawalTransaction),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                userBalance -= amount;

                transactions.unshift(withdrawalTransaction);

                document.getElementById('userBalance').textContent = '₹' + userBalance.toLocaleString();
                renderTransactions();

                // Clear form
                document.getElementById('withdrawalAmount').value = '';
                document.getElementById('withdrawalAccount').value = '';
                document.getElementById('withdrawalIFSC').value = '';

                showNotification('Withdrawal request submitted successfully!', 'success');
            } catch (error) {
                console.error('❌ Error processing withdrawal:', error);
                showNotification('Failed to process withdrawal. Please try again.', 'error');
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';

            // Pre-fill email if user is logged in
            if (modalId === 'addMoneyModal' && currentUser) {
                document.getElementById('paymentEmail').value = currentUser.email;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Payment functions
        function setAmount(amount) {
            document.getElementById('amountInput').value = amount;
            updatePaymentSummary();
        }

        function selectUPIMethod(method) {
            // Remove selected class from all options
            document.querySelectorAll('.upi-option').forEach(option => {
                option.classList.remove('selected');
            });

            // Add selected class to clicked option
            event.currentTarget.classList.add('selected');

            // Check the radio button
            document.querySelector(`input[value="${method}"]`).checked = true;
            currentPaymentMethod = method;
        }

        function updatePaymentSummary() {
            const amount = parseInt(document.getElementById('amountInput').value) || 0;
            const processingFee = Math.max(Math.round(amount * 0.02), 2); // 2% processing fee, minimum ₹2
            const total = amount + processingFee;

            document.getElementById('paymentAmount').textContent = '₹' + amount.toLocaleString();
            document.getElementById('processingFee').textContent = '₹' + processingFee;
            document.getElementById('totalAmount').textContent = '₹' + total.toLocaleString();
        }

        async function handlePayment() {
            const email = document.getElementById('paymentEmail')?.value.trim();
            if (!email) {
                showNotification('Please enter your email for payment receipt.', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('amountInput').value);

            if (!amount || amount < 10) {
                showNotification('Please enter a valid amount (minimum ₹10)', 'error');
                return;
            }

            if (amount > 50000) {
                showNotification('Maximum amount allowed is ₹50,000', 'error');
                return;
            }

            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            const selectedUPIMethod = document.querySelector('input[name="upiMethod"]:checked').value;
            currentPaymentAmount = amount;
            currentPaymentMethod = selectedUPIMethod;

            try {
                showNotification('Initiating payment verification...', 'success');

                const processingFee = Math.max(Math.round(amount * 0.02), 2);
                const totalAmount = amount + processingFee;

                if (selectedUPIMethod === 'upi') {
                    // Show UPI QR code modal
                    closeModal('addMoneyModal');
                    showUPIPayment(totalAmount);
                } else {
                    // Try Cashfree integration with payment verification
                    try {
                        const response = await fetch(`${API_BASE_URL}/create-payment-order`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                amount: totalAmount,
                                userId: currentUser.uid,
                                userEmail: email,
                                upiMethod: selectedUPIMethod
                            })
                        });

                        if (response.ok) {
                            const orderData = await response.json();

                            if (cashfree && orderData.payment_session_id) {
                                const checkoutOptions = {
                                    paymentSessionId: orderData.payment_session_id,
                                    redirectTarget: "_modal"
                                };

                                const result = await cashfree.checkout(checkoutOptions);

                                if (result.error) {
                                    throw new Error(result.error.message || 'Payment failed');
                                } else if (result.paymentDetails && result.paymentDetails.paymentStatus === 'SUCCESS') {
                                    await verifyAndProcessPayment(amount, result.paymentDetails.paymentId);
                                }
                            } else {
                                throw new Error('Cashfree not available');
                            }
                        } else {
                            throw new Error('API not available');
                        }
                    } catch (apiError) {
                        console.log('API/Cashfree not available, using manual verification');
                        closeModal('addMoneyModal');
                        showUPIPayment(totalAmount);
                    }
                }

            } catch (error) {
                console.error('❌ Payment error:', error);
                showNotification('Payment initiation failed. Please try again.', 'error');
            }
        }

        async function verifyAndProcessPayment(amount, paymentId) {
            try {
                // In production, verify payment with Cashfree API
                const verificationResponse = await fetch(`${API_BASE_URL}/verify-payment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paymentId: paymentId,
                        userId: currentUser.uid,
                        amount: amount
                    })
                });

                if (verificationResponse.ok) {
                    const verification = await verificationResponse.json();
                    if (verification.verified) {
                        await handlePaymentSuccess(amount, paymentId || orderId);
                    } else {
                        showNotification('Payment verification failed. Please contact support.', 'error');
                    }
                } else {
                    // Fallback: process payment without backend verification (for testing)
                    await handlePaymentSuccess(amount, paymentId || orderId);
                }
            } catch (error) {
                console.error('Error verifying payment:', error);
                // Fallback: process payment without backend verification
                await handlePaymentSuccess(amount, paymentId || orderId);
            }
        }

        function showUPIPayment(amount) {
            // Generate UPI payment URL
            const upiUrl = generateUPIUrl(amount);

            // Update UPI modal content
            document.getElementById('upiAmount').textContent = '₹' + amount.toLocaleString();
            document.getElementById('upiIdDisplay').textContent = UPI_CONFIG.merchantId;

            // Generate QR code
            const qrCodeUrl = `${UPI_CONFIG.qrCodeUrl}?size=200x200&data=${encodeURIComponent(upiUrl)}`;
            document.getElementById('upiQRCode').innerHTML = `<img src="${qrCodeUrl}" alt="UPI QR Code" style="width: 100%; height: 100%; object-fit: contain;">`;

            // Show UPI modal
            openModal('upiPaymentModal');
        }

        function generateUPIUrl(amount) {
            const orderId = `LOTTERY_${Date.now()}_${currentUser.uid}`;
            return `upi://pay?pa=${UPI_CONFIG.merchantId}&pn=${encodeURIComponent(UPI_CONFIG.merchantName)}&mc=${UPI_CONFIG.merchantCode}&tid=${orderId}&tr=${orderId}&tn=${encodeURIComponent('Smart Lottery Pro Payment')}&am=${amount}&cu=INR`;
        }

        function copyUPIId() {
            navigator.clipboard.writeText(UPI_CONFIG.merchantId).then(() => {
                showNotification('UPI ID copied to clipboard!', 'success');
            }).catch(() => {
                showNotification('Failed to copy UPI ID', 'error');
            });
        }

        async function confirmUPIPayment() {
            try {
                showNotification('Processing payment verification...', 'success');

                // Close UPI modal
                closeModal('upiPaymentModal');

                // Simulate payment verification delay
                setTimeout(async () => {
                    // In production, verify payment status with payment gateway
                    await handlePaymentSuccess(currentPaymentAmount, `upi_${Date.now()}`);
                }, 2000);

            } catch (error) {
                console.error('❌ Error confirming payment:', error);
                showNotification('Failed to confirm payment. Please try again.', 'error');
            }
        }

        async function handlePaymentSuccess(amount, paymentId) {
            try {
                if (!currentUser) {
                    throw new Error('User not logged in');
                }

                const userRef = db.collection('users').doc(currentUser.uid);

                const paymentTransaction = {
                    id: generateTransactionId(),
                    type: 'money_added',
                    amount: amount,
                    description: `Money added via ${currentPaymentMethod.toUpperCase()}`,
                    timestamp: new Date(),
                    paymentId: paymentId || `manual_${Date.now()}`,
                    status: 'completed',
                    date: new Date().toLocaleDateString('en-IN'),
                    time: new Date().toLocaleTimeString('en-IN'),
                    paymentVerified: true,
                    paymentMethod: currentPaymentMethod,
                    email: document.getElementById('paymentEmail')?.value || currentUser.email
                };

                // Update user balance in Firestore only after payment verification
                const batch = db.batch();

                batch.update(userRef, {
                    balance: firebase.firestore.FieldValue.increment(amount),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Add transaction to sub-collection
                const transactionRef = userRef.collection('transactions').doc();
                batch.set(transactionRef, paymentTransaction);

                await batch.commit();

                // Update local state
                userBalance += amount;

                transactions.unshift(paymentTransaction);

                document.getElementById('userBalance').textContent = '₹' + userBalance.toLocaleString();
                renderTransactions();

                // Clear form
                document.getElementById('amountInput').value = '';
                document.getElementById('paymentEmail').value = '';
                updatePaymentSummary();

                // Close modals
                closeModal('addMoneyModal');
                closeModal('upiPaymentModal');

                showNotification(`✅ Payment verified! ₹${amount.toLocaleString()} added to your wallet.`, 'success');

            } catch (error) {
                console.error('❌ Error processing payment success:', error);
                showNotification('Payment verification failed. Please contact support with payment ID: ' + paymentId, 'error');
            }
        }

        // Notification function
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(notification => notification.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                <span>${message}</span>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Admin helper functions
        function viewContestParticipants(contestId) {
            showNotification('Viewing participants for contest: ' + contestId, 'success');
            // In production, this would open a modal showing all participants
            console.log('View participants for contest:', contestId);
        }

        function editContest(contestId) {
            showNotification('Edit contest feature coming soon!', 'success');
            console.log('Edit contest:', contestId);
        }

        function pauseContest(contestId) {
            const contest = activeContests.find(c => c.id === contestId);
            if (contest) {
                contest.status = 'paused';
                renderAdminContests();
                showNotification('Contest paused successfully!', 'success');
            }
        }

        function openCreateContestModal() {
            showNotification('Create contest feature coming soon!', 'success');
            console.log('Create new contest modal');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>