<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>Smart Lottery - India's Most Trusted Lottery Platform</title>
<meta content="Join India's most trusted lottery platform with secure payments, fair play, and instant prize distribution." name="description"/>
<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;family=Poppins:wght@400;500;600;700;800&amp;display=swap" rel="stylesheet"/>
<!-- Firebase SDK v9 -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-functions-compat.js"></script>
<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<!-- Icons -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
<style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
            --accent: #8b5cf6;
            --background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --text-lighter: #94a3b8;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --radius: 12px;
            --radius-lg: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1976d2 0%, #1565c0 25%, #0d47a1 50%, #0277bd 75%, #01579b 100%);
            background-size: 300% 300%;
            animation: gradientShift 25s ease infinite;
            color: var(--text);
            line-height: 1.7;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at top, rgba(255, 255, 255, 0.2) 0%, transparent 70%),
                        radial-gradient(ellipse at bottom, rgba(255, 255, 255, 0.15) 0%, transparent 70%),
                        radial-gradient(circle at 25% 60%, rgba(255, 107, 107, 0.15) 0%, transparent 60%),
                        radial-gradient(circle at 75% 25%, rgba(78, 205, 196, 0.15) 0%, transparent 60%),
                        radial-gradient(circle at 60% 80%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            20% { background-position: 80% 20%; }
            40% { background-position: 100% 60%; }
            60% { background-position: 20% 100%; }
            80% { background-position: 0% 80%; }
            100% { background-position: 0% 50%; }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* Enhanced Auth Section with White Background */
        #authSection {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
            min-height: 100vh;
            position: relative;
        }

        #authSection::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="dots" patternUnits="userSpaceOnUse" width="20" height="20"><circle cx="10" cy="10" r="2" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23dots)"/></svg>');
            animation: float 30s ease-in-out infinite;
        }

        /* Header Styles */
        .header {
            text-align: center;
            padding: 50px 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.25) 100%);
            backdrop-filter: blur(30px);
            border: 3px solid rgba(255, 255, 255, 0.4);
            color: white;
            margin-bottom: 32px;
            border-radius: var(--radius-lg);
            position: relative;
            overflow: hidden;
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.4), 0 0 0 1px rgba(255, 255, 255, 0.2);
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="10" height="10"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.2)"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>'),
                        linear-gradient(45deg, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                        linear-gradient(-45deg, rgba(78, 205, 196, 0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateX(0px); }
            50% { transform: translateX(20px); }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .logo {
            font-family: 'Inter', 'SF Pro Display', sans-serif;
            font-size: 2.5rem;
            font-weight: 900;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 4px 4px 8px rgba(0,0,0,0.3);
            letter-spacing: -0.02em;
        }

        .tagline {
            font-family: 'Inter', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            opacity: 1;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #f5576c, #4facfe, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            letter-spacing: -0.01em;
        }

        .trust-badges {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-top: 16px;
        }

        .trust-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
            backdrop-filter: blur(10px);
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* Motivational Quotes Section for Landing Page */
        .motivational-quotes {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.35) 0%, rgba(255, 255, 255, 0.25) 100%);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 35px 20px;
            margin: 32px 0;
            width: 100%;
            max-width: 100%;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15), inset 0 1px 0 rgba(255,255,255,0.3);
            box-sizing: border-box;
        }

        .quote-carousel {
            position: relative;
            overflow: hidden;
            height: 140px;
            width: 100%;
            max-width: 100%;
        }

        .quote-item {
            position: absolute;
            width: 100%;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.8s ease;
            text-align: center;
        }

        .quote-item.active {
            opacity: 1;
            transform: translateY(0);
        }

        .quote-text {
            font-family: 'Georgia', serif;
            font-size: 1.4rem;
            font-style: italic;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
            width: 100%;
            max-width: 100%;
            padding: 0 10px;
            line-height: 1.5;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .quote-author {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            background: linear-gradient(135deg, #f5576c, #4facfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }

        /* Success Stories Section */
        .success-stories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin: 32px 0;
        }

        .success-story {
            background: rgba(255, 255, 255, 0.95);
            padding: 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            text-align: center;
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }

        .success-story:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        }

        .success-story-icon {
            font-size: 3.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .success-story-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 10px;
        }

        .success-story-desc {
            color: #000000;
            font-size: 1rem;
            line-height: 1.5;
        }

        /* Certification Badges */
        .certification-badges {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
            margin: 24px 0;
            padding: 20px;
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
        }

        .cert-badge {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .cert-badge:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .cert-badge i {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .cert-badge-title {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .cert-badge-desc {
            font-size: 0.7rem;
            opacity: 0.9;
            line-height: 1.2;
        }

        /* Live Stats */
        .live-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }

        .live-stat {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.9) 100%);
            backdrop-filter: blur(20px);
            padding: 28px 24px;
            border-radius: var(--radius-lg);
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.2);
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .live-stat:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.2), 0 0 0 1px rgba(255,255,255,0.3);
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(255, 255, 255, 0.95) 100%);
        }

        .live-stat-icon {
            font-size: 2rem;
            margin-bottom: 12px;
            color: var(--primary);
        }

        .live-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .live-stat-label {
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        /* User Section */
        .user-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            margin-bottom: 28px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.2rem;
        }

        .user-details h3 {
            margin: 0;
            color: var(--text);
            font-size: 1.1rem;
        }

        .user-balance {
            color: var(--success);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .user-email {
            color: var(--text-light);
            font-size: 0.85rem;
        }

        .user-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Tabs */
        .tab-navigation {
            display: flex;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            padding: 8px;
            margin-bottom: 28px;
            box-shadow: var(--shadow-lg);
            overflow-x: auto;
            gap: 4px;
        }

        .tab-btn {
            flex: 1;
            padding: 14px 16px;
            border: none;
            background: transparent;
            color: var(--text-light);
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            min-width: 140px;
            font-weight: 600;
            font-size: 0.85rem;
            text-align: center;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
            font-weight: 700;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(25, 118, 210, 0.1);
            color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 48px;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 100%);
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #616161;
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #388e3c;
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        .btn-full {
            width: 100%;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        /* Contest Cards */
        .contest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 28px;
            margin-bottom: 40px;
        }

        .contest-card {
            padding: 28px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }

        .contest-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-xl);
            background: rgba(255, 255, 255, 0.98);
        }

        .contest-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
        }

        .contest-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #000000;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .contest-title i {
            color: var(--primary);
        }

        .contest-prize {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .rupee-symbol {
            font-size: 1.8rem;
            opacity: 0.8;
        }

        .contest-details {
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95rem;
        }

        .detail-label {
            color: var(--text-light);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-value {
            font-weight: 600;
            color: var(--text);
        }

        .progress-bar {
            background: var(--border);
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--primary));
            transition: width 0.3s ease;
        }

        /* Prize Distribution */
        .prize-distribution {
            margin-bottom: 20px;
        }

        .prize-toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }

        .prize-details {
            margin-top: 16px;
            display: none;
            background: rgba(25, 118, 210, 0.05);
            padding: 16px;
            border-radius: var(--radius);
        }

        .prize-details.show {
            display: block;
        }

        .prize-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(25, 118, 210, 0.1);
        }

        .prize-item:last-child {
            border-bottom: none;
        }

        .prize-position {
            font-weight: 600;
            color: var(--primary);
        }

        .prize-amount {
            font-weight: 700;
            color: var(--success);
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text);
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: var(--transition);
            background: var(--surface);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
        }

        .password-input-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 4px;
        }

        .amount-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .amount-btn {
            padding: 14px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: var(--radius);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }

        .amount-btn:hover {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            transform: translateY(-1px);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            z-index: 1000;
            padding: 20px;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 520px;
            margin: 50px auto;
            border-radius: var(--radius-lg);
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        .modal-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--border);
        }

        .modal-header h2 {
            margin: 0;
            color: var(--text);
            font-size: 1.3rem;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 1.4rem;
            color: var(--text-light);
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .modal-close:hover {
            background: var(--border);
        }

        .modal-body {
            padding: 24px;
        }

        /* Terms and Conditions Styles */
        .terms-container {
            max-height: 350px;
            overflow-y: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            margin: 16px 0;
            background: rgba(25, 118, 210, 0.02);
        }

        .terms-container h3 {
            color: var(--primary);
            margin-top: 16px;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .terms-container h3:first-child {
            margin-top: 0;
        }

        .terms-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin: 16px 0;
        }

        .terms-checkbox input[type="checkbox"] {
            margin-top: 4px;
            width: 16px;
            height: 16px;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 32px 16px;
            position: relative;
            z-index: 2;
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-header h2 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 1.5rem;
        }

        .auth-header p {
            color: var(--text-light);
        }

        .auth-motivational-quote {
            color: var(--text);
            font-style: italic;
            font-weight: 600;
            margin: 16px 0;
            text-align: center;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 20px;
        }

        .auth-toggle a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: var(--radius);
            color: white;
            font-weight: 500;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 350px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: var(--success);
        }

        .notification.error {
            background: var(--error);
        }

        .notification.info {
            background: var(--primary);
        }

        .notification.warning {
            background: var(--warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Data Lists */
        .data-list {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .data-item {
            padding: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            margin-bottom: 12px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.4);
        }

        .data-item:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
            background: rgba(255, 255, 255, 0.95);
        }

        .data-item:last-child {
            border-bottom: none;
        }

        .data-item-info {
            flex: 1;
        }

        .data-item-title {
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 1.1rem;
            font-family: 'Georgia', serif;
            letter-spacing: 0.5px;
        }

        .data-item-subtitle {
            color: #4a5568;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.4;
            font-family: 'Poppins', sans-serif;
        }

        .data-item-value {
            font-weight: 800;
            color: var(--primary);
            font-size: 1.1rem;
            font-family: 'Georgia', serif;
            letter-spacing: 0.5px;
        }

        .transaction-amount.positive {
            color: var(--success);
        }

        .transaction-amount.negative {
            color: var(--error);
        }

        .transaction-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: rgba(255, 152, 0, 0.1);
            color: var(--warning);
        }

        .status-approved, .status-completed {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .status-rejected {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error);
        }

        /* Profile Section */
        .profile-section {
            background: var(--surface);
            padding: 32px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: 32px;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 32px;
        }

        .profile-stat {
            text-align: center;
            padding: 20px;
            background: rgba(25, 118, 210, 0.05);
            border-radius: var(--radius);
        }

        .profile-stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 6px;
        }

        .profile-stat-label {
            color: var(--text-light);
            font-weight: 500;
        }

        /* Payment Summary */
        .payment-summary {
            background: rgba(25, 118, 210, 0.05);
            padding: 20px;
            border-radius: var(--radius);
            margin-bottom: 20px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .summary-row:last-child {
            border-top: 1px solid var(--border);
            padding-top: 12px;
            font-weight: 700;
            font-size: 1.1rem;
        }

        /* Referral Section Styles */
        .referral-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
            padding: 32px;
            border-radius: var(--radius-lg);
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
        }

        .referral-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="stars" patternUnits="userSpaceOnUse" width="10" height="10"><circle cx="5" cy="5" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23stars)"/></svg>');
            animation: float 20s ease-in-out infinite;
        }

        .referral-content {
            position: relative;
            z-index: 1;
        }

        .referral-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .referral-stat {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius);
            backdrop-filter: blur(10px);
        }

        .referral-stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 6px;
        }

        .referral-code-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 12px 16px;
            border-radius: var(--radius);
            font-family: 'Courier New', monospace;
            font-size: 1.1rem;
            font-weight: 700;
            text-align: center;
            margin: 16px 0;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: var(--transition);
        }

        .referral-code-display:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 20px;
        }

        /* Floating Chat Button */
        .floating-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            animation: bounce 2s infinite;
            display: none;
        }

        .floating-chat-btn.show {
            display: block;
        }

        .chat-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            color: white;
            border: none;
            box-shadow: var(--shadow-lg);
            cursor: pointer;
            font-size: 1.5rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(25, 118, 210, 0.4);
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .header {
                padding: 32px 16px;
                margin-bottom: 20px;
            }

            .logo {
                font-size: 1.8rem;
            }

            .tagline {
                font-size: 0.95rem;
            }

            .motivational-quotes {
                padding: 25px 15px;
                margin: 20px 0;
            }

            .quote-carousel {
                height: 160px;
            }

            .quote-text {
                font-size: 1.2rem;
                padding: 0 5px;
                line-height: 1.4;
            }

            .certification-badges {
                padding: 16px;
                gap: 12px;
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .cert-badge {
                padding: 12px;
            }

            .cert-badge-title {
                font-size: 0.75rem;
            }

            .cert-badge-desc {
                font-size: 0.65rem;
            }

            .user-header {
                padding: 16px;
                flex-direction: column;
                text-align: center;
            }

            .user-actions {
                flex-direction: row;
                justify-content: center;
            }

            .contest-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .contest-card {
                padding: 20px;
            }

            .contest-title {
                font-size: 1.2rem;
            }

            .contest-prize {
                font-size: 2rem;
            }

            .live-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .live-stat {
                padding: 20px 16px;
            }

            .live-stat-value {
                font-size: 1.6rem;
            }

            .modal {
                padding: 12px;
            }

            .auth-card {
                padding: 24px 20px;
            }

            .amount-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .tab-navigation {
                padding: 6px;
                gap: 2px;
            }

            .tab-btn {
                padding: 12px 10px;
                font-size: 0.8rem;
                min-width: 110px;
            }

            .profile-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .referral-stats {
                grid-template-columns: repeat(2, 1fr);
                gap: 16px;
            }

            .quote-text {
                font-size: 1.2rem;
            }

            .success-stories {
                grid-template-columns: 1fr;
                gap: 20px;
            }
        }

        @media (max-width: 480px) {
            .contest-prize {
                font-size: 1.8rem;
            }

            .live-stats {
                grid-template-columns: 1fr;
            }

            .profile-stats {
                grid-template-columns: 1fr;
            }

            .referral-stats {
                grid-template-columns: 1fr;
            }

            .tab-btn {
                min-width: 100px;
                font-size: 0.75rem;
                padding: 10px 8px;
            }
        }

        /* Joined Contest Cards Styling */
        .joined-contest-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            transition: var(--transition);
        }

        .joined-contest-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .contest-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .contest-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text);
            margin: 0;
            font-family: 'Poppins', sans-serif;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-completed {
            background: rgba(25, 118, 210, 0.1);
            color: var(--primary);
            border: 1px solid rgba(25, 118, 210, 0.3);
        }

        .contest-details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .detail-label {
            font-size: 0.85rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--text);
            font-weight: 600;
        }

        .prize-status {
            color: var(--warning);
            font-weight: 700;
        }

        .contest-status {
            color: var(--primary);
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .contest-details-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }
            
            .contest-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .contest-name {
                font-size: 1.1rem;
            }
        }

        @media (max-width: 480px) {
            .contest-details-grid {
                grid-template-columns: 1fr;
            }
            
            .joined-contest-card {
                padding: 16px;
            }
        }

        /* Hide sections initially */
        #authSection,
        #userSection {
            display: none;
        }

        /* Winners Sub-tabs Styling */
        .winners-sub-tab {
            transition: all 0.3s ease;
        }

        .winners-sub-tab:hover:not(.active) {
            background: rgba(25, 118, 210, 0.1);
            color: var(--primary);
        }

        .winners-sub-tab.active {
            background: var(--primary) !important;
            color: white !important;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .winners-sub-content {
            display: none;
        }

        .winners-sub-content.active {
            display: block;
        }

        /* Winners Announcement Styles - Mobile Friendly */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes goldGlow {
            0%, 100% { 
                box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            }
            50% { 
                box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 40px rgba(255, 215, 0, 0.3);
            }
        }

        .winner-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.6s ease-out;
            transition: all 0.3s ease;
            min-height: auto;
        }

        .winner-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .winner-card.gold {
            border: 3px solid #ffd700;
            animation: goldGlow 2s ease-in-out infinite;
        }

        .winner-card.silver {
            border: 3px solid #c0c0c0;
        }

        .winner-card.bronze {
            border: 3px solid #cd7f32;
        }

        .consolation-winner {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            font-size: 0.85rem;
            animation: fadeInUp 0.4s ease-out;
            margin-bottom: 8px;
        }

        .winner-item {
            background: rgba(76, 175, 80, 0.1);
            padding: 12px;
            border-radius: 12px;
            border-left: 4px solid var(--success);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .winner-numbers {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }

        .winner-prize {
            font-weight: 800;
            color: var(--success);
            font-size: 1.1rem;
        }

        /* Contest-wise winners organization */
        .contest-winner-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .contest-winner-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .contest-winner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .contest-winner-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .contest-winner-stats {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .contest-winners-list {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .contest-winners-list.expanded {
            display: block;
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .modal-content {
                margin: 10px auto;
                max-height: 95vh;
                max-width: 95vw;
                padding: 0;
            }

            .modal-body {
                padding: 16px;
                max-height: 80vh;
                overflow-y: auto;
            }

            .winner-card {
                padding: 12px;
                margin-bottom: 12px;
            }

            .consolation-winner {
                padding: 8px;
                font-size: 0.8rem;
            }

            #top3Winners {
                grid-template-columns: 1fr !important;
                gap: 12px;
            }

            #consolationWinners {
                grid-template-columns: 1fr !important;
                gap: 8px;
            }

            .contest-winner-card {
                padding: 16px;
                margin-bottom: 12px;
            }

            .contest-winner-title {
                font-size: 1.1rem;
            }

            #countdownTimer {
                font-size: 3rem !important;
            }
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 5px auto;
                max-width: 98vw;
            }

            .modal-body {
                padding: 12px;
            }

            .winner-card {
                padding: 10px;
            }

            .contest-winner-title {
                font-size: 1rem;
            }

            #countdownTimer {
                font-size: 2.5rem !important;
            }
        }
    </style>
</head>
<body>
<!-- Landing Section -->
<div id="landingSection">
<div class="container">
<div class="header">
<div class="header-content">
<h1 class="logo">Smart Lottery</h1>
<p class="tagline">India's Most Trusted Lottery Platform</p>
<button class="btn btn-success" onclick="showAuth()" style="font-size: 1.1rem; padding: 16px 32px;">
<i class="fas fa-rocket"></i> Join Now &amp; Win Big
                    </button>
<div class="trust-badges">
<div class="trust-badge">
<i class="fas fa-shield-alt"></i> 100% Secure
                        </div>
<div class="trust-badge">
<i class="fas fa-bolt"></i> Instant Payouts
                        </div>
<div class="trust-badge">
<i class="fas fa-users"></i> 50,000+ Winners
                        </div>
</div>
</div>
</div>
<!-- Enhanced Motivational Quotes Section -->
<div class="motivational-quotes">
<div class="quote-carousel">
<div class="quote-item active">
<div class="quote-text">"Fortune Favors the Bold - Your Lucky Moment Starts Here!"</div>
<div class="quote-author">- Smart Lottery </div>
</div>
<div class="quote-item">
<div class="quote-text">"Dreams Don't Work Unless You Do - Play Smart, Win Big!"</div>
<div class="quote-author">- Winner's Mindset</div>
</div>
<div class="quote-item">
<div class="quote-text">"Every Ticket is a Step Towards Your Million Dollar Dream!"</div>
<div class="quote-author">- Success Stories</div>
</div>
<div class="quote-item">
<div class="quote-text">"Today's Players, Tomorrow's Millionaires - Join the Elite!"</div>
<div class="quote-author">- Elite Winners Club</div>
</div>
</div>
</div>
<!-- Success Stories Section -->
<div class="success-stories">
<div class="success-story">
<div class="success-story-icon">
<i class="fas fa-crown"></i>
</div>
<div class="success-story-title">50 Lakh Winner</div>
<div class="success-story-desc">"I never believed I could win until Smart Lottery changed my life forever!" - Arvind Ravi, M.P</div>
</div>
<div class="success-story">
<div class="success-story-icon">
<i class="fas fa-star"></i>
</div>
<div class="success-story-title">Daily Jackpots</div>
<div class="success-story-desc">"Over 200 people become winners every single day! Your turn is just one ticket away."</div>
</div>
<div class="success-story">
<div class="success-story-icon">
<i class="fas fa-trophy"></i>
</div>
<div class="success-story-title">Life Transformed</div>
<div class="success-story-desc">"From struggling to thriving - thousands have transformed their destiny with us!"</div>
</div>
</div>
<!-- Certification Badges -->
<div class="certification-badges">
<div class="cert-badge">
<i class="fas fa-random"></i>
<div class="cert-badge-title">RNG Certified</div>
<div class="cert-badge-desc">Provably Fair Random Number Generation</div>
</div>
<div class="cert-badge">
<i class="fas fa-lock"></i>
<div class="cert-badge-title">SSL Secured</div>
<div class="cert-badge-desc">256-bit Bank Grade Encryption</div>
</div>
<div class="cert-badge">
<i class="fas fa-certificate"></i>
<div class="cert-badge-title">ISO Certified</div>
<div class="cert-badge-desc">International Quality Standards</div>
</div>
<div class="cert-badge">
<i class="fas fa-shield-check"></i>
<div class="cert-badge-title">Licensed</div>
<div class="cert-badge-desc">Government Approved Platform</div>
</div>
<div class="cert-badge">
<i class="fas fa-balance-scale"></i>
<div class="cert-badge-title">Fair Play</div>
<div class="cert-badge-desc">Transparent &amp; Audited Results</div>
</div>
<div class="cert-badge">
<i class="fas fa-headset"></i>
<div class="cert-badge-title">24/7 Chat Support</div>
<div class="cert-badge-desc">Email &amp; Telegram Help Desk</div>
</div>
</div>
<!-- Live Stats -->
<div class="live-stats">
<div class="live-stat">
<div class="live-stat-icon">
<i class="fas fa-users"></i>
</div>
<div class="live-stat-value" id="totalUsers">45,287</div>
<div class="live-stat-label">Active Players</div>
</div>
<div class="live-stat">
<div class="live-stat-icon">
<i class="fas fa-trophy"></i>
</div>
<div class="live-stat-value" id="totalPrizes">12.5L</div>
<div class="live-stat-label">Prizes Distributed</div>
</div>
<div class="live-stat">
<div class="live-stat-icon">
<i class="fas fa-crown"></i>
</div>
<div class="live-stat-value" id="winnersToday">127</div>
<div class="live-stat-label">Winners Today</div>
</div>
</div>
</div>
</div>
<!-- Auth Section -->
<div id="authSection">
<div class="auth-container">
<div class="auth-card">
<!-- Terms and Conditions Agreement -->
<div id="termsAgreement">
<div class="auth-header">
<h2>Terms &amp; Conditions</h2>
<p>Please read and accept our terms before proceeding</p>
<div class="auth-motivational-quote">
                            "Success begins with acceptance of opportunity!"
                        </div>
</div>
<div class="terms-container">
<h3>1. Platform Overview</h3>
<p>Smart Lottery is a digital lottery platform works as per the Information Technology Act, 2000 and operates in compliance with applicable Indian laws. Our platform provides fair, transparent, and secure lottery services to users across India.</p>
<h3>2. Eligibility</h3>
<p>You must be at least 18 years old and a legal resident of India to participate. Participation is prohibited in states where online lotteries are banned. By registering, you confirm your eligibility and legal capacity to enter into this agreement.</p>
<h3>3. Registration &amp; Account Security</h3>
<p>You must provide accurate, complete information during registration. You are responsible for maintaining account confidentiality and all activities under your account. Email verification is mandatory for account activation.</p>
<h3>4. Payment &amp; Transactions</h3>
<p>All payments are processed through secure, licensed payment gateways. Deposits are non-refundable once lottery tickets are purchased. Winnings are credited automatically upon result declaration. Minimum withdrawal is 500.</p>
<h3>5. Fair Play &amp; Transparency</h3>
<p>All lottery draws use certified random number generation systems. Results are transparent and verifiable. No manipulation or fraud is tolerated. Winners are selected based purely on chance and luck.</p>
<h3>6. Taxation</h3>
<p>Winners are responsible for applicable taxes as per Indian Income Tax laws. TDS will be deducted for winnings above 1,00,000 as per government regulations. We provide necessary tax certificates.</p>
<h3>7. Responsible Gaming</h3>
<p>We promote responsible gaming. Please play within your means. If you feel you have a gambling problem, please seek help. We reserve the right to suspend accounts showing signs of problem gambling.</p>
<h3>8. Privacy &amp; Data Protection</h3>
<p>We protect your personal data as per our Privacy Policy and Indian data protection laws. Your information is never shared with third parties without consent, except as required by law.</p>
<h3>9. Dispute Resolution</h3>
<p>Any disputes will be resolved through arbitration in accordance with Indian Arbitration laws. The jurisdiction will be Mumbai, Maharashtra. Customer support is available 24/7 for assistance.</p>
<h3>10. Platform Availability</h3>
<p>We strive for 99.9% uptime but cannot guarantee uninterrupted service. Maintenance windows will be announced in advance. No liability for temporary service disruptions.</p>
</div>
<div class="terms-checkbox">
<input id="acceptTerms" required="" type="checkbox"/>
<label for="acceptTerms">I have read, understood, and agree to the Terms &amp; Conditions, Privacy Policy, and confirm that I am 18+ years old and legally eligible to participate in online lotteries.</label>
</div>
<button class="btn btn-primary btn-full" disabled="" id="proceedBtn" onclick="proceedToAuth()">
<i class="fas fa-check-circle"></i> Accept &amp; Continue
                    </button>
</div>
<!-- Login Form -->
<div id="loginForm" style="display: none;">
<div class="auth-header">
<h2>Welcome Back</h2>
<p>Sign in to continue your winning journey</p>
<div class="auth-motivational-quote">
                            "Dream Big, Play Smart, Win Bigger!<br/>Your Luck is Waiting  Grab It Now!"
                        </div>
</div>
<form onsubmit="handleLogin(event)">
<div class="form-group">
<label class="form-label">Email Address</label>
<input class="form-input" id="loginEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label class="form-label">Password</label>
<div class="password-input-container">
<input class="form-input" id="loginPassword" placeholder="Enter your password" required="" type="password"/>
<button class="password-toggle" onclick="togglePasswordVisibility('loginPassword')" type="button">
<i class="fas fa-eye"></i>
</button>
</div>
</div>
<button class="btn btn-primary btn-full" type="submit">
<i class="fas fa-sign-in-alt"></i> Sign In
                        </button>
</form>
<div class="auth-toggle">
                        Don't have an account? <a href="#" onclick="toggleAuthForm('signup')">Sign Up</a>
</div>
</div>
<!-- Signup Form -->
<div id="signupForm" style="display: none;">
<div class="auth-header">
<h2>Join Smart Lottery</h2>
<p>Create your account and start winning</p>
<div class="auth-motivational-quote">
                            "Your Journey to Fortune Begins with a Single Step!<br/>Today's Signup, Tomorrow's Jackpot!"
                        </div>
                        <div style="background: rgba(25, 118, 210, 0.1); padding: 12px; border-radius: 8px; margin: 16px 0; font-size: 0.85rem; color: var(--text-light);">
                            <i class="fas fa-info-circle"></i> You'll receive an OTP via email to verify your account during signup.
                        </div>
                        
                        <!-- OTP Verification Section (Hidden initially) -->
                        <div id="otpVerificationSection" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Enter OTP</label>
                                <input class="form-input" id="otpInput" placeholder="Enter 6-digit OTP sent to your email" type="text" maxlength="6"/>
                                <small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">
                                    <i class="fas fa-clock"></i> OTP is valid for 10 minutes
                                </small>
                            </div>
                            <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                                <button class="btn btn-primary" onclick="verifyOTP()" style="flex: 1;">
                                    <i class="fas fa-check"></i> Verify OTP
                                </button>
                                <button class="btn btn-outline" onclick="resendOTP()" style="flex: 1;">
                                    <i class="fas fa-paper-plane"></i> Resend OTP
                                </button>
                            </div>
                        </div>
</div>
<form onsubmit="handleSignup(event)">
<div class="form-group">
<label class="form-label">Full Name</label>
<input class="form-input" id="signupName" placeholder="Enter your full name" required="" type="text"/>
</div>
<div class="form-group">
<label class="form-label">Email Address</label>
<input class="form-input" id="signupEmail" placeholder="Enter your email" required="" type="email"/>
</div>
<div class="form-group">
<label class="form-label">Password</label>
<div class="password-input-container">
<input class="form-input" id="signupPassword" minlength="6" placeholder="Create a strong password" required="" type="password"/>
<button class="password-toggle" onclick="togglePasswordVisibility('signupPassword')" type="button">
<i class="fas fa-eye"></i>
</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Referral Code (Optional)</label>
<input class="form-input" id="signupReferral" placeholder="Enter referral code if you have one" type="text"/>
<small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">
<i class="fas fa-gift"></i> Get 50 bonus when your referrer adds 100+
                            </small>
</div>
<button class="btn btn-primary btn-full" type="submit">
<i class="fas fa-user-plus"></i> Create Account
                        </button>
</form>
<div class="auth-toggle">
                        Already have an account? <a href="#" onclick="toggleAuthForm('login')">Sign In</a>
                </div>
                <div class="auth-toggle" id="backToSignupLink" style="display: none;">
                        <a href="#" onclick="resetSignupForm()"> Back to Signup Form</a>
                </div>
</div>
</div>
</div>
</div>
<!-- Floating Chat Button (Only shows after login) -->
<div class="floating-chat-btn" id="floatingChatBtn">
<button class="chat-btn" onclick="openChatModal()">
<i class="fas fa-comments"></i>
</button>
</div>
<!-- Lottery Numbers Modal -->
<div class="modal" id="lotteryNumbersModal">
<div class="modal-content">
<div class="modal-header">
<h2> Your Lottery Numbers</h2>
<button class="modal-close" onclick="closeModal('lotteryNumbersModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div style="text-align: center; padding: 20px;">
<h3 id="contestNameDisplay" style="color: var(--primary); margin-bottom: 20px;"></h3>
<div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 30px; border-radius: 20px; margin: 20px 0; box-shadow: var(--shadow-xl);">
<div style="font-size: 1.2rem; opacity: 0.9; margin-bottom: 15px;"> Your Lucky Number</div>
<div id="displayLotteryNumbers" style="font-size: 3rem; font-weight: 800; letter-spacing: 3px; font-family: 'Courier New', monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
</div>
<div style="font-size: 0.9rem; opacity: 0.8; margin-top: 15px;">Keep this number safe - it's your ticket to winning!</div>
</div>
<div style="background: rgba(25, 118, 210, 0.1); padding: 20px; border-radius: 12px; margin: 20px 0;">
<p style="margin: 0; color: var(--text); font-size: 0.95rem; line-height: 1.6;">
<i class="fas fa-info-circle" style="color: var(--primary);"></i>
                            These numbers are randomly generated and stored securely. You can view them anytime in the "My Contests" tab.
                        </p>
</div>
<button class="btn btn-primary btn-full" onclick="closeModal('lotteryNumbersModal')">
<i class="fas fa-check"></i> Got It!
                    </button>
</div>
</div>
</div>
</div>
<!-- Chat Modal -->
<div class="modal" id="chatModal">
<div class="modal-content">
<div class="modal-header">
<h2>Customer Support</h2>
<button class="modal-close" onclick="closeModal('chatModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div style="text-align: center; padding: 20px;">
<div style="font-size: 3rem; color: var(--text-lighter); margin-bottom: 20px;">
<i class="fas fa-comments"></i>
</div>
<h3 style="color: var(--text); margin-bottom: 16px;">Chat Currently Unavailable</h3>
<p style="color: var(--text-light); margin-bottom: 30px; line-height: 1.6;">
                        Our chat service is currently unavailable. Please reach out to us through the following channels:
                    </p>
<div style="display: flex; flex-direction: column; gap: 16px;">
<a class="btn btn-primary" href="mailto:support@smartlottery.in" style="text-decoration: none;">
<i class="fas fa-envelope"></i> Email: support@smartlottery.in
                        </a>
<a class="btn btn-success" href="https://t.me/+K-Ro-WZBF7FmMTA1" style="text-decoration: none;" target="_blank">
<i class="fab fa-telegram"></i> Join Our Telegram Channel
                        </a>
</div>
<div style="margin-top: 20px; padding: 16px; background: rgba(25, 118, 210, 0.1); border-radius: var(--radius); color: var(--text-light);">
<p style="margin: 0; font-size: 0.9rem;">
<i class="fas fa-clock"></i> We typically respond within 24 hours. For urgent matters, please use our Telegram channel.
                        </p>
</div>
</div>
</div>
</div>
</div>
<!-- Winners Announcement Modal -->
<div class="modal" id="winnersAnnouncementModal">
<div class="modal-content" style="max-width: min(900px, 95vw);">
<div class="modal-header">
<h2> Contest Results</h2>
<button class="modal-close" onclick="closeModal('winnersAnnouncementModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div style="text-align: center; padding: 16px;">
<!-- Contest Name -->
<h3 id="winnersContestName" style="color: var(--primary); margin-bottom: 20px; font-size: clamp(1.2rem, 4vw, 1.5rem);"></h3>

<!-- Countdown Section -->
<div id="countdownSection" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: white; padding: clamp(20px, 5vw, 40px); border-radius: 20px; margin: 16px 0; box-shadow: var(--shadow-xl);">
<div style="font-size: clamp(1.5rem, 5vw, 2rem); font-weight: 800; margin-bottom: 16px;"> CONGRATULATIONS! </div>
<div style="font-size: clamp(1rem, 3vw, 1.2rem); margin-bottom: 20px; opacity: 0.9;">Winners will be announced in...</div>
<div id="countdownTimer" style="font-size: clamp(3rem, 8vw, 4rem); font-weight: 800; margin: 16px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); animation: pulse 1s ease-in-out infinite;">10</div>
<div style="font-size: clamp(0.9rem, 2.5vw, 1rem); opacity: 0.8;">Get ready for the big reveal!</div>
</div>

<!-- Winners Display Section (Hidden initially) -->
<div id="winnersRevealSection" style="display: none;">
<!-- Top 3 Winners -->
<div style="background: linear-gradient(135deg, #ffd700, #ffed4e); color: #000; padding: clamp(16px, 4vw, 20px); border-radius: 16px; margin: 16px 0; box-shadow: 0 8px 25px rgba(255, 215, 0, 0.4);">
<h3 style="margin: 0 0 16px 0; font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 800;"> TOP 3 WINNERS </h3>
<div id="top3Winners" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
<!-- Top 3 winners will be populated here -->
</div>
</div>

<!-- Consolation Winners -->
<div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: clamp(16px, 4vw, 20px); border-radius: 16px; margin: 16px 0; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);">
<h3 style="margin: 0 0 16px 0; font-size: clamp(1.1rem, 3.5vw, 1.3rem); font-weight: 700;"> CONSOLATION PRIZES </h3>
<div id="consolationWinners" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
<!-- Consolation winners will be populated here -->
</div>
</div>

<!-- Close Button -->
<div style="margin-top: 24px;">
<button class="btn btn-primary" onclick="closeModal('winnersAnnouncementModal')" style="font-size: clamp(1rem, 3vw, 1.2rem); padding: 12px 24px; background: linear-gradient(135deg, #4f46e5, #7c3aed); width: 100%; max-width: 300px;">
<i class="fas fa-trophy"></i> Amazing! Check Winners Tab
</button>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Live Draw Results Modal -->
<div class="modal" id="liveDrawModal">
<div class="modal-content">
<div class="modal-header">
<h2> Live Draw Results</h2>
<button class="modal-close" onclick="closeModal('liveDrawModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div id="drawResultsContent">
<!-- Draw results content will be loaded here -->
</div>
</div>
</div>
</div>
<!-- User Section -->
<div id="userSection">
<div class="container">
<!-- User Header -->
<div class="user-header">
<div class="user-info">
<div class="user-avatar" id="userAvatar">U</div>
<div class="user-details">
<h3 id="userDisplayName">Smart Player</h3>
<div class="user-email" id="userEmail">user@example.com</div>
<div class="user-balance">Balance: <span id="userBalance">0</span></div>
</div>
</div>
<div class="user-actions">
<button class="btn btn-success" onclick="openModal('addMoneyModal')">
<i class="fas fa-plus"></i> Add Money
                    </button>
<button class="btn btn-outline" onclick="handleLogout()">
<i class="fas fa-sign-out-alt"></i> Logout
                    </button>
</div>
</div>
<!-- Tab Navigation -->
<div class="tab-navigation">
<button class="tab-btn active" onclick="switchTab('contests')">
<i class="fas fa-trophy"></i> Live Contests
                </button>
<button class="tab-btn" onclick="switchTab('joinedContests')">
<i class="fas fa-list"></i> My Contests
                </button>
<button class="tab-btn" onclick="switchTab('winners')">
<i class="fas fa-crown"></i> Winners
                </button>
<button class="tab-btn" onclick="switchTab('transactions')">
<i class="fas fa-exchange-alt"></i> Transactions
                </button>
<button class="tab-btn" onclick="switchTab('profile')">
<i class="fas fa-user"></i> Profile
                </button>
<button class="tab-btn" onclick="switchTab('referrals')">
<i class="fas fa-share-alt"></i> Referrals
                </button>
<button class="tab-btn" onclick="switchTab('withdrawal')">
<i class="fas fa-money-bill-wave"></i> Withdraw
                </button>
<button class="tab-btn" id="adminTab" onclick="switchTab('admin')" style="display: none;">
<i class="fas fa-cog"></i> Admin Panel
                </button>
</div>
<!-- Tab Contents -->
<div class="tab-content active" id="contestsTab">
<div class="contest-grid" id="contestGrid">
<!-- Contest cards will be rendered here -->
</div>
</div>
<div class="tab-content" id="joinedContestsTab">
<!-- Admin Contest Management Section (Only visible to admins) -->
<div id="adminContestManagement" style="display: none; margin-bottom: 32px;">
<div style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;">
<h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-crown"></i> Admin Contest Management
                        </h3>
<p style="margin: 0; opacity: 0.9;">As an admin, you can manage all contests from here. End contests to declare winners and restart with fresh timers.</p>
</div>
<div id="adminContestGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">
<!-- Admin contest controls will be rendered here -->
</div>
</div>
<div style="margin-bottom: 32px;">
<h3 style="color: var(--primary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-play-circle"></i> Active Contests
                    </h3>
<div id="activeJoinedContestsList">
<!-- Active joined contests will be rendered here -->
</div>
</div>
<div>
<h3 style="color: var(--secondary); margin-bottom: 16px; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-check-circle"></i> Completed Contests
                    </h3>
<div id="completedJoinedContestsList">
<!-- Completed joined contests will be rendered here -->
</div>
</div>
</div>
<div class="tab-content" id="winnersTab">
            <!-- Winners Sub-tabs -->
            <div style="display: flex; background: rgba(255, 255, 255, 0.9); border-radius: var(--radius-lg); padding: 8px; margin-bottom: 20px; box-shadow: var(--shadow);">
                <button class="winners-sub-tab active" onclick="switchWinnersTab('current')" style="flex: 1; padding: 12px 20px; border: none; background: var(--primary); color: white; border-radius: var(--radius); cursor: pointer; font-weight: 600; transition: var(--transition);">
                    <i class="fas fa-trophy"></i> Current Results
                </button>
                <button class="winners-sub-tab" onclick="switchWinnersTab('global')" style="flex: 1; padding: 12px 20px; border: none; background: transparent; color: var(--text-light); border-radius: var(--radius); cursor: pointer; font-weight: 600; transition: var(--transition); margin-left: 8px;">
                    <i class="fas fa-globe"></i> Global Winners
                </button>
            </div>
            
            <!-- Current Results Tab -->
            <div id="currentWinnersContent" class="winners-sub-content active">
                <div class="data-list" id="currentWinnersList">
                    <!-- Current contest results will be rendered here -->
                </div>
            </div>
            
            <!-- Global Winners Tab -->
            <div id="globalWinnersContent" class="winners-sub-content" style="display: none;">
                <div class="data-list" id="globalWinnersList">
                    <!-- Global winners will be rendered here -->
                </div>
            </div>
        </div>
<div class="tab-content" id="transactionsTab">
<div class="data-list" id="transactionsList">
<!-- Transactions will be rendered here -->
</div>
</div>
<div class="tab-content" id="profileTab">
<div class="profile-section">
<h2>Your Profile</h2>
<div class="profile-stats">
<div class="profile-stat">
<div class="profile-stat-value" id="profileContestsJoined">0</div>
<div class="profile-stat-label">Contests Joined</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="profileContestsWon">0</div>
<div class="profile-stat-label">Contests Won</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="profileTotalWinnings">0</div>
<div class="profile-stat-label">Total Winnings</div>
</div>
<div class="profile-stat">
<div class="profile-stat-value" id="profileWinRate">0%</div>
<div class="profile-stat-label">Win Rate</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="referralsTab">
<div class="referral-section">
<div class="referral-content">
<h2 style="margin-bottom: 12px;">
<i class="fas fa-share-alt"></i> Referral Program
                        </h2>
<p style="margin-bottom: 16px; opacity: 0.9;">
                            Share your referral code with friends and earn 50 for each friend who adds minimum 100 to their wallet!
                        </p>
<div class="referral-code-display" id="userReferralCode" onclick="copyReferralCode()">
                            SL123456
                        </div>
<div class="share-buttons">
<button class="btn btn-success" onclick="copyReferralCode()">
<i class="fas fa-copy"></i> Copy Code
                            </button>
<button class="btn btn-primary" onclick="shareOnWhatsApp()">
<i class="fab fa-whatsapp"></i> WhatsApp
                            </button>
<button class="btn btn-primary" onclick="shareReferralCode()">
<i class="fas fa-share"></i> Share Link
                            </button>
</div>
<div class="referral-stats">
<div class="referral-stat">
<div class="referral-stat-value" id="referralEarnings">0</div>
<div class="referral-stat-label">Total Earnings</div>
</div>
<div class="referral-stat">
<div class="referral-stat-value" id="referredUsers">0</div>
<div class="referral-stat-label">Friends Referred</div>
</div>
<div class="referral-stat">
<div class="referral-stat-value" id="pendingReferrals">0</div>
<div class="referral-stat-label">Pending Bonuses</div>
</div>
</div>
</div>
</div>
<!-- Referral History -->
<div class="profile-section">
<h3 style="margin-bottom: 16px;">
<i class="fas fa-history"></i> Referral History
                    </h3>
<div class="data-list" id="referralHistory">
<!-- Referral history will be rendered here -->
</div>
</div>
</div>
<div class="tab-content" id="withdrawalTab">
<div class="profile-section">
<h2>Withdraw Money</h2>
<p style="margin-bottom: 20px; color: var(--text-light);">Withdraw your winnings to your bank account or UPI</p>
<div class="form-group">
<label class="form-label">Withdrawal Amount</label>
<input class="form-input" id="withdrawalAmount" min="500" placeholder="Minimum 500" type="number"/>
</div>
<div class="form-group">
<label class="form-label">UPI ID</label>
<input class="form-input" id="withdrawalUPI" placeholder="yourname@upi (e.g., 9876543210@paytm)" type="text"/>
</div>
<button class="btn btn-primary btn-full" onclick="handleWithdrawal()">
<i class="fas fa-money-bill-wave"></i> Request Withdrawal
                    </button>
<div style="margin-top: 20px; padding: 16px; background: rgba(25, 118, 210, 0.05); border-radius: var(--radius); font-size: 0.9rem; color: var(--text-light);">
<strong>Note:</strong> Withdrawals require admin approval and are processed within 24-48 hours. Minimum withdrawal amount is 500.
                    </div>
</div>
<!-- Admin Approval Section (Only visible to admins) -->
<div id="adminApprovalSection" style="display: none; margin-top: 32px;">
<div style="background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: white; padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;">
<h3 style="margin: 0 0 16px 0; display: flex; align-items: center; gap: 10px;">
<i class="fas fa-shield-alt"></i> Admin Approval Center
                        </h3>
<p style="margin: 0; opacity: 0.9;">Approve or reject deposit and withdrawal requests from users.</p>
</div>
<!-- Deposits Section -->
<div style="margin-bottom: 32px;">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="margin: 0; color: var(--primary);"> Pending Deposits</h3>
<button class="btn btn-outline" onclick="loadAdminApprovals()">
<i class="fas fa-sync"></i> Refresh
                            </button>
</div>
<div class="data-list" id="adminDeposits">
<div class="data-item">
<div class="data-item-info">
<div class="data-item-title">Loading deposits...</div>
</div>
</div>
</div>
</div>
<!-- Withdrawals Section -->
<div>
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
<h3 style="margin: 0; color: var(--error);"> Pending Withdrawals</h3>
<button class="btn btn-outline" onclick="loadAdminApprovals()">
<i class="fas fa-sync"></i> Refresh
                            </button>
</div>
<div class="data-list" id="adminWithdrawals">
<div class="data-item">
<div class="data-item-info">
<div class="data-item-title">Loading withdrawals...</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="tab-content" id="adminTab">
<div class="profile-section">
<h2>Admin Control Panel</h2>
<div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 24px; border-radius: var(--radius-lg); margin-bottom: 24px;">
<h3 style="margin: 0 0 16px 0;"> Admin Dashboard</h3>
<p style="margin: 0; opacity: 0.9;">Welcome to the admin panel. Use the "My Contests" tab to manage all lottery contests. Use the "Withdraw" tab to approve deposits and withdrawals.</p>
</div>
<!-- Quick Actions -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 32px;">
<button class="btn btn-success" onclick="switchTab('joinedContests')" style="padding: 16px;">
<i class="fas fa-cog"></i> Manage Contests
                        </button>
<button class="btn btn-primary" onclick="switchTab('withdrawal')" style="padding: 16px;">
<i class="fas fa-check-circle"></i> Approve Transactions
                        </button>
<button class="btn btn-warning" onclick="simulateContestDraw()" style="padding: 16px;">
<i class="fas fa-play"></i> Test Draw Simulation
                        </button>
<button class="btn btn-info" onclick="viewDrawResults()" style="padding: 16px;">
<i class="fas fa-chart-line"></i> View Draw Results
                        </button>
</div>
<!-- Admin Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
<div style="text-align: center; padding: 20px; background: rgba(25, 118, 210, 0.1); border-radius: var(--radius);">
<div style="font-size: 1.8rem; font-weight: 800; color: var(--primary); margin-bottom: 6px;">${CONTEST_TEMPLATES.length}</div>
<div style="color: var(--text-light); font-weight: 500;">Active Contests</div>
</div>
<div style="text-align: center; padding: 20px; background: rgba(76, 175, 80, 0.1); border-radius: var(--radius);">
<div id="adminStatsUsers" style="font-size: 1.8rem; font-weight: 800; color: var(--success); margin-bottom: 6px;">-</div>
<div style="color: var(--text-light); font-weight: 500;">Total Users</div>
</div>
<div style="text-align: center; padding: 20px; background: rgba(255, 152, 0, 0.1); border-radius: var(--radius);">
<div id="adminStatsDeposits" style="font-size: 1.8rem; font-weight: 800; color: var(--warning); margin-bottom: 6px;">-</div>
<div style="color: var(--text-light); font-weight: 500;">Pending Deposits</div>
</div>
<div style="text-align: center; padding: 20px; background: rgba(244, 67, 54, 0.1); border-radius: var(--radius);">
<div id="adminStatsWithdrawals" style="font-size: 1.8rem; font-weight: 800; color: var(--error); margin-bottom: 6px;">-</div>
<div style="color: var(--text-light); font-weight: 500;">Pending Withdrawals</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Add Money Modal -->
<div class="modal" id="addMoneyModal">
<div class="modal-content">
<div class="modal-header">
<h2>Add Money to Wallet</h2>
<button class="modal-close" onclick="closeModal('addMoneyModal')">
<i class="fas fa-times"></i>
</button>
</div>
<div class="modal-body">
<div class="form-group">
<label class="form-label">Select Amount</label>
<div class="amount-buttons">
<button class="amount-btn" onclick="setAmount(100)">100</button>
<button class="amount-btn" onclick="setAmount(500)">500</button>
<button class="amount-btn" onclick="setAmount(1000)">1,000</button>
<button class="amount-btn" onclick="setAmount(2000)">2,000</button>
<button class="amount-btn" onclick="setAmount(5000)">5,000</button>
<button class="amount-btn" onclick="setAmount(10000)">10,000</button>
</div>
</div>
<div class="form-group">
<label class="form-label">Or Enter Custom Amount</label>
<input class="form-input" id="amountInput" max="50000" min="10" oninput="updatePaymentSummary()" placeholder="Enter amount (10 - 50,000)" type="number"/>
</div>
<div class="form-group" style="text-align: center; margin-top: 20px;">
<label class="form-label">Payment Method</label>
<div style="margin: 15px 0;">
<p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 15px;">
                            Pay securely via Razorpay payment link
                        </p>
<a class="btn btn-primary" href="https://razorpay.me/@smartclasses7445" style="text-decoration: none; margin-top: 8px; font-size: 1.1rem; padding: 16px 32px;" target="_blank">
<i class="fas fa-external-link-alt"></i> Pay Now via Razorpay
                        </a>
<p style="font-size: 0.8rem; color: var(--text-light); margin-top: 15px;">
                            Click above for secure online payment. Supports UPI, Cards, Net Banking &amp; Wallets
                        </p>
</div>
</div>
<div class="form-group">
<label class="form-label">Transaction ID/UTR Number</label>
<input class="form-input" id="transactionId" placeholder="Enter transaction ID from your payment receipt" type="text"/>
<small style="color: var(--text-light); font-size: 0.85rem; margin-top: 5px; display: block;">
                        Please enter the transaction ID exactly as shown in your payment receipt
                    </small>
</div>
<div class="payment-summary">
<div class="summary-row">
<span>You Pay:</span>
<span id="totalAmount">0</span>
</div>
<div class="summary-row">
<span>Added to Wallet:</span>
<span id="paymentAmount">0</span>
</div>
</div>
<button class="btn btn-success btn-full" onclick="handlePayment()">
<i class="fas fa-credit-card"></i> Submit for Approval
                </button>
</div>
</div>
</div>
<script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBXeD8SMXHnqhNDg01Rlm4fC1t05Eb4NFs",
            authDomain: "smart-lottery-b08c5.firebaseapp.com",
            projectId: "smart-lottery-b08c5",
            storageBucket: "smart-lottery-b08c5.appspot.com",
            messagingSenderId: "1038545058004",
            appId: "1:1038545058004:web:65b29c57eda2939f18e341",
            measurementId: "G-SH9Y19ZE74"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // EmailJS Configuration from image
        const EMAILJS_CONFIG = {
            serviceId: 'service_47qlupj',
            templateId: 'template_35nhbfq',
            userId: 'O6aKZpLONxWhUqVFU'
        };

        // Initialize EmailJS when DOM is loaded
        let emailjsInitialized = false;
        let currentOTP = '';

        function initializeEmailJS() {
            try {
                if (typeof emailjs === 'undefined') {
                    emailjs.init(EMAILJS_CONFIG.userId);
                    emailjsInitialized = true;
                    console.log(' EmailJS initialized successfully');
                } else {
                    console.log('EmailJS already loaded');
                }
            } catch (error) {
                console.error('Error initializing EmailJS:', error);
            }
        }

        // Global variables
        let currentUser = null;
        let userBalance = 0;
        let isAdmin = false;
        let userProfile = {
            contestsJoined: 0,
            contestsWon: 0,
            totalWinnings: 0
        };
        let transactions = [];
        let winners = [];
        let activeContests = [];
        let joinedContests = [];
        let withdrawalHistory = [];
        let userReferralCode = '';
        let referralData = {
            earnings: 0,
            referredUsers: [],
            pendingReferrals: 0
        };

        // Admin emails - these users can approve/reject deposits and withdrawals
        const ADMIN_EMAILS = ['vishuu7306@gmail.com', 'admin@smartlottery.in'];

        // Global contest state to maintain consistent timers and participants across all users
        let globalContestState = {};

        // Dynamic participant counts stored in Firestore for real-time updates
        let globalParticipantCounts = {};

        // Initialize global contest state with realistic participant progression
        async function initializeGlobalContestState() {
            const saved = localStorage.getItem('smartLotteryContestState');
            if (saved) {
                try {
                    globalContestState = JSON.parse(saved);
                    // Clean up expired contests and reset with realistic progression
                    Object.keys(globalContestState).forEach(templateId => {
                        const contest = globalContestState[templateId];
                        if (new Date(contest.endTime) < new Date()) {
                            const template = CONTEST_TEMPLATES.find(t => t.id === templateId);
                            if (template) {
                                const newEndTime = getNextDrawTime(template);
                                globalContestState[templateId] = {
                                    ...template,
                                    endTime: newEndTime,
                                    participants: calculateRealisticParticipantCount(template, newEndTime),
                                    startTime: new Date(),
                                    initialParticipants: Math.floor(template.maxParticipants * 0.15) // Start at 15%
                                };
                            }
                        } else {
                            // Update existing contest with realistic count
                            const template = CONTEST_TEMPLATES.find(t => t.id === templateId);
                            if (template) {
                                contest.participants = calculateRealisticParticipantCount(template, new Date(contest.endTime));
                            }
                        }
                    });
                } catch (e) {
                    globalContestState = {};
                }
            } else {
                // Initialize fresh state with realistic progression
                CONTEST_TEMPLATES.forEach(template => {
                    const endTime = getNextDrawTime(template);
                    globalContestState[template.id] = {
                        ...template,
                        endTime: endTime,
                        participants: calculateRealisticParticipantCount(template, endTime),
                        startTime: new Date(),
                        initialParticipants: Math.floor(template.maxParticipants * 0.15)
                    };
                });
            }
            
            // Load real participant counts from Firestore and merge with realistic progression
            await loadRealParticipantCounts();
            saveGlobalContestState();
        }

        // Calculate realistic participant count based on time progression
        function calculateRealisticParticipantCount(template, endTime) {
            if (!template || !endTime) {
                console.warn('Invalid template or endTime provided to calculateRealisticParticipantCount');
                return Math.floor(Math.random() * 500) + 100; // Return a safe fallback value
            }
            
            const now = new Date();
            const totalDuration = endTime.getTime() - (globalContestState[template.id]?.startTime?.getTime() || now.getTime() - (24 * 60 * 60 * 1000));
            const timeElapsed = now.getTime() - (globalContestState[template.id]?.startTime?.getTime() || now.getTime() - (24 * 60 * 60 * 1000));
            const timeRemaining = endTime.getTime() - now.getTime();
            
            if (timeRemaining <= 0) {
                // Contest ended, show near max capacity
                return Math.floor(template.maxParticipants * 0.98);
            }
            
            const thirtyMinutes = 30 * 60 * 1000;
            const initialParticipants = globalContestState[template.id]?.initialParticipants || Math.floor(template.maxParticipants * 0.15);
            
            let targetPercentage;
            
            if (timeRemaining <= thirtyMinutes) {
                // Last 30 minutes: reach 97%
                const progressInLastThirtyMin = (thirtyMinutes - timeRemaining) / thirtyMinutes;
                const startPercentage = 0.85; // 85% at 30 min mark
                const endPercentage = 0.97;   // 97% at end
                targetPercentage = startPercentage + (progressInLastThirtyMin * (endPercentage - startPercentage));
            } else {
                // Before last 30 minutes: gradual increase from 15% to 85%
                const progressBeforeLastThirtyMin = timeElapsed / (totalDuration - thirtyMinutes);
                const startPercentage = 0.15;  // 15% at start
                const endPercentage = 0.85;    // 85% at 30 min mark
                targetPercentage = Math.min(startPercentage + (progressBeforeLastThirtyMin * (endPercentage - startPercentage)), endPercentage);
            }
            
            // Add small random variation (2%) to make it look natural
            const variation = (Math.random() - 0.5) * 0.04; // 2%
            targetPercentage = Math.max(0.15, Math.min(0.98, targetPercentage + variation));
            
            const calculatedCount = Math.floor(template.maxParticipants * targetPercentage);
            
            // Ensure minimum growth over time
            const lastCount = globalContestState[template.id]?.participants || initialParticipants;
            return Math.max(calculatedCount, lastCount);
        }

        // Enhanced participant count loading with realistic progression
        async function loadRealParticipantCounts() {
            try {
                console.log('Loading participant counts with realistic progression...');
                
                for (const template of CONTEST_TEMPLATES) {
                    // Get real participants from contest participants collection
                    const participantsSnapshot = await db.collection('contestParticipants')
                        .where('contestId', '==', template.id)
                        .where('status', '==', 'active')
                        .get();
                    
                    const realCount = participantsSnapshot.size;
                    
                    // Get or create realistic base count using progression algorithm
                    let realisticCount = calculateRealisticParticipantCount(template, new Date(globalContestState[template.id].endTime));
                    
                    // Add real participants to the realistic count
                    const finalCount = realisticCount + realCount;
                    globalParticipantCounts[template.id] = finalCount;
                    
                    // Update global state with calculated count
                    if (globalContestState[template.id]) {
                        globalContestState[template.id].participants = finalCount;
                    }
                    
                    // Store in Firestore for consistency across users
                    try {
                        await db.collection('contestStats').doc(template.id).set({
                            participants: finalCount,
                            realisticCount: realisticCount,
                            realParticipants: realCount,
                            totalParticipants: finalCount,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                            contestTitle: template.title,
                            endTime: globalContestState[template.id].endTime,
                            startTime: globalContestState[template.id].startTime || new Date()
                        }, { merge: true });
                    } catch (firestoreError) {
                        console.log('Firestore update failed, using local calculation');
                    }
                    
                    console.log(`Contest ${template.id}: Realistic=${realisticCount}, Real=${realCount}, Final=${finalCount}`);
                }
                
                // Set up real-time listener for participant changes
                setupParticipantCountListener();
                
            } catch (error) {
                console.error('Error loading participant counts:', error);
                // Fallback with realistic progression
                for (const template of CONTEST_TEMPLATES) {
                    try {
                        const realisticCount = calculateRealisticParticipantCount(template, new Date(globalContestState[template.id].endTime));
                        globalParticipantCounts[template.id] = realisticCount;
                        
                        if (globalContestState[template.id]) {
                            globalContestState[template.id].participants = realisticCount;
                        }
                        
                        console.log(`Set realistic fallback count for ${template.id}: ${realisticCount}`);
                    } catch (calcError) {
                        console.error('Error calculating realistic count:', calcError);
                    }
                }
            }
        }

        // Real-time listener for participant count changes
        function setupParticipantCountListener() {
            if (!db) return;
            
            try {
                // Listen for changes in contestStats collection
                db.collection('contestStats').onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'modified' || change.type === 'added') {
                            const contestId = change.doc.id;
                            const data = change.doc.data();
                            const newCount = data.totalParticipants || data.participants || 0;
                            const previousCount = globalParticipantCounts[contestId] || 0;
                            
                            if (previousCount !== newCount) {
                                console.log(` Real-time participant count updated for ${contestId}: ${previousCount}  ${newCount}`);
                                
                                // Update local counts immediately
                                globalParticipantCounts[contestId] = newCount;
                                
                                if (globalContestState[contestId]) {
                                    globalContestState[contestId].participants = newCount;
                                }
                                
                                // Save state
                                saveGlobalContestState();
                                
                                // Update display immediately with animation
                                setTimeout(() => {
                                    generateActiveContests();
                                    
                                    // Show notification for significant increases
                                    const increase = newCount - previousCount;
                                    if (increase > 0 && increase <= 5) {
                                        const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
                                        if (template) {
                                            showNotification(` ${increase} new participant${increase > 1 ? 's' : ''} joined ${template.title}! Total: ${newCount}`, 'info');
                                        }
                                    }
                                }, 100);
                            }
                        }
                    });
                });
                
                console.log('Participant count listener setup complete');
            } catch (error) {
                console.error('Error setting up participant count listener:', error);
            }
        }

        // Initialize winners with some sample data to ensure winners tab is never empty
        function initializeSampleWinners() {
            if (sampleWinners.length === 0) {
                sampleWinners = [
                    { name: 'Arjun Kumar', contest: '1 Crore Weekly Elite', prize: 5000000, date: '2 hours ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Priya Sharma', contest: '60 Lakh Hexa-Daily', prize: 3000000, date: '4 hours ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Rohit Singh', contest: '25 Lakh Penta-Daily', prize: 1250000, date: '6 hours ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Anita Verma', contest: '10 Lakh Quad-Daily', prize: 500000, date: '8 hours ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Vikash Gupta', contest: '5 Lakh Tri-Daily', prize: 250000, date: '12 hours ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Kavya Reddy', contest: '3 Lakh Bi-Daily', prize: 150000, date: '1 day ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Suresh Yadav', contest: 'Daily 1 Lakh Special', prize: 50000, date: '1 day ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Meera Joshi', contest: 'Daily 40K Express', prize: 20000, date: '2 days ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Ramesh Patel', contest: '25 Rupees Instant Fill', prize: 500000, date: '2 days ago', rank: 1, isBot: true, prizePosition: '1st Prize' },
                    { name: 'Sunita Agarwal', contest: '1 Crore Weekly Elite', prize: 2500000, date: '3 days ago', rank: 2, isBot: true, prizePosition: '2nd Prize' }
                ];
                
                // Save initial winners to localStorage
                const winnersJson = JSON.stringify(sampleWinners);
                localStorage.setItem('smartLotteryWinners', winnersJson);
                localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
                localStorage.setItem('smartLotteryAllWinners', winnersJson);
            }
        }

        function saveGlobalContestState() {
            localStorage.setItem('smartLotteryContestState', JSON.stringify(globalContestState));
        }

        // Enhanced broadcasting system for live draw events with Firestore integration
        function broadcastDrawEvent(eventType, contestId, data = {}) {
            const event = {
                type: eventType,
                contestId: contestId,
                timestamp: Date.now(),
                data: data
            };
            
            // Store in multiple places for maximum reliability
            localStorage.setItem('smartLotteryLiveEvent', JSON.stringify(event));
            localStorage.setItem('smartLotteryGlobalUpdate', JSON.stringify({
                ...event,
                globalUpdate: true
            }));
            
            // Store in Firestore for cross-session persistence
            if (db) {
                db.collection('liveEvents').add({
                    ...event,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(error => console.error('Error storing live event:', error));
            }
            
            // Use BroadcastChannel for same-origin communication
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('smartLotteryChannel');
                channel.postMessage(event);
                setTimeout(() => channel.close(), 100);
            }
            
            // Multiple event dispatching for maximum coverage
            ['smartLotteryEvent', 'smartLotteryGlobalEvent', 'smartLotteryBroadcast'].forEach(eventName => {
                window.dispatchEvent(new CustomEvent(eventName, { detail: event }));
            });
            
            // Force immediate update
            setTimeout(() => {
                forceGlobalUpdate(event);
                handleLiveDrawEvent(event); // Handle locally too
            }, 50);
            
            // Additional delayed updates for reliability
            [200, 500, 1000].forEach(delay => {
                setTimeout(() => forceGlobalUpdate(event, true), delay);
            });
        }

        // Force global updates across all sessions
        function forceGlobalUpdate(event) {
            // Update localStorage with force flag
            localStorage.setItem('smartLotteryForceUpdate', JSON.stringify({
                ...event,
                forceUpdate: true,
                timestamp: Date.now()
            }));
            
            // Dispatch multiple events to ensure coverage
            ['smartLotteryForceUpdate', 'smartLotteryGlobalUpdate'].forEach(eventName => {
                window.dispatchEvent(new CustomEvent(eventName, { detail: event }));
            });
        }

        // Enhanced listener for live draw events with Firestore polling
        function initializeLiveDrawListener() {
            // BroadcastChannel listener
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('smartLotteryChannel');
                channel.addEventListener('message', function(e) {
                    console.log('BroadcastChannel event received:', e.data);
                    handleLiveDrawEvent(e.data);
                });
            }
            
            // Storage event listener for cross-tab
            window.addEventListener('storage', function(e) {
                if ((e.key === 'smartLotteryLiveEvent' || 
                     e.key === 'smartLotteryForceUpdate' || 
                     e.key === 'smartLotteryGlobalUpdate') && e.newValue) {
                    try {
                        const event = JSON.parse(e.newValue);
                        console.log('Storage event received:', event);
                        handleLiveDrawEvent(event);
                    } catch (error) {
                        console.error('Error parsing live draw event:', error);
                    }
                }
            });
            
            // Enhanced custom event listeners
            ['smartLotteryEvent', 'smartLotteryForceUpdate', 'smartLotteryGlobalUpdate', 'smartLotteryGlobalEvent', 'smartLotteryBroadcast'].forEach(eventName => {
                window.addEventListener(eventName, function(e) {
                    console.log('Custom event received:', eventName, e.detail);
                    if (e.detail) {
                        handleLiveDrawEvent(e.detail);
                    }
                });
            });
            
            // Check for recent events on page load
            checkForRecentEvents();
            
            // Firestore live event polling for cross-session updates
            if (db) {
                setInterval(checkFirestoreLiveEvents, 3000);
            }
            
            // More frequent local checking
            setInterval(checkForRecentEvents, 2000);
        }

        // Check Firestore for recent live events
        async function checkFirestoreLiveEvents() {
            try {
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const eventsSnapshot = await db.collection('liveEvents')
                    .where('createdAt', '>', fiveMinutesAgo)
                    .orderBy('createdAt', 'desc')
                    .limit(10)
                    .get();
                
                eventsSnapshot.forEach(doc => {
                    const eventData = doc.data();
                    if (eventData.timestamp && Date.now() - eventData.timestamp < 300000) { // 5 minutes
                        console.log('Firestore live event found:', eventData);
                        handleLiveDrawEvent(eventData);
                    }
                });
            } catch (error) {
                console.error('Error checking Firestore live events:', error);
            }
        }

        function checkForRecentEvents() {
            const savedEvent = localStorage.getItem('smartLotteryLiveEvent');
            const forceEvent = localStorage.getItem('smartLotteryForceUpdate');
            
            [savedEvent, forceEvent].forEach(eventData => {
                if (eventData) {
                    try {
                        const event = JSON.parse(eventData);
                        // Handle events within last 2 minutes
                        if (Date.now() - event.timestamp < 120000) {
                            handleLiveDrawEvent(event);
                        }
                    } catch (error) {
                        console.error('Error parsing saved event:', error);
                    }
                }
            });
        }

        function handleLiveDrawEvent(event) {
            // Create unique event identifier
            const eventKey = `${event.type}_${event.contestId}_${event.timestamp}`;
            
            // Check if we've already processed this exact event
            if (processedEvents.has(eventKey)) {
                console.log('Skipping duplicate event:', eventKey);
                return;
            }
            
            // Mark event as processed
            processedEvents.add(eventKey);
            
            // Clean up old processed events (keep last 50)
            if (processedEvents.size > 50) {
                const eventsArray = Array.from(processedEvents);
                eventsArray.slice(0, -50).forEach(oldEvent => processedEvents.delete(oldEvent));
            }
            
            // Additional timestamp-based duplicate check for draw_completed events
            if (event.type === 'draw_completed' || event.type === 'winners_updated') {
                const recentEventKey = `${event.type}_${event.contestId}`;
                const now = Date.now();
                
                if (lastWinnerUpdate[recentEventKey] && (now - lastWinnerUpdate[recentEventKey]) < 10000) {
                    console.log('Skipping recent duplicate draw event:', recentEventKey);
                    return;
                }
                
                lastWinnerUpdate[recentEventKey] = now;
            }
            
            // Ensure ALL users see draw events, regardless of admin status
            console.log('Handling live draw event:', event.type, 'for contest:', event.contestId);
            
            switch (event.type) {
                case 'draw_started':
                    const template = CONTEST_TEMPLATES.find(t => t.id === event.contestId);
                    if (template) {
                        showNotification(` Live draw started for ${template.title}! Results coming soon...`, 'info');
                    }
                    break;
                    
                case 'participant_joined':
                    // Update participant count globally
                    if (event.data.newCount && event.contestId) {
                        globalParticipantCounts[event.contestId] = event.data.newCount;
                        if (globalContestState[event.contestId]) {
                            globalContestState[event.contestId].participants = event.data.newCount;
                        }
                        // Refresh contest display
                        setTimeout(() => {
                            generateActiveContests();
                        }, 200);
                    }
                    break;
                    
                case 'contest_reset':
                    // Handle contest reset globally
                    if (event.contestId && event.data) {
                        globalParticipantCounts[event.contestId] = 0;
                        if (globalContestState[event.contestId]) {
                            globalContestState[event.contestId].participants = 0;
                            globalContestState[event.contestId].endTime = event.data.newEndTime;
                        }
                        saveGlobalContestState();
                        generateActiveContests();
                    }
                    break;
                    
                case 'draw_completed':
                    if (event.data.winningNumbers && event.data.winners) {
                        console.log('Processing draw completion event for:', event.contestId);
                        
                        // Store contest results if we have the full winner data
                        if (event.data.winners.length > 0) {
                            storeLastContestResults(event.contestId, event.data.winningNumbers, event.data.winners);
                        }
                        
                        // Show winners announcement
                        const template = CONTEST_TEMPLATES.find(t => t.id === event.contestId);
                        if (template) {
                            setTimeout(() => {
                                showWinnersAnnouncement(event.contestId, event.data.winningNumbers, event.data.winners);
                            }, 500);
                        }
                        
                        // Update winners immediately
                        if (event.data.winners && Array.isArray(event.data.winners)) {
                            const newWinners = event.data.winners.map(winner => ({
                                name: winner.userName || winner.name,
                                contest: CONTEST_TEMPLATES.find(t => t.id === event.contestId)?.title || 'Contest',
                                prize: winner.prize,
                                date: 'Just now',
                                rank: winner.rank,
                                isBot: winner.isBot || false,
                                prizePosition: winner.prizePosition
                            }));
                            
                            // Add to beginning of winners list
                            sampleWinners.splice(0, 0, ...newWinners);
                            if (sampleWinners.length > 100) {
                                sampleWinners.splice(100);
                            }
                            
                            // Save and update display
                            const winnersJson = JSON.stringify(sampleWinners);
                            localStorage.setItem('smartLotteryWinners', winnersJson);
                            localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
                            
                            // Force update winners display
                            loadWinners();
                        }
                        
                        // Force refresh current winners display immediately
                        setTimeout(() => {
                            loadCurrentWinners();
                        }, 1000);
                        
                        // Update user profile and contests if logged in
                        if (currentUser) {
                            setTimeout(async () => {
                                try {
                                    await loadUserData(currentUser);
                                    updateBalanceDisplay();
                                    updateProfile();
                                    loadJoinedContests();
                                } catch (error) {
                                    console.error('Error updating user data after draw:', error);
                                }
                            }, 2000);
                        }
                        
                        // Refresh contests display
                        setTimeout(() => {
                            generateActiveContests();
                        }, 1000);
                        
                        // Show completion notification
                        showNotification(` Draw completed! Check Current Results in Winners tab for latest results.`, 'success');
                    }
                    break;
                    
                case 'winners_updated':
                case 'global_winners_update':
                    if (event.data.winners) {
                        // Update local winners list with better merging
                        if (Array.isArray(event.data.winners)) {
                            // Add new winners to the beginning with timestamp check
                            const newWinners = event.data.winners.filter(newWinner => 
                                !sampleWinners.some(existing => 
                                    existing.name === newWinner.name && 
                                    existing.contest === newWinner.contest &&
                                    Math.abs(new Date(existing.date) - new Date(newWinner.date)) < 60000 // Within 1 minute
                                )
                            );
                            
                            if (newWinners.length > 0) {
                                sampleWinners.splice(0, 0, ...newWinners);
                                
                                if (sampleWinners.length > 100) {
                                    sampleWinners.splice(100);
                                }
                                
                                // Save to multiple locations
                                const winnersJson = JSON.stringify(sampleWinners);
                                localStorage.setItem('smartLotteryWinners', winnersJson);
                                localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
                                localStorage.setItem('smartLotteryAllWinners', winnersJson);
                                
                                // Force update winners display
                                setTimeout(() => {
                                    loadWinners();
                                    if (newWinners.length > 0) {
                                        showNotification(` ${newWinners.length} new winners announced! Check Winners tab.`, 'success');
                                    }
                                }, 500);
                            }
                        }
                    }
                    break;
                    
                case 'contest_ended':
                case 'profiles_updated':
                    // Handle contest ending globally and profile updates
                    if (currentUser) {
                        setTimeout(async () => {
                            try {
                                await loadUserData(currentUser);
                                updateBalanceDisplay();
                                updateProfile();
                                loadJoinedContests();
                                
                                // Refresh transactions to show any new winnings
                                loadTransactions();
                                
                                console.log('Profile updated after contest completion');
                            } catch (error) {
                                console.error('Error updating profile after contest:', error);
                            }
                        }, 2000);
                    }
                    break;
            }
        }

        function getNextDrawTime(template) {
            const now = new Date();
            
            // Special handling for instant fill contest (until full)
            if (template.id === 'instant_25') {
                return new Date(2030, 0, 1); // Far future date to show "Until Full"
            }
            
            let nextDraw = new Date();
            
            // Set the draw time based on template schedule
            switch(template.id) {
                case 'daily_40k':
                case 'daily_1l':
                    // Daily at 18:00 (6 PM)
                    nextDraw.setHours(18, 0, 0, 0);
                    if (now.getHours() >= 18) {
                        nextDraw.setDate(nextDraw.getDate() + 1);
                    }
                    break;
                    
                case 'bi_daily_3l':
                    // Every 2 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextBiDailyDay = Math.ceil((daysSinceEpoch + 1) / 2) * 2;
                    nextDraw = new Date((nextBiDailyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                case 'tri_daily_5l':
                    // Every 3 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch3 = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextTriDailyDay = Math.ceil((daysSinceEpoch3 + 1) / 3) * 3;
                    nextDraw = new Date((nextTriDailyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                case 'quad_daily_10l':
                    // Every 4 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch4 = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextQuadDailyDay = Math.ceil((daysSinceEpoch4 + 1) / 4) * 4;
                    nextDraw = new Date((nextQuadDailyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                case 'penta_daily_25l':
                    // Every 5 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch5 = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextPentaDailyDay = Math.ceil((daysSinceEpoch5 + 1) / 5) * 5;
                    nextDraw = new Date((nextPentaDailyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                case 'hexa_daily_60l':
                    // Every 6 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch6 = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextHexaDailyDay = Math.ceil((daysSinceEpoch6 + 1) / 6) * 6;
                    nextDraw = new Date((nextHexaDailyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                case 'weekly_1cr':
                    // Every 7 days at 18:00
                    nextDraw.setHours(18, 0, 0, 0);
                    const daysSinceEpoch7 = Math.floor(now.getTime() / (1000 * 60 * 60 * 24));
                    const nextWeeklyDay = Math.ceil((daysSinceEpoch7 + 1) / 7) * 7;
                    nextDraw = new Date((nextWeeklyDay * 24 * 60 * 60 * 1000));
                    nextDraw.setHours(18, 0, 0, 0);
                    break;
                    
                default:
                    // Default to next hour
                    nextDraw.setHours(nextDraw.getHours() + 1, 0, 0, 0);
            }
            
            return nextDraw;
        }

        // Contest templates with exact timeline requirements
        const CONTEST_TEMPLATES = [
            {
                id: 'instant_25',
                title: '25 Rupees Instant Fill',
                entryFee: 25,
                maxParticipants: 40000,
                prizePool: 1000000,
                drawTime: 'Until Full',
                description: 'Win 10 Lakh when contest fills up!',
                prizeStructure: [
                    { position: '1st Prize', amount: 500000, percentage: '50%' },
                    { position: '2nd Prize', amount: 250000, percentage: '25%' },
                    { position: '3rd Prize', amount: 100000, percentage: '10%' },
                    { position: '4th-53rd Prize', amount: 3000, percentage: '15%', count: 50 }
                ]
            },
            {
                id: 'daily_40k',
                title: 'Daily 40K Express',
                entryFee: 50,
                maxParticipants: 800,
                prizePool: 40000,
                drawTime: '18:00',
                description: 'Daily lottery at 6 PM with 40K prize pool',
                prizeStructure: [
                    { position: '1st Prize', amount: 20000, percentage: '50%' },
                    { position: '2nd Prize', amount: 10000, percentage: '25%' },
                    { position: '3rd Prize', amount: 4000, percentage: '10%' },
                    { position: '4th-23rd Prize', amount: 300, percentage: '15%', count: 20 }
                ]
            },
            {
                id: 'daily_1l',
                title: 'Daily 1 Lakh Special',
                entryFee: 100,
                maxParticipants: 1000,
                prizePool: 100000,
                drawTime: '18:00',
                description: '1 Lakh daily jackpot at 6 PM every day',
                prizeStructure: [
                    { position: '1st Prize', amount: 50000, percentage: '50%' },
                    { position: '2nd Prize', amount: 25000, percentage: '25%' },
                    { position: '3rd Prize', amount: 10000, percentage: '10%' },
                    { position: '4th-33rd Prize', amount: 500, percentage: '15%', count: 30 }
                ]
            },
            {
                id: 'bi_daily_3l',
                title: '3 Lakh Bi-Daily',
                entryFee: 150,
                maxParticipants: 2000,
                prizePool: 300000,
                drawTime: '18:00',
                description: 'Win up to 3 Lakhs every 2 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 150000, percentage: '50%' },
                    { position: '2nd Prize', amount: 75000, percentage: '25%' },
                    { position: '3rd Prize', amount: 30000, percentage: '10%' },
                    { position: '4th-48th Prize', amount: 1000, percentage: '15%', count: 45 }
                ]
            },
            {
                id: 'tri_daily_5l',
                title: '5 Lakh Tri-Daily',
                entryFee: 200,
                maxParticipants: 2500,
                prizePool: 500000,
                drawTime: '18:00',
                description: 'Win up to 5 LAKHS every 3 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 250000, percentage: '50%' },
                    { position: '2nd Prize', amount: 125000, percentage: '25%' },
                    { position: '3rd Prize', amount: 50000, percentage: '10%' },
                    { position: '4th-103rd Prize', amount: 750, percentage: '15%', count: 100 }
                ]
            },
            {
                id: 'quad_daily_10l',
                title: '10 Lakh Quad-Daily',
                entryFee: 300,
                maxParticipants: 3333,
                prizePool: 1000000,
                drawTime: '18:00',
                description: 'Mega 10 Lakh jackpot every 4 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 500000, percentage: '50%' },
                    { position: '2nd Prize', amount: 250000, percentage: '25%' },
                    { position: '3rd Prize', amount: 100000, percentage: '10%' },
                    { position: '4th-103rd Prize', amount: 1500, percentage: '15%', count: 100 }
                ]
            },
            {
                id: 'penta_daily_25l',
                title: '25 Lakh Penta-Daily',
                entryFee: 500,
                maxParticipants: 5000,
                prizePool: 2500000,
                drawTime: '18:00',
                description: 'Special 25 Lakh lottery every 5 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 1250000, percentage: '50%' },
                    { position: '2nd Prize', amount: 625000, percentage: '25%' },
                    { position: '3rd Prize', amount: 250000, percentage: '10%' },
                    { position: '4th-103rd Prize', amount: 3500, percentage: '15%', count: 100 }
                ]
            },
            {
                id: 'hexa_daily_60l',
                title: '60 Lakh Hexa-Daily',
                entryFee: 750,
                maxParticipants: 8000,
                prizePool: 6000000,
                drawTime: '18:00',
                description: '60 Lakh mega draw every 6 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 3000000, percentage: '50%' },
                    { position: '2nd Prize', amount: 1500000, percentage: '25%' },
                    { position: '3rd Prize', amount: 600000, percentage: '10%' },
                    { position: '4th-103rd Prize', amount: 9000, percentage: '15%', count: 100 }
                ]
            },
            {
                id: 'weekly_1cr',
                title: '1 Crore Weekly Elite',
                entryFee: 1000,
                maxParticipants: 10000,
                prizePool: 10000000,
                drawTime: '18:00',
                description: 'Elite 1 CRORE lottery every 7 days at 6 PM',
                prizeStructure: [
                    { position: '1st Prize', amount: 5000000, percentage: '50%' },
                    { position: '2nd Prize', amount: 2500000, percentage: '25%' },
                    { position: '3rd Prize', amount: 1000000, percentage: '10%' },
                    { position: '4th-103rd Prize', amount: 15000, percentage: '15%', count: 100 }
                ]
            }
        ];

        // Function to generate random bot names
        function getBotName() {
            const botNames = [
                'Raj Kumar', 'Anita Sharma', 'Vikash Singh', 'Priya Patel', 'Rohit Gupta',
                'Sneha Verma', 'Amit Kumar', 'Kavya Reddy', 'Suresh Yadav', 'Meera Joshi',
                'Ravi Nair', 'Pooja Agarwal', 'Deepak Singh', 'Anjali Mishra', 'Sanjay Sharma',
                'Nisha Gupta', 'Manoj Kumar', 'Rekha Devi', 'Ashok Yadav', 'Sunita Singh',
                'Ramesh Patel', 'Geeta Sharma', 'Vinod Kumar', 'Kiran Agarwal', 'Mukesh Gupta',
                'Shanti Devi', 'Naresh Singh', 'Radha Verma', 'Sunil Kumar', 'Mamta Sharma',
                'Prakash Yadav', 'Usha Gupta', 'Rajesh Patel', 'Savita Singh', 'Dinesh Kumar',
                'Kamala Devi', 'Bharat Singh', 'Lata Sharma', 'Arun Kumar', 'Sangeeta Verma',
                'Mohan Gupta', 'Pushpa Devi', 'Subhash Singh', 'Manju Sharma', 'Jagdish Kumar',
                'Sunita Patel', 'Ramesh Yadav', 'Sudha Verma', 'Shyam Singh', 'Asha Gupta'
            ];
            return botNames[Math.floor(Math.random() * botNames.length)];
        }

        // Function to get user-friendly error messages
        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters long.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                case 'auth/too-many-requests':
                    return 'Too many failed attempts. Please try again later.';
                case 'auth/network-request-failed':
                    return 'Network error. Please check your connection.';
                default:
                    return error.message || 'An error occurred. Please try again.';
            }
        }

        // Sample winners data with Indian names
        let sampleWinners = [
            { name: 'Arjun Malhotra', contest: '1 Crore Elite', prize: 5000000, date: '1 hour ago' },
            { name: 'Sneha Patel', contest: '60 Lakh Special', prize: 3000000, date: '3 hours ago' },
            { name: 'Vikram Singh', contest: '25 Lakh Quad-Daily', prize: 1250000, date: '6 hours ago' },
            { name: 'Ananya Sharma', contest: '10 Lakh Tri-Daily', prize: 500000, date: '12 hours ago' },
            { name: 'Rohit Kumar', contest: '5 Lakh Tri-Daily', prize: 250000, date: '1 day ago' },
            { name: 'Pooja Reddy', contest: '3 Lakh Bi-Daily', prize: 150000, date: '1 day ago' },
            { name: 'Suresh Gupta', contest: 'Daily 1 Lakh Special', prize: 50000, date: '2 days ago' },
            { name: 'Meera Joshi', contest: 'Daily 40K Express', prize: 20000, date: '2 days ago' },
            { name: 'Kiran Agarwal', contest: '1 Crore Elite', prize: 2500000, date: '3 days ago' },
            { name: 'Ravi Nair', contest: '60 Lakh Special', prize: 1500000, date: '3 days ago' },
            { name: 'Kavya Menon', contest: '25 Lakh Quad-Daily', prize: 625000, date: '4 days ago' },
            { name: 'Deepak Yadav', contest: '10 Lakh Tri-Daily', prize: 250000, date: '4 days ago' }
        ];

        // Initialize application with enhanced Firebase integration
        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Initializing Smart Lottery System...');
            
            // Initialize EmailJS
            initializeEmailJS();
            
            initializeApp();
            initializeQuoteCarousel();
            initializeSampleWinners(); // Initialize sample winners first
            
            // Load Firebase data and set up real-time listeners
            initializeGlobalContestState().then(() => {
                loadWinnersFromFirestore(); // Load winners from Firebase
                setupWinnersListener(); // Set up real-time winner updates
                initializeAutoDeclarationTimers(); // Initialize auto-declaration timers after contest state is loaded
            });
            
            initializeLiveDrawListener(); // Initialize live draw event listener
            
            // Periodic sync with Firestore every 30 seconds
            setInterval(() => {
                if (db) {
                    loadWinnersFromFirestore();
                    loadRealParticipantCounts();
                }
            }, 30000);
            
            // Monitor auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    loadUserData(user).then(() => {
                        showUserDashboard();
                        loadJoinedContests(); // Ensure joined contests are loaded after user data
                        
                        // Load winners again after user login
                        setTimeout(() => {
                            loadWinnersFromFirestore();
                        }, 1000);
                        
                        // Initialize auto-declaration timers for admin users
                        if (ADMIN_EMAILS.includes(user.email.toLowerCase())) {
                            setTimeout(() => {
                                initializeAutoDeclarationTimers();
                            }, 2000);
                        }
                    });
                } else {
                    currentUser = null;
                    // Still load winners for non-logged-in users
                    loadWinnersFromFirestore();
                }
            });
            
            console.log(' Smart Lottery System initialization complete');
        });

        function initializeApp() {
            // Terms and Conditions handling
            document.getElementById('acceptTerms').addEventListener('change', function() {
                document.getElementById('proceedBtn').disabled = !this.checked;
            });

            // Update live stats periodically
            setInterval(updateLiveStats, 5000);
        }

        function showAuth() {
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
        }

        function initializeQuoteCarousel() {
            const quotes = document.querySelectorAll('.quote-item');
            let currentQuote = 0;

            setInterval(() => {
                quotes[currentQuote].classList.remove('active');
                currentQuote = (currentQuote + 1) % quotes.length;
                quotes[currentQuote].classList.add('active');
            }, 4000);
        }

        function proceedToAuth() {
            document.getElementById('termsAgreement').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function toggleAuthForm(formType) {
            document.getElementById('loginForm').style.display = formType === 'login' ? 'block' : 'none';
            document.getElementById('signupForm').style.display = formType === 'signup' ? 'block' : 'none';
            
            // Reset signup form if switching away from signup
            if (formType === 'login') {
                resetSignupForm();
            }
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const icon = input.nextElementSibling.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.replace('fa-eye', 'fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.replace('fa-eye-slash', 'fa-eye');
            }
        }

        function showAuth() {
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                showNotification('Welcome back! Login successful.', 'success');
            } catch (error) {
                showNotification(getFirebaseErrorMessage(error), 'error');
            }
        }

        function showEmailVerificationPrompt() {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-envelope-check"></i> Email Verification Required</h2>
                    </div>
                    <div class="modal-body">
                        <div style="text-align: center; padding: 20px;">
                            <div style="font-size: 4rem; color: var(--primary); margin-bottom: 20px;">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <h3 style="color: var(--text); margin-bottom: 16px;">Check Your Email</h3>
                            <p style="color: var(--text-light); margin-bottom: 30px; line-height: 1.6;">
                                We've sent a verification link to your email address. Please click the link to verify your account and access all features of Smart Lottery.
                            </p>
                            <div style="display: flex; flex-direction: column; gap: 16px;">
                                <button class="btn btn-primary" onclick="resendVerificationEmail()">
                                    <i class="fas fa-paper-plane"></i> Resend Verification Email
                                </button>
                                <button class="btn btn-outline" onclick="checkEmailVerification()">
                                    <i class="fas fa-check"></i> I've Verified My Email
                                </button>
                                <button class="btn btn-secondary" onclick="closeEmailVerificationModal()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <div style="margin-top: 20px; padding: 16px; background: rgba(25, 118, 210, 0.1); border-radius: var(--radius); color: var(--text-light);">
                                <p style="margin: 0; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> Don't see the email? Check your spam folder or contact support.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function resendVerificationEmail() {
            try {
                const user = auth.currentUser;
                if (user && !user.emailVerified) {
                    await user.sendEmailVerification({
                        url: window.location.origin,
                        handleCodeInApp: false
                    });
                    showNotification('Verification email resent! Please check your inbox.', 'success');
                } else {
                    showNotification('No user found or email already verified.', 'info');
                }
            } catch (error) {
                showNotification('Error sending verification email: ' + error.message, 'error');
            }
        }

        async function checkEmailVerification() {
            try {
                const user = auth.currentUser;
                if (user) {
                    await user.reload();
                    if (user.emailVerified) {
                        // Update user document in Firestore
                        await db.collection('users').doc(user.uid).update({
                            emailVerified: true
                        });
                        
                        closeEmailVerificationModal();
                        showNotification('Email verified successfully! Welcome to Smart Lottery!', 'success');
                        
                        // Proceed to dashboard if this was during login
                        if (currentUser) {
                            showUserDashboard();
                        }
                    } else {
                        showNotification('Email not yet verified. Please check your inbox and click the verification link.', 'warning');
                    }
                }
            } catch (error) {
                showNotification('Error checking verification status: ' + error.message, 'error');
            }
        }

        function closeEmailVerificationModal() {
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
            }
        }

        // Function to generate OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Function to send OTP via EmailJS
        async function sendOTPEmail(email, name, otp) {
            try {
                if (!emailjsInitialized) {
                    initializeEmailJS();
                }

                const templateParams = {
                    to_email: email,
                    user_name: name,
                    otp_code: otp,
                    app_name: 'Smart Lottery'
                };

                await emailjs.send(
                    EMAILJS_CONFIG.serviceId,
                    EMAILJS_CONFIG.templateId,
                    templateParams,
                    EMAILJS_CONFIG.userId
                );

                console.log('OTP email sent successfully');
                return true;
            } catch (error) {
                console.error('Error sending OTP email:', error);
                throw error;
            }
        }

        async function handleSignup(event) {
            event.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const referralCode = document.getElementById('signupReferral').value;
            
            try {
                // Generate OTP
                currentOTP = generateOTP();
                
                // Store signup data temporarily
                window.tempSignupData = {
                    name: name,
                    email: email,
                    password: password,
                    referralCode: referralCode
                };
                
                // Send OTP via EmailJS
                await sendOTPEmail(email, name, currentOTP);
                
                // Hide signup form and show OTP verification
                document.querySelector('#signupForm form').style.display = 'none';
                document.getElementById('otpVerificationSection').style.display = 'block';
                
                showNotification('OTP sent to your email! Please check your inbox and enter the 6-digit code.', 'success');
                
                // Set OTP expiry (10 minutes)
                setTimeout(() => {
                    currentOTP = '';
                    showNotification('OTP expired. Please try signing up again.', 'warning');
                    resetSignupForm();
                }, 10 * 60 * 1000);
                
            } catch (error) {
                showNotification('Error sending OTP: ' + error.message, 'error');
            }
        }

        // Function to verify OTP
        async function verifyOTP() {
            const enteredOTP = document.getElementById('otpInput').value;
            
            if (!enteredOTP) {
                showNotification('Please enter the OTP.', 'warning');
                return;
            }
            
            if (enteredOTP !== currentOTP) {
                showNotification('Invalid OTP. Please try again.', 'error');
                return;
            }
            
            if (!currentOTP) {
                showNotification('OTP expired. Please sign up again.', 'warning');
                resetSignupForm();
                return;
            }
            
            try {
                const signupData = window.tempSignupData;
                
                // Create Firebase account
                const userCredential = await auth.createUserWithEmailAndPassword(signupData.email, signupData.password);
                const user = userCredential.user;
                
                // Generate unique referral code
                const newReferralCode = 'SL' + user.uid.substr(0, 6).toUpperCase();
                
                // Create user document in Firestore
                await db.collection('users').doc(user.uid).set({
                    displayName: signupData.name,
                    email: signupData.email,
                    balance: 0,
                    referralCode: newReferralCode,
                    referredBy: signupData.referralCode || null,
                    referralEarnings: 0,
                    contestsJoined: 0,
                    contestsWon: 0,
                    totalWinnings: 0,
                    joinedContests: [],
                    emailVerified: true, // Mark as verified since OTP was confirmed
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update profile
                await user.updateProfile({
                    displayName: signupData.name
                });
                
                // Clear temporary data
                currentOTP = '';
                window.tempSignupData = null;
                
                showNotification('Account created and verified successfully! Welcome to Smart Lottery!', 'success');
                
                // Auto-login the user
                currentUser = user;
                
            } catch (error) {
                showNotification('Error creating account: ' + getFirebaseErrorMessage(error), 'error');
            }
        }

        // Function to resend OTP
        async function resendOTP() {
            if (!window.tempSignupData) {
                showNotification('Please restart the signup process.', 'warning');
                resetSignupForm();
                return;
            }
            
            try {
                currentOTP = generateOTP();
                await sendOTPEmail(window.tempSignupData.email, window.tempSignupData.name, currentOTP);
                showNotification('New OTP sent to your email!', 'success');
                
                // Reset expiry timer
                setTimeout(() => {
                    currentOTP = '';
                    showNotification('OTP expired. Please try signing up again.', 'warning');
                    resetSignupForm();
                }, 10 * 60 * 1000);
                
            } catch (error) {
                showNotification('Error resending OTP: ' + error.message, 'error');
            }
        }

        // Function to reset signup form
        function resetSignupForm() {
            document.querySelector('#signupForm form').style.display = 'block';
            document.getElementById('otpVerificationSection').style.display = 'none';
            document.getElementById('otpInput').value = '';
            currentOTP = '';
            window.tempSignupData = null;
        }

        async function loadUserData(user) {
            try {
                const userDoc = await db.collection('users').doc(user.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    userBalance = userData.balance || 0;
                    userReferralCode = userData.referralCode || 'SL' + user.uid.substr(0, 6).toUpperCase();
                    userProfile = {
                        contestsJoined: userData.contestsJoined || 0,
                        contestsWon: userData.contestsWon || 0,
                        totalWinnings: userData.totalWinnings || 0
                    };
                    referralData = {
                        earnings: userData.referralEarnings || 0,
                        referredUsers: userData.referredUsers || [],
                        pendingReferrals: userData.pendingReferrals || 0
                    };
                    
                    // Load joined contests from user data
                    joinedContests = userData.joinedContests || [];
                    
                    // Update email verification status in Firestore if needed
                    if (!userData.emailVerified && user.emailVerified) {
                        await db.collection('users').doc(user.uid).update({
                            emailVerified: true
                        });
                    }
                    
                    // Check if user is admin
                    isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
                    console.log('Admin check - User email:', user.email, 'Is admin:', isAdmin);
                    if (isAdmin) {
                        document.getElementById('adminTab').style.display = 'block';
                        console.log('Admin tab enabled for user:', user.email);
                        showNotification(' Admin access granted! You can manage contests and approvals.', 'info');
                    }

                    // Process referral bonus if user was referred
                    if (userData.referredBy && !userData.referralProcessed) {
                        await processReferralSignup(userData.referredBy, user.uid);
                    }
                } else {
                    // Create user document if it doesn't exist
                    const newReferralCode = 'SL' + user.uid.substr(0, 6).toUpperCase();
                    await db.collection('users').doc(user.uid).set({
                        displayName: user.displayName || 'Smart Player',
                        email: user.email,
                        balance: 0,
                        referralCode: newReferralCode,
                        referredBy: null,
                        referralEarnings: 0,
                        contestsJoined: 0,
                        contestsWon: 0,
                        totalWinnings: 0,
                        joinedContests: [],
                        referralProcessed: false,
                        emailVerified: user.emailVerified,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    userReferralCode = newReferralCode;
                    isAdmin = ADMIN_EMAILS.includes(user.email.toLowerCase());
                    if (isAdmin) {
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading user data:', error);
                showNotification('Error loading user data. Please refresh the page.', 'error');
            }
        }

        async function processReferralSignup(referralCode, newUserId) {
            try {
                // Find the referrer
                const usersSnapshot = await db.collection('users')
                    .where('referralCode', '==', referralCode)
                    .get();
                
                if (!usersSnapshot.empty) {
                    const referrerDoc = usersSnapshot.docs[0];
                    const referrerId = referrerDoc.id;
                    
                    // Mark referral as processed for the new user
                    await db.collection('users').doc(newUserId).update({
                        referralProcessed: true
                    });
                    
                    console.log('Referral signup processed for:', referralCode);
                }
            } catch (error) {
                console.error('Error processing referral signup:', error);
            }
        }

        function showUserDashboard() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('landingSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'block';
            
            // Show floating chat button
            document.getElementById('floatingChatBtn').classList.add('show');
            
            // Update user info with proper balance display
            document.getElementById('userDisplayName').textContent = currentUser.displayName || 'Smart Player';
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('userAvatar').textContent = (currentUser.displayName || 'U').charAt(0).toUpperCase();
            updateBalanceDisplay();
            
            // Show admin status if applicable
            if (isAdmin) {
                document.getElementById('adminApprovalSection').style.display = 'block';
                showNotification('Admin access granted! You can approve deposits and withdrawals in the Withdraw tab.', 'info');
                console.log('Admin user logged in:', currentUser.email);
            }
            
            // Initialize dashboard
            generateActiveContests();
            loadWinners();
            loadTransactions();
            updateProfile();
            loadReferrals();
            loadJoinedContests();
            
            // Ensure winners are loaded and visible
            setTimeout(() => {
                loadWinners();
            }, 1000);
            
            if (isAdmin) {
                loadAdminApprovals();
            }
        }

        function updateBalanceDisplay() {
            document.getElementById('userBalance').textContent = '' + formatIndianCurrency(userBalance);
        }

        async function handleLogout() {
            try {
                await auth.signOut();
                // Hide floating chat button
                document.getElementById('floatingChatBtn').classList.remove('show');
                // Reset state
                currentUser = null;
                userBalance = 0;
                isAdmin = false;
                userProfile = { contestsJoined: 0, contestsWon: 0, totalWinnings: 0 };
                transactions = [];
                joinedContests = [];
                // Show landing page
                document.getElementById('userSection').style.display = 'none';
                document.getElementById('landingSection').style.display = 'block';
                showNotification('Logged out successfully!', 'info');
            } catch (error) {
                showNotification('Error logging out', 'error');
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to selected tab button
            event.target.classList.add('active');
            
            // Load tab-specific content
            switch(tabName) {
                case 'contests':
                    generateActiveContests();
                    break;
                case 'joinedContests':
                    loadJoinedContests();
                    break;
                case 'winners':
                    // Initialize with current winners tab
                    switchWinnersTab('current');
                    break;
                case 'transactions':
                    loadTransactions();
                    break;
                case 'profile':
                    updateProfile();
                    break;
                case 'referrals':
                    loadReferrals();
                    break;
                case 'withdrawal':
                    if (isAdmin) {
                        loadAdminApprovals();
                    }
                    break;
                case 'admin':
                    if (isAdmin) {
                        loadAdminStats();
                    }
                    break;
            }
        }

        function generateActiveContests() {
            const contestGrid = document.getElementById('contestGrid');
            contestGrid.innerHTML = '';
            
            // Clear existing contests
            activeContests = [];
            
            CONTEST_TEMPLATES.forEach((template, index) => {
                try {
                    // Ensure global state exists with realistic progression
                    if (!globalContestState[template.id] || !globalContestState[template.id].endTime) {
                        const endTime = getNextDrawTime(template);
                        globalContestState[template.id] = {
                            ...template,
                            endTime: endTime,
                            participants: calculateRealisticParticipantCount(template, endTime),
                            startTime: new Date(),
                            initialParticipants: Math.floor(template.maxParticipants * 0.15)
                        };
                    } else {
                        // Update participant count based on current time with safety check
                        const endTime = globalContestState[template.id].endTime;
                        if (endTime) {
                            globalContestState[template.id].participants = calculateRealisticParticipantCount(template, new Date(endTime));
                        }
                    }
                
                // Use consistent participant count from global state
                    const contest = {
                        id: template.id + '_' + Date.now() + '_' + index,
                        templateId: template.id, // Add explicit template ID reference
                        ...globalContestState[template.id],
                        participants: globalParticipantCounts[template.id] || globalContestState[template.id].participants
                    };
                    
                    activeContests.push(contest);
                    
                    const contestCard = createContestCard(contest);
                    contestGrid.appendChild(contestCard);
                } catch (error) {
                    console.error('Error creating contest for template:', template.id, error);
                    // Continue with next template instead of breaking the entire process
                }
            });
            
            saveGlobalContestState();
        }

        function createContestCard(contest) {
            const card = document.createElement('div');
            card.className = 'contest-card';
            
            const progressPercentage = (contest.participants / contest.maxParticipants) * 100;
            const timeLeft = getTimeLeft(contest.endTime, contest.id);
            
            card.innerHTML = `
                <div class="contest-title">
                    <i class="fas fa-trophy"></i>
                    ${contest.title}
                </div>
                <div class="contest-prize">
                    <span class="rupee-symbol"></span>
                    ${formatIndianCurrency(contest.prizePool, true)}
                </div>
                <div class="contest-details">
                    <div class="detail-row">
                        <span class="detail-label">
                            <i class="fas fa-ticket-alt"></i> Entry Fee
                        </span>
                        <span class="detail-value">${contest.entryFee}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">
                            <i class="fas fa-users"></i> Participants
                        </span>
                        <span class="detail-value">${contest.participants}/${contest.maxParticipants}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">
                            <i class="fas fa-clock"></i> Time Left
                        </span>
                        <span class="detail-value time-left">${timeLeft}</span>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                </div>
                <div class="prize-distribution">
                    <div class="prize-toggle" onclick="togglePrizeDetails('${contest.id}')">
                        <span><i class="fas fa-gift"></i> Prize Distribution</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="prize-details" id="prizes_${contest.id}">
                        ${contest.prizeStructure.slice(0, 3).map(prize => `
                            <div class="prize-item">
                                <span class="prize-position">${prize.position}</span>
                                <span class="prize-amount">${formatIndianCurrency(prize.amount)}</span>
                            </div>
                        `).join('')}
                        ${contest.prizeStructure[3] ? `
                            <div class="prize-item" style="cursor: pointer; background: rgba(16, 185, 129, 0.1); border-radius: 8px; padding: 12px; margin: 4px 0;" onclick="toggleConsolationPrizes('${contest.id}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span class="prize-position">${contest.prizeStructure[3].position}</span>
                                        <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 2px;">Click to view all consolation prizes</div>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="prize-amount">${formatIndianCurrency(contest.prizeStructure[3].amount)}</span>
                                        <i class="fas fa-chevron-down" id="consolation-toggle-${contest.id}" style="transition: transform 0.3s;"></i>
                                    </div>
                                </div>
                                <div id="consolation-prizes-${contest.id}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="color: var(--text-light); font-size: 0.9rem; text-align: center;">
                                        <strong>All Consolation Prize Winners (${contest.prizeStructure[3].count || 30} winners)</strong><br>
                                        Each winner receives ${formatIndianCurrency(contest.prizeStructure[3].amount)}<br>
                                        Total consolation prizes: ${formatIndianCurrency(contest.prizeStructure[3].amount * (contest.prizeStructure[3].count || 30))}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
                <button class="btn btn-primary btn-full" onclick="joinContest('${contest.id}')">
                    <i class="fas fa-play"></i> Join Contest - ${contest.entryFee}
                </button>
            `;
            
            return card;
        }

        // Format numbers in Indian system (e.g., 2,00,000 instead of 200K)
        function formatIndianCurrency(amount, short = false) {
            if (short && amount >= 10000000) {
                // For crores
                return (amount / 10000000).toFixed(1) + ' Cr';
            } else if (short && amount >= 100000) {
                // For lakhs
                return (amount / 100000).toFixed(1) + 'L';
            } else {
                // Standard Indian numbering with commas
                return amount.toLocaleString('en-IN');
            }
        }

        function getTimeLeft(endTime, contestId) {
            // Special handling for instant fill contest
            if (contestId && contestId.startsWith('instant_25')) {
                return 'Until Full';
            }
            
            const now = new Date();
            let targetTime;
            
            // Handle different endTime formats more robustly
            if (endTime instanceof Date) {
                targetTime = endTime;
            } else if (typeof endTime === 'string') {
                targetTime = new Date(endTime);
            } else if (endTime && typeof endTime === 'object' && endTime.toDate) {
                // Firebase Timestamp
                targetTime = endTime.toDate();
            } else {
                // Fallback: get proper time from template
                const template = CONTEST_TEMPLATES.find(t => contestId && contestId.startsWith(t.id));
                if (template) {
                    targetTime = getNextDrawTime(template);
                } else {
                    return 'Draw Soon';
                }
            }
            
            // Validate the target time
            if (!targetTime || isNaN(targetTime.getTime())) {
                const template = CONTEST_TEMPLATES.find(t => contestId && contestId.startsWith(t.id));
                if (template) {
                    targetTime = getNextDrawTime(template);
                } else {
                    return 'Draw Soon';
                }
            }
            
            const diff = targetTime.getTime() - now.getTime();
            
            if (diff <= 0) return 'Draw in Progress...';
            
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            if (days > 0) {
                return `${days}d ${hours}h ${minutes}m`;
            } else if (hours > 0) {
                return `${hours}h ${minutes}m`;
            } else {
                return `${minutes}m ${seconds}s`;
            }
        }

        // Update countdown timers and participant counts every second
        function updateCountdowns() {
            const contestCards = document.querySelectorAll('.contest-card');
            
            contestCards.forEach((card, index) => {
                const contest = activeContests[index];
                if (contest) {
                    const template = CONTEST_TEMPLATES.find(t => contest.id.startsWith(t.id));
                    if (template && globalContestState[template.id]) {
                        const currentEndTime = new Date(globalContestState[template.id].endTime);
                        const now = new Date();
                        
                        // Update participant count with realistic progression
                        const newParticipantCount = calculateRealisticParticipantCount(template, currentEndTime);
                        if (globalContestState[template.id].participants !== newParticipantCount) {
                            globalContestState[template.id].participants = newParticipantCount;
                            globalParticipantCounts[template.id] = newParticipantCount;
                            
                            // Update participant display in card
                            const participantElement = card.querySelector('.detail-value');
                            if (participantElement && participantElement.textContent.includes('/')) {
                                participantElement.textContent = `${newParticipantCount}/${template.maxParticipants}`;
                            }
                            
                            // Update progress bar
                            const progressBar = card.querySelector('.progress-fill');
                            if (progressBar) {
                                const progressPercentage = (newParticipantCount / template.maxParticipants) * 100;
                                progressBar.style.width = `${progressPercentage}%`;
                            }
                        }
                        
                        // Check if contest expired and needs auto-declaration (only for admin)
                        if (currentEndTime <= now && isAdmin) {
                            const autoKey = `auto_declared_${template.id}`;
                            const lastDeclared = lastWinnerUpdate[autoKey] || 0;
                            
                            // Only trigger if not declared in the last 5 minutes
                            if ((now.getTime() - lastDeclared) > 300000) {
                                console.log('Auto-triggering contest end for:', template.title);
                                lastWinnerUpdate[autoKey] = now.getTime();
                                
                                // Show "Draw in Progress" immediately
                                const timeLeftElement = card.querySelector('.time-left');
                                if (timeLeftElement) {
                                    timeLeftElement.textContent = 'Draw in Progress...';
                                    timeLeftElement.style.color = 'var(--warning)';
                                    timeLeftElement.style.fontWeight = '700';
                                }
                                
                                // Delay the actual declaration by 10 seconds as requested
                                setTimeout(() => {
                                    declareContestWinner(template.id, true);
                                }, 10000);
                            }
                        }
                        
                        const timeLeftElement = card.querySelector('.time-left');
                        if (timeLeftElement) {
                            const timeLeft = getTimeLeft(currentEndTime, template.id);
                            timeLeftElement.textContent = timeLeft;
                            
                            // Show "Draw in Progress" when time is up
                            if (currentEndTime <= now) {
                                timeLeftElement.textContent = 'Draw in Progress...';
                                timeLeftElement.style.color = 'var(--warning)';
                                timeLeftElement.style.fontWeight = '700';
                            }
                        }
                    }
                }
            });
            
            // Save updated state every 10 seconds to maintain consistency
            if (Date.now() % 10000 < 1000) {
                saveGlobalContestState();
            }
        }

        // Admin tab switching function
        function switchAdminTab(tabName) {
            // Hide all admin tab contents
            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Remove active class from all admin tab buttons
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-light)';
            });
            
            // Show selected admin tab content
            document.getElementById('admin' + tabName.charAt(0).toUpperCase() + tabName.slice(1) + 'Content').style.display = 'block';
            
            // Add active class to selected admin tab button
            event.target.style.background = 'var(--primary)';
            event.target.style.color = 'white';
            
            // Load tab-specific content
            switch(tabName) {
                case 'deposits':
                case 'withdrawals':
                    loadPendingApprovals();
                    break;
                case 'contests':
                    loadAdminContests();
                    break;
                case 'users':
                    loadAllUsers();
                    break;
                case 'joined':
                    loadAllJoinedContests();
                    break;
                case 'referrals':
                    loadAllReferrals();
                    break;
            }
        }

        // Global state for preventing duplicate operations
        let contestOperationsInProgress = new Set();
        let lastWinnerUpdate = {};
        let processedEvents = new Set(); // Track processed events to prevent duplicates
        let autoDeclarationTimers = new Map(); // Track auto-declaration timers

        // Enhanced global auto-declaration system
        function initializeAutoDeclarationTimers() {
            console.log('Setting up global contest auto-declaration system...');
            
            // Set up Firestore listener for contest end times (works for all users)
            if (db) {
                db.collection('contestEndTimes').onSnapshot(snapshot => {
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const contestId = doc.id;
                        const endTime = data.endTime ? data.endTime.toDate() : null;
                        const now = new Date();
                        
                        if (endTime && endTime <= now && !data.processed) {
                            console.log(`Contest ${contestId} end time reached globally`);
                            
                            // Mark as processed to prevent duplicate triggers
                            doc.ref.update({ processed: true });
                            
                            // Only admin users can actually trigger the declaration
                            if (isAdmin) {
                                setTimeout(() => {
                                    declareContestWinner(contestId, true);
                                }, Math.random() * 2000 + 1000); // Random delay to prevent conflicts
                            }
                        }
                    });
                });
            }
            
            // Initialize timers for admin users
            if (isAdmin) {
                console.log('Admin user - setting up local auto-declaration timers');
                
                CONTEST_TEMPLATES.forEach(async (template) => {
                    if (globalContestState[template.id] && globalContestState[template.id].endTime) {
                        const endTime = new Date(globalContestState[template.id].endTime);
                        const now = new Date();
                        const timeUntilEnd = endTime.getTime() - now.getTime();
                        
                        // Store end time in Firestore for global tracking
                        try {
                            await db.collection('contestEndTimes').doc(template.id).set({
                                contestId: template.id,
                                contestTitle: template.title,
                                endTime: firebase.firestore.Timestamp.fromDate(endTime),
                                processed: false,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            }, { merge: true });
                        } catch (error) {
                            console.error('Error storing contest end time:', error);
                        }
                        
                        // Clear existing timer if any
                        if (autoDeclarationTimers.has(template.id)) {
                            clearTimeout(autoDeclarationTimers.get(template.id));
                            autoDeclarationTimers.delete(template.id);
                        }
                        
                        // Set new timer if contest hasn't ended yet
                        if (timeUntilEnd > 0) {
                            const timerId = setTimeout(() => {
                                console.log('Auto-declaring winners for:', template.title);
                                declareContestWinner(template.id, true);
                            }, timeUntilEnd + 2000); // Add 2 second buffer
                            
                            autoDeclarationTimers.set(template.id, timerId);
                            console.log(`Auto-declaration timer set for ${template.title} in ${Math.round(timeUntilEnd/1000)} seconds`);
                        } else if (timeUntilEnd > -120000) { // If less than 2 minutes past end time
                            console.log(`Contest ${template.title} recently ended, checking if already processed`);
                            
                            // Check if already processed
                            const endTimeDoc = await db.collection('contestEndTimes').doc(template.id).get();
                            if (!endTimeDoc.exists || !endTimeDoc.data().processed) {
                                setTimeout(() => {
                                    declareContestWinner(template.id, true);
                                }, 3000);
                            }
                        }
                    }
                });
            } else {
                console.log('Non-admin user - will receive global contest updates only');
            }
        }

        // Enhanced admin functions
        async function loadAllUsers() {
            if (!isAdmin) return;
            
            try {
                const usersSnapshot = await db.collection('users')
                    .orderBy('createdAt', 'desc')
                    .limit(100)
                    .get();
                
                const allUsersList = document.getElementById('allUsersList');
                allUsersList.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    allUsersList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No users found</div></div></div>';
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    
                    const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'Recent';
                    
                    item.innerHTML = `
                        <div class="data-item-info">
                            <div class="data-item-title">${user.displayName || 'Unknown User'}</div>
                            <div class="data-item-subtitle">
                                Email: ${user.email || 'N/A'}<br>
                                Balance: ${formatIndianCurrency(user.balance || 0)}<br>
                                Contests: ${user.contestsJoined || 0} joined, ${user.contestsWon || 0} won<br>
                                Joined: ${joinDate}
                            </div>
                        </div>
                        <div class="data-item-value">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${formatIndianCurrency(user.balance || 0)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Current Balance</div>
                        </div>
                    `;
                    allUsersList.appendChild(item);
                });
                
                // Update admin stats
                document.getElementById('adminTotalUsers').textContent = usersSnapshot.size;
                
            } catch (error) {
                console.error('Error loading all users:', error);
                document.getElementById('allUsersList').innerHTML = `<div class="data-item"><div class="data-item-info"><div class="data-item-title">Error loading users</div><div class="data-item-subtitle">${error.message}</div></div></div>`;
            }
        }

        async function loadAllJoinedContests() {
            if (!isAdmin) return;
            
            try {
                const usersSnapshot = await db.collection('users').get();
                const allJoinedContestsList = document.getElementById('allJoinedContestsList');
                allJoinedContestsList.innerHTML = '';
                
                let allJoinedContests = [];
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    if (user.joinedContests && user.joinedContests.length > 0) {
                        user.joinedContests.forEach(contest => {
                            allJoinedContests.push({
                                ...contest,
                                userName: user.displayName || 'Unknown User',
                                userEmail: user.email
                            });
                        });
                    }
                });
                
                if (allJoinedContests.length === 0) {
                    allJoinedContestsList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No joined contests found</div></div></div>';
                    return;
                }
                
                // Sort by join date (most recent first)
                allJoinedContests.sort((a, b) => new Date(b.joinedAt) - new Date(a.joinedAt));
                
                allJoinedContests.slice(0, 50).forEach(contest => {
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    
                    const joinDate = contest.joinedAt ? new Date(contest.joinedAt).toLocaleDateString() : 'Recent';
                    const joinTime = contest.joinedAt ? new Date(contest.joinedAt).toLocaleTimeString() : 'Recent';
                    
                    item.innerHTML = `
                        <div class="data-item-info">
                            <div class="data-item-title">${contest.userName} - ${contest.title}</div>
                            <div class="data-item-subtitle">
                                Email: ${contest.userEmail}<br>
                                Entry Fee: ${formatIndianCurrency(contest.entryFee)}<br>
                                Joined: ${joinDate} at ${joinTime}<br>
                                Status: ${contest.status || 'Active'}
                            </div>
                        </div>
                        <div class="data-item-value">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--primary);">${formatIndianCurrency(contest.entryFee)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Entry Fee</div>
                        </div>
                    `;
                    allJoinedContestsList.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error loading all joined contests:', error);
                document.getElementById('allJoinedContestsList').innerHTML = `<div class="data-item"><div class="data-item-info"><div class="data-item-title">Error loading joined contests</div><div class="data-item-subtitle">${error.message}</div></div></div>`;
            }
        }

        async function loadAllReferrals() {
            if (!isAdmin) return;
            
            try {
                const usersSnapshot = await db.collection('users')
                    .where('referredBy', '!=', null)
                    .orderBy('createdAt', 'desc')
                    .limit(50)
                    .get();
                
                const allReferralsList = document.getElementById('allReferralsList');
                allReferralsList.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    allReferralsList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No referrals found</div></div></div>';
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const user = doc.data();
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    
                    const joinDate = user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'Recent';
                    
                    item.innerHTML = `
                        <div class="data-item-info">
                            <div class="data-item-title">${user.displayName || 'Unknown User'}</div>
                            <div class="data-item-subtitle">
                                Email: ${user.email}<br>
                                Referred by: ${user.referredBy}<br>
                                Referral earnings: ${formatIndianCurrency(user.referralEarnings || 0)}<br>
                                Joined: ${joinDate}
                            </div>
                        </div>
                        <div class="data-item-value">
                            <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);">${formatIndianCurrency(user.referralEarnings || 0)}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light);">Earnings</div>
                        </div>
                    `;
                    allReferralsList.appendChild(item);
                });
                
            } catch (error) {
                console.error('Error loading all referrals:', error);
                document.getElementById('allReferralsList').innerHTML = `<div class="data-item"><div class="data-item-info"><div class="data-item-title">Error loading referrals</div><div class="data-item-subtitle">${error.message}</div></div></div>`;
            }
        }

        function loadAdminContests() {
            const adminContestsList = document.getElementById('adminContestsList');
            adminContestsList.innerHTML = '';
            
            CONTEST_TEMPLATES.forEach(template => {
                const contest = globalContestState[template.id] || template;
                const item = document.createElement('div');
                item.className = 'data-item';
                
                const endTime = contest.endTime ? new Date(contest.endTime).toLocaleString() : 'Not scheduled';
                
                item.innerHTML = `
                    <div class="data-item-info">
                        <div class="data-item-title">${template.title}</div>
                        <div class="data-item-subtitle">
                            Prize Pool: ${formatIndianCurrency(template.prizePool)}<br>
                            Entry Fee: ${template.entryFee}<br>
                            Participants: ${contest.participants || 0}/${template.maxParticipants}<br>
                            Next Draw: ${endTime}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; flex-direction: column;">
                        <button class="btn btn-success" onclick="declareContestWinner('${template.id}')">
                            <i class="fas fa-crown"></i> Declare Winner
                        </button>
                        <button class="btn btn-warning" onclick="endContest('${template.id}')">
                            <i class="fas fa-flag-checkered"></i> End & Declare Winners
                        </button>
                        <button class="btn btn-primary" onclick="restartContest('${template.id}')">
                            <i class="fas fa-restart"></i> Restart
                        </button>
                        <button class="btn btn-secondary" onclick="refundAllParticipants('${template.id}')">
                            <i class="fas fa-undo"></i> Refund All
                        </button>
                    </div>
                `;
                adminContestsList.appendChild(item);
            });
            
            // Update admin stats
            document.getElementById('adminActiveContests').textContent = CONTEST_TEMPLATES.length;
        }

        async function declareWinners() {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            if (confirm('Declare winners for all active contests? This action cannot be undone.')) {
                try {
                    CONTEST_TEMPLATES.forEach(template => {
                        declareContestWinner(template.id);
                    });
                    showNotification('Winners declared for all contests!', 'success');
                } catch (error) {
                    showNotification('Error declaring winners: ' + error.message, 'error');
                }
            }
        }

        async function declareContestWinner(contestId, isAutomatic = false) {
            if (!isAdmin) return;
            
            // Prevent duplicate operations with stricter checking
            const operationKey = `declare_${contestId}`;
            const now = Date.now();
            
            if (contestOperationsInProgress.has(operationKey)) {
                console.log('Contest draw already in progress for:', contestId);
                showNotification('Contest draw is already in progress!', 'warning');
                return;
            }
            
            // Additional check for recent declarations
            const lastDeclarationKey = `last_declare_${contestId}`;
            if (lastWinnerUpdate[lastDeclarationKey] && (now - lastWinnerUpdate[lastDeclarationKey]) < 30000) {
                console.log('Recent declaration found, skipping:', contestId);
                return;
            }
            
            if (!isAutomatic && !confirm(`Conduct live draw for ${contestId}? This will randomly select winners and distribute prizes.`)) {
                return;
            }
            
            // Mark operation as in progress and record timestamp
            contestOperationsInProgress.add(operationKey);
            lastWinnerUpdate[lastDeclarationKey] = now;
            
            // Broadcast draw start to all users
            broadcastDrawEvent('draw_started', contestId);
            
            try {
                // Get all real participants for this contest
                const participantsSnapshot = await db.collection('contestParticipants')
                    .where('contestId', '==', contestId)
                    .where('status', '==', 'active')
                    .get();
                
                const realParticipants = [];
                participantsSnapshot.forEach(doc => {
                    const data = doc.data();
                    realParticipants.push({
                        id: doc.id,
                        userId: data.userId,
                        userName: data.userName,
                        userEmail: data.userEmail,
                        lotteryNumbers: data.lotteryNumbers,
                        isBot: false
                    });
                });
                
                // Find contest template for prize structure
                const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
                if (!template) {
                    showNotification('Contest template not found!', 'error');
                    return;
                }
                
                // Generate bot participants to fill 1st, 2nd, 3rd places
                const botParticipants = [
                    {
                        id: 'bot_1st_' + Date.now(),
                        userId: 'bot_1st',
                        userName: getBotName(),
                        userEmail: 'bot1@smartlottery.in',
                        lotteryNumbers: generateLotteryNumbers(contestId),
                        isBot: true,
                        guaranteedRank: 1
                    },
                    {
                        id: 'bot_2nd_' + Date.now(),
                        userId: 'bot_2nd',
                        userName: getBotName(),
                        userEmail: 'bot2@smartlottery.in',
                        lotteryNumbers: generateLotteryNumbers(contestId),
                        isBot: true,
                        guaranteedRank: 2
                    },
                    {
                        id: 'bot_3rd_' + Date.now(),
                        userId: 'bot_3rd',
                        userName: getBotName(),
                        userEmail: 'bot3@smartlottery.in',
                        lotteryNumbers: generateLotteryNumbers(contestId),
                        isBot: true,
                        guaranteedRank: 3
                    }
                ];
                
                // Combine all participants
                const allParticipants = [...botParticipants, ...realParticipants];
                
                // Generate winning numbers
                const winningNumbers = generateLotteryNumbers(contestId);
                
                // Calculate matches for all participants based on single 5-digit numbers
                const results = allParticipants.map(participant => {
                    let matches = 0;
                    
                    // For bots, ensure they get exact or close matches to win top prizes
                    if (participant.isBot) {
                        if (participant.guaranteedRank === 1) {
                            matches = 5; // Exact match for 1st place (all 5 digits match)
                            participant.lotteryNumbers = [winningNumbers[0]]; // Set to winning number
                        } else if (participant.guaranteedRank === 2) {
                            matches = 4; // 4 digits match for 2nd place
                        } else if (participant.guaranteedRank === 3) {
                            matches = 3; // 3 digits match for 3rd place
                        }
                    } else {
                        // Real participants: calculate actual digit matches
                        const winningStr = winningNumbers[0].toString();
                        const userStr = participant.lotteryNumbers[0].toString();
                        matches = 0;
                        for (let i = 0; i < 5; i++) {
                            if (winningStr[i] === userStr[i]) {
                                matches++;
                            }
                        }
                    }
                    
                    return {
                        ...participant,
                        matches: matches,
                        score: matches * 1000 + (participant.isBot ? (6 - participant.guaranteedRank) * 100 : Math.random() * 99)
                    };
                });
                
                // Sort by matches (descending) then by score (bots will be on top)
                results.sort((a, b) => {
                    if (b.matches !== a.matches) return b.matches - a.matches;
                    if (a.isBot && !b.isBot) return -1;
                    if (!a.isBot && b.isBot) return 1;
                    return b.score - a.score;
                });
                
                // Award prizes with conservative approach for real users to prevent bankruptcy
                const winners = [];
                let currentRank = 1;
                
                // Count real participants
                const realParticipantCount = realParticipants.length;
                
                // Determine maximum real winners based on participant count (very conservative)
                let maxRealWinners = 0;
                if (realParticipantCount < 10) {
                    maxRealWinners = 1; // Only 1 real winner for small contests
                } else if (realParticipantCount < 20) {
                    maxRealWinners = 2; // Max 2 real winners
                } else {
                    maxRealWinners = 3; // Max 3 real winners even for large contests
                }
                
                let realWinnersCount = 0;
                
                for (const prizeStructure of template.prizeStructure) {
                    const prizeCount = getPrizeCount(prizeStructure);
                    
                    for (let i = 0; i < prizeCount && (currentRank - 1) < results.length; i++) {
                        const winner = results[currentRank - 1];
                        
                        // Strict policy: No real users get 1st, 2nd, or 3rd prizes unless 50+ real participants
                        if (!winner.isBot && currentRank <= 3 && realParticipantCount < 50) {
                            // Skip this real user for top 3 prizes
                            continue;
                        }
                        
                        // For consolation prizes, limit real users strictly
                        if (!winner.isBot && currentRank > 3) {
                            if (realWinnersCount >= maxRealWinners) {
                                // Skip this real user, already gave max consolation prizes
                                continue;
                            }
                            
                            // Only 10% chance for real users to win consolation prizes
                            if (Math.random() > 0.1) {
                                continue;
                            }
                            
                            realWinnersCount++;
                        }
                        
                        winners.push({
                            ...winner,
                            rank: currentRank,
                            prize: prizeStructure.amount, // Use actual prize amount from contest structure
                            prizePosition: prizeStructure.position
                        });
                        currentRank++;
                    }
                }
                
                console.log(` Conservative winner distribution: ${realWinnersCount} real winners out of ${realParticipantCount} real participants`);
                
                // Store last contest results for Current Winners tab
                storeLastContestResults(contestId, winningNumbers, winners);
                
                // Show winners announcement after 1 second
                setTimeout(() => {
                    showWinnersAnnouncement(contestId, winningNumbers, winners);
                    
                    // Broadcast draw completion to all users
                    broadcastDrawEvent('draw_completed', contestId, {
                        winningNumbers: winningNumbers,
                        winners: winners.slice(0, 10) // Send top 10 winners for display
                    });
                }, 1000);
                
                // Update global winners list with all winners (both bots and real users)
                const allWinnersForDisplay = winners.map(winner => ({
                    name: winner.userName,
                    contest: template.title,
                    prize: winner.prize,
                    date: 'Just now',
                    isBot: winner.isBot,
                    rank: winner.rank,
                    prizePosition: winner.prizePosition,
                    winningNumbers: winningNumbers,
                    lotteryNumbers: winner.lotteryNumbers
                }));
                
                // Add to beginning of sample winners array for global display
                sampleWinners.splice(0, 0, ...allWinnersForDisplay);
                
                // Keep only recent 100 winners for better display
                if (sampleWinners.length > 100) {
                    sampleWinners.splice(100);
                }
                
                // Save winners to multiple localStorage locations for maximum persistence
                const winnersJson = JSON.stringify(sampleWinners);
                localStorage.setItem('smartLotteryWinners', winnersJson);
                localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
                localStorage.setItem('smartLotteryAllWinners', winnersJson);
                
                // Store winners in Firestore for global access
                try {
                    const batch = db.batch();
                    allWinnersForDisplay.slice(0, 10).forEach((winner, index) => {
                        const winnerRef = db.collection('globalWinners').doc();
                        batch.set(winnerRef, {
                            ...winner,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            contestId: contestId,
                            drawId: `${contestId}_${Date.now()}`
                        });
                    });
                    await batch.commit();
                    console.log('Winners saved to Firestore successfully');
                } catch (error) {
                    console.error('Error saving winners to Firestore:', error);
                }
                
                // Immediately update global winners display
                loadWinners();
                
                // Force broadcast winners update to all users with multiple events
                broadcastDrawEvent('winners_updated', contestId, {
                    winners: allWinnersForDisplay.slice(0, 20)
                });
                
                // Additional broadcast for maximum coverage
                setTimeout(() => {
                    broadcastDrawEvent('global_winners_update', contestId, {
                        winners: allWinnersForDisplay,
                        totalWinners: allWinnersForDisplay.length,
                        contestTitle: template.title
                    });
                }, 1000);
                
                // Distribute prizes and update profiles for real users only
                for (const winner of winners) {
                    if (!winner.isBot) {
                        try {
                            // Update winner's balance and profile
                            await db.collection('users').doc(winner.userId).update({
                                balance: firebase.firestore.FieldValue.increment(winner.prize),
                                totalWinnings: firebase.firestore.FieldValue.increment(winner.prize),
                                contestsWon: firebase.firestore.FieldValue.increment(1)
                            });
                            
                            // Add winning transaction
                            await db.collection('users').doc(winner.userId).collection('transactions').add({
                                type: 'contest_win',
                                amount: winner.prize,
                                description: `Won ${winner.prizePosition} in ${template.title}`,
                                contestId: contestId,
                                winningNumbers: winningNumbers,
                                userNumbers: winner.lotteryNumbers,
                                matches: winner.matches,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                status: 'completed'
                            });
                            
                        } catch (error) {
                            console.error('Error awarding prize to winner:', winner.userId, error);
                        }
                    }
                }
                
                // Update all participants' contest status to completed
                const participantBatch = db.batch();
                participantsSnapshot.forEach(doc => {
                    participantBatch.update(doc.ref, { 
                        status: 'completed',
                        winningNumbers: winningNumbers,
                        drawCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                });
                await participantBatch.commit();
                
                // Update all users' joined contests with proper results and profile stats
                // Track processed user-contest combinations to prevent duplicate prizes
                const processedUserContests = new Set();
                
                for (const participant of realParticipants) {
                    const userContestKey = `${participant.userId}_${contestId}`;
                    
                    // Skip if already processed this user for this contest
                    if (processedUserContests.has(userContestKey)) {
                        console.log(`Skipping duplicate processing for user ${participant.userId} in contest ${contestId}`);
                        continue;
                    }
                    
                    processedUserContests.add(userContestKey);
                    
                    // Find only the FIRST (highest) prize for this user to prevent multiple consolation prizes
                    const winnerData = winners.find(w => w.userId === participant.userId && !w.isBot);
                    
                    try {
                        const userRef = db.collection('users').doc(participant.userId);
                        const userDoc = await userRef.get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            const updatedJoinedContests = userData.joinedContests.map(contest => {
                                if (contest.templateId === contestId && contest.status === 'active') {
                                    if (winnerData) {
                                        // User won a prize - only give them their highest prize
                                        return {
                                            ...contest,
                                            status: 'completed',
                                            drawStatus: 'completed',
                                            prizeWon: winnerData.prize,
                                            rank: winnerData.rank,
                                            prizePosition: winnerData.prizePosition,
                                            winningNumbers: winningNumbers,
                                            matches: winnerData.matches,
                                            completedAt: new Date().toISOString(),
                                            result: 'won'
                                        };
                                    } else {
                                        // User didn't win - calculate matches
                                        const userStr = participant.lotteryNumbers[0].toString();
                                        const winningStr = winningNumbers[0].toString();
                                        let actualMatches = 0;
                                        for (let i = 0; i < 5; i++) {
                                            if (winningStr[i] === userStr[i]) {
                                                actualMatches++;
                                            }
                                        }
                                        
                                        return {
                                            ...contest,
                                            status: 'completed',
                                            drawStatus: 'completed',
                                            prizeWon: 0,
                                            rank: 'No Prize',
                                            winningNumbers: winningNumbers,
                                            matches: actualMatches,
                                            completedAt: new Date().toISOString(),
                                            result: 'lost'
                                        };
                                    }
                                }
                                return contest;
                            });
                            
                            // Prepare user update with proper profile stats
                            const updateData = {
                                joinedContests: updatedJoinedContests,
                                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                            };
                            
                            // Update profile stats for winners only once per contest
                            if (winnerData) {
                                // Use Firebase increment to prevent race conditions
                                updateData.contestsWon = firebase.firestore.FieldValue.increment(1);
                                updateData.totalWinnings = firebase.firestore.FieldValue.increment(winnerData.prize);
                                updateData.balance = firebase.firestore.FieldValue.increment(winnerData.prize);
                                
                                console.log(`Updating winner profile: ${participant.userName} won ${winnerData.prize} for rank ${winnerData.rank}`);
                            }
                            
                            // Update user document immediately
                            await userRef.update(updateData);
                            
                            console.log(`Profile updated successfully for user: ${participant.userName}`);
                        }
                    } catch (error) {
                        console.error('Error updating participant profile:', participant.userId, error);
                    }
                }
                
                // Broadcast profile update event to refresh UI for logged-in users
                broadcastDrawEvent('profiles_updated', contestId, {
                    contestTitle: template.title,
                    participantCount: realParticipants.length,
                    winnerCount: winners.filter(w => !w.isBot).length
                });
                
                console.log('All participant profiles updated successfully');
                
                // Save complete draw results for record keeping
                await db.collection('drawResults').add({
                    contestId: contestId,
                    contestTitle: template.title,
                    winningNumbers: winningNumbers,
                    totalParticipants: allParticipants.length,
                    totalWinners: winners.length,
                    totalPrizeDistributed: winners.reduce((sum, w) => sum + w.prize, 0),
                    realParticipants: realParticipants.length,
                    botParticipants: botParticipants.length,
                    winners: winners.map(w => ({
                        userName: w.userName,
                        lotteryNumbers: w.lotteryNumbers,
                        rank: w.rank,
                        prize: w.prize,
                        matches: w.matches,
                        isBot: w.isBot,
                        prizePosition: w.prizePosition
                    })),
                    drawCompletedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(` Live draw completed! Winning number: ${winningNumbers[0]}. ${winners.filter(w => !w.isBot).length} real winners and ${winners.filter(w => w.isBot).length} featured winners!`, 'success');
                
                // Reset contest immediately with fresh timer and clear participants
                const newEndTime = getNextDrawTime(template);
                globalContestState[contestId] = {
                    ...template,
                    endTime: newEndTime,
                    participants: 0 // Reset participants for fresh start
                };
                
                // Update participant counts
                globalParticipantCounts[contestId] = 0;
                
                // Store end time in Firestore for global tracking
                try {
                    await db.collection('contestEndTimes').doc(contestId).set({
                        contestId: contestId,
                        contestTitle: template.title,
                        endTime: firebase.firestore.Timestamp.fromDate(newEndTime),
                        processed: false,
                        restarted: true,
                        restartedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });
                } catch (error) {
                    console.error('Error storing contest restart time:', error);
                }
                
                saveGlobalContestState();
                
                // Clear any existing auto-declaration timer
                if (autoDeclarationTimers.has(contestId)) {
                    clearTimeout(autoDeclarationTimers.get(contestId));
                    autoDeclarationTimers.delete(contestId);
                }
                
                // Set up new auto-declaration timer for this contest
                const timeUntilEnd = newEndTime.getTime() - new Date().getTime();
                if (timeUntilEnd > 0 && isAdmin) {
                    const timerId = setTimeout(() => {
                        console.log('Auto-declaring winners for restarted contest:', template.title);
                        declareContestWinner(contestId, true);
                    }, timeUntilEnd + 2000); // Add 2 second buffer
                    
                    autoDeclarationTimers.set(contestId, timerId);
                    console.log(`New auto-declaration timer set for ${template.title} in ${Math.round(timeUntilEnd/1000)} seconds`);
                }
                
                // Broadcast contest reset globally
                broadcastDrawEvent('contest_reset', contestId, {
                    newEndTime: newEndTime,
                    participants: globalParticipantCounts[contestId] || 0
                });
                
                // Refresh all relevant displays
                generateActiveContests();
                loadWinners();
                loadJoinedContests();
                
                // Auto-refresh for current user if they're viewing relevant tabs
                if (currentUser) {
                    await loadUserData(currentUser);
                    updateBalanceDisplay();
                    updateProfile();
                }
                
            } catch (error) {
                console.error('Error conducting live draw:', error);
                showNotification('Error conducting live draw: ' + error.message, 'error');
            } finally {
                // Always remove operation lock
                contestOperationsInProgress.delete(operationKey);
            }
        }
        
        // Helper function to get prize count from position string
        function getPrizeCount(prizeStructure) {
            if (prizeStructure.position.includes('1st')) return 1;
            if (prizeStructure.position.includes('2nd')) return 1;
            if (prizeStructure.position.includes('3rd')) return 1;
            
            // Use the count property if available
            if (prizeStructure.count) {
                return prizeStructure.count;
            }
            
            // Extract range like "4th-100th Prize"
            const match = prizeStructure.position.match(/(\d+)th-(\d+)th/);
            if (match) {
                const start = parseInt(match[1]);
                const end = parseInt(match[2]);
                return end - start + 1;
            }
            
            return 1;
        }

        async function endContest(contestId) {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
            if (!template) {
                showNotification('Contest template not found!', 'error');
                return;
            }
            
            if (confirm(`End "${template.title}" contest and declare winners? This will conduct the live draw and distribute prizes.`)) {
                try {
                    showNotification(' Ending contest and conducting live draw...', 'info');
                    
                    // Conduct the live draw to declare winners
                    await declareContestWinner(contestId);
                    
                    showNotification(`Contest "${template.title}" ended successfully! Winners have been declared and prizes distributed.`, 'success');
                    
                } catch (error) {
                    console.error('Error ending contest:', error);
                    showNotification('Error ending contest: ' + error.message, 'error');
                }
            }
        }

        async function refundAllParticipants(contestId) {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
            if (!template) {
                showNotification('Contest template not found!', 'error');
                return;
            }
            
            if (confirm(`Refund all participants in "${template.title}"? This will not end the contest.`)) {
                try {
                    showNotification('Processing participant refunds...', 'info');
                    
                    // Get all active participants for this contest
                    const participantsSnapshot = await db.collection('contestParticipants')
                        .where('contestId', '==', contestId)
                        .where('status', '==', 'active')
                        .get();
                    
                    let refundCount = 0;
                    const batch = db.batch();
                    
                    // Process refunds
                    for (const doc of participantsSnapshot.docs) {
                        const participant = doc.data();
                        
                        // Update participant status
                        batch.update(doc.ref, { 
                            status: 'refunded',
                            refundedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        // Refund user balance
                        const userRef = db.collection('users').doc(participant.userId);
                        batch.update(userRef, {
                            balance: firebase.firestore.FieldValue.increment(template.entryFee)
                        });
                        
                        refundCount++;
                    }
                    
                    // Commit all refunds
                    await batch.commit();
                    
                    // Add refund transactions
                    for (const doc of participantsSnapshot.docs) {
                        const participant = doc.data();
                        await db.collection('users').doc(participant.userId).collection('transactions').add({
                            type: 'refund',
                            amount: template.entryFee,
                            description: `Participant refund for ${template.title}`,
                            contestId: contestId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            status: 'completed'
                        });
                    }
                    
                    showNotification(`${refundCount} participants refunded ${template.entryFee} each for "${template.title}".`, 'success');
                    
                } catch (error) {
                    console.error('Error refunding participants:', error);
                    showNotification('Error processing refunds: ' + error.message, 'error');
                }
            }
        }

        async function restartContest(contestId) {
            if (!isAdmin) {
                showNotification('Admin access required', 'error');
                return;
            }
            
            const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
            if (!template) {
                showNotification('Contest template not found!', 'error');
                return;
            }
            
            if (!confirm(`Restart "${template.title}" contest? This will reset the timer and participant count.`)) {
                return;
            }
            
            try {
                // Reset contest with fresh start - new timer and reset participants
                const newEndTime = getNextDrawTime(template);
                
                // Reset global state completely
                globalContestState[contestId] = {
                    ...template,
                    endTime: newEndTime,
                    participants: Math.floor(Math.random() * 200) + 100 // Start with random base
                };
                
                // Reset participant counts
                globalParticipantCounts[contestId] = globalContestState[contestId].participants;
                
                // Update Firestore contest stats with fresh data
                await db.collection('contestStats').doc(contestId).set({
                    participants: globalContestState[contestId].participants,
                    baseCount: globalContestState[contestId].participants,
                    realParticipants: 0,
                    totalParticipants: globalContestState[contestId].participants,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    contestTitle: template.title,
                    endTime: newEndTime.toISOString(),
                    status: 'active',
                    restartedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update contest end times for proper tracking
                await db.collection('contestEndTimes').doc(contestId).set({
                    contestId: contestId,
                    contestTitle: template.title,
                    endTime: firebase.firestore.Timestamp.fromDate(newEndTime),
                    processed: false,
                    restarted: true,
                    restartedAt: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                
                saveGlobalContestState();
                
                // Clear existing auto-declaration timer
                if (autoDeclarationTimers.has(contestId)) {
                    clearTimeout(autoDeclarationTimers.get(contestId));
                    autoDeclarationTimers.delete(contestId);
                }
                
                // Set new auto-declaration timer
                const timeUntilEnd = newEndTime.getTime() - new Date().getTime();
                if (timeUntilEnd > 0) {
                    const timerId = setTimeout(() => {
                        console.log('Auto-declaring winners for restarted contest:', template.title);
                        declareContestWinner(contestId, true);
                    }, timeUntilEnd + 2000); // Add 2 second buffer
                    
                    autoDeclarationTimers.set(contestId, timerId);
                    console.log(`Auto-declaration timer set for ${template.title} in ${Math.round(timeUntilEnd/1000)} seconds`);
                }
                
                // Broadcast restart globally
                broadcastDrawEvent('contest_reset', contestId, {
                    newEndTime: newEndTime,
                    participants: globalContestState[contestId].participants,
                    contestTitle: template.title,
                    restarted: true
                });
                
                // Force immediate refresh
                generateActiveContests();
                if (typeof loadAdminContestGrid === 'function') {
                    loadAdminContestGrid();
                }
                
                showNotification(`Contest "${template.title}" restarted successfully! New timer: ${getTimeLeft(newEndTime, contestId)}`, 'success');
                
            } catch (error) {
                console.error('Error restarting contest:', error);
                showNotification('Error restarting contest: ' + error.message, 'error');
            }
        }

        async function endAllContests() {
            if (!isAdmin) return;
            
            if (confirm('End all active contests and declare winners? This will conduct live draws for all contests.')) {
                try {
                    for (const template of CONTEST_TEMPLATES) {
                        await endContest(template.id);
                    }
                    showNotification('All contests ended and winners declared!', 'success');
                } catch (error) {
                    showNotification('Error ending contests: ' + error.message, 'error');
                }
            }
        }

        async function restartContests() {
            if (!isAdmin) return;
            
            if (confirm('Restart all contests with fresh timers?')) {
                try {
                    CONTEST_TEMPLATES.forEach(template => {
                        restartContest(template.id);
                    });
                    showNotification('All contests restarted with fresh timers!', 'success');
                } catch (error) {
                    showNotification('Error restarting contests: ' + error.message, 'error');
                }
            }
        }

        async function simulateContestDraw() {
            if (!isAdmin) {
                showNotification('Admin access required for simulation', 'error');
                return;
            }
            
            const contestId = 'daily_1l'; // Use Daily 1 Lakh contest for simulation
            const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
            
            if (!template) {
                showNotification('Contest template not found for simulation!', 'error');
                return;
            }
            
            showNotification(' Starting simulation draw with bot winners and test participants...', 'info');
            
            // Show slot machine with simulation
            showSlotMachineDraw(contestId);
            
            // Generate winning numbers
            const winningNumbers = generateLotteryNumbers(contestId);
            console.log(' Simulation winning numbers:', winningNumbers);
            
            // Create bot winners for top 3 places
            const botWinners = [
                {
                    id: 'bot_1st_sim',
                    userId: 'bot_1st',
                    userName: getBotName(),
                    userEmail: 'bot1@smartlottery.in',
                    lotteryNumbers: generateLotteryNumbers(contestId),
                    isBot: true,
                    rank: 1,
                    prize: 50000,
                    prizePosition: '1st Prize',
                    matches: 5
                },
                {
                    id: 'bot_2nd_sim',
                    userId: 'bot_2nd',
                    userName: getBotName(),
                    userEmail: 'bot2@smartlottery.in',
                    lotteryNumbers: generateLotteryNumbers(contestId),
                    isBot: true,
                    rank: 2,
                    prize: 25000,
                    prizePosition: '2nd Prize',
                    matches: 4
                },
                {
                    id: 'bot_3rd_sim',
                    userId: 'bot_3rd',
                    userName: getBotName(),
                    userEmail: 'bot3@smartlottery.in',
                    lotteryNumbers: generateLotteryNumbers(contestId),
                    isBot: true,
                    rank: 3,
                    prize: 10000,
                    prizePosition: '3rd Prize',
                    matches: 3
                }
            ];
            
            // Create some test participants (consolation prizes)
            const testParticipants = [
                { 
                    id: 'sim_1', 
                    userId: 'test_user_1', 
                    userName: 'Test Player 1', 
                    userEmail: 'test1@example.com',
                    lotteryNumbers: [12345, 23456, 34567, 45678, 56789],
                    isBot: false,
                    rank: 4,
                    prize: 555,
                    prizePosition: '4th-30th Prize',
                    matches: 1
                },
                { 
                    id: 'sim_2', 
                    userId: 'test_user_2', 
                    userName: 'Test Player 2', 
                    userEmail: 'test2@example.com',
                    lotteryNumbers: [11111, 22222, 33333, 44444, 55555],
                    isBot: false,
                    rank: 5,
                    prize: 555,
                    prizePosition: '4th-30th Prize',
                    matches: 1
                }
            ];
            
            const allWinners = [...botWinners, ...testParticipants];
            
            // Show results after 3 seconds
            setTimeout(() => {
                updateSlotMachineResults(winningNumbers, botWinners);
                
                // Add to global winners list
                const newWinners = allWinners.map(winner => ({
                    name: winner.userName,
                    contest: template.title,
                    prize: winner.prize,
                    date: 'Just now',
                    isBot: winner.isBot
                }));
                
                sampleWinners.splice(0, 0, ...newWinners);
                loadWinners();
                
                // Log simulation results
                console.log(' Simulation Results:');
                console.log('Winning Numbers:', winningNumbers);
                console.log('Bot Winners (Top 3):');
                botWinners.forEach(w => {
                    console.log(` ${w.prizePosition}: ${w.userName} - ${formatIndianCurrency(w.prize)} (${w.matches} matches)`);
                });
                console.log('Real User Winners (Consolation):');
                testParticipants.forEach(w => {
                    console.log(` ${w.prizePosition}: ${w.userName} - ${formatIndianCurrency(w.prize)} (${w.matches} matches)`);
                });
                
                showNotification(` Simulation complete! Top 3 prizes go to featured winners, consolation prizes to real users. Check console for details.`, 'success');
            }, 3000);
        }

        async function viewDrawResults() {
            if (!isAdmin) return;
            
            try {
                const drawResultsSnapshot = await db.collection('drawResults')
                    .orderBy('drawCompletedAt', 'desc')
                    .limit(10)
                    .get();
                
                const drawResultsContent = document.getElementById('drawResultsContent');
                drawResultsContent.innerHTML = '';
                
                if (drawResultsSnapshot.empty) {
                    drawResultsContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <div style="font-size: 3rem; color: var(--text-lighter); margin-bottom: 20px;">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <h3>No Draw Results Found</h3>
                            <p style="color: var(--text-light);">Conduct some live draws to see results here.</p>
                        </div>
                    `;
                } else {
                    drawResultsSnapshot.forEach(doc => {
                        const result = doc.data();
                        const drawDate = result.drawCompletedAt ? 
                            new Date(result.drawCompletedAt.toDate()).toLocaleString() : 'Recent';
                        
                        const resultCard = document.createElement('div');
                        resultCard.style.cssText = `
                            background: var(--surface);
                            border-radius: var(--radius-lg);
                            padding: 24px;
                            margin-bottom: 20px;
                            box-shadow: var(--shadow);
                            border-left: 4px solid var(--primary);
                        `;
                        
                        resultCard.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                                <h3 style="margin: 0; color: var(--primary);">${result.contestTitle}</h3>
                                <span style="color: var(--text-light); font-size: 0.9rem;">${drawDate}</span>
                            </div>
                            
                            <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 16px; border-radius: 12px; margin: 16px 0; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;"> Winning Numbers</div>
                                <div style="font-size: 2.2rem; font-weight: 800; letter-spacing: 3px; font-family: 'Courier New', monospace;">
                                    ${result.winningNumbers[0]}
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 16px; margin-bottom: 16px;">
                                <div style="text-align: center; padding: 12px; background: rgba(25, 118, 210, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary);">${result.totalParticipants}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">Total Participants</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: rgba(76, 175, 80, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.5rem; font-weight: 700; color: var(--success);">${result.totalWinners}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">Winners</div>
                                </div>
                                <div style="text-align: center; padding: 12px; background: rgba(255, 152, 0, 0.1); border-radius: 8px;">
                                    <div style="font-size: 1.2rem; font-weight: 700; color: var(--warning);">${formatIndianCurrency(result.totalPrizeDistributed)}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">Prize Distributed</div>
                                </div>
                            </div>
                            
                            ${result.winners && result.winners.length > 0 ? `
                                <div style="margin-top: 16px;">
                                    <h4 style="margin-bottom: 12px; color: var(--text);"> Top Winners</h4>
                                    ${result.winners.slice(0, 5).map(winner => `
                                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border);">
                                            <div>
                                                <strong>${winner.userName}</strong>
                                                <span style="color: var(--text-light); margin-left: 8px;">Rank ${winner.rank} (${winner.matches} matches)</span>
                                            </div>
                                            <div style="font-weight: 700; color: var(--success);">${formatIndianCurrency(winner.prize)}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        `;
                        
                        drawResultsContent.appendChild(resultCard);
                    });
                }
                
                openModal('liveDrawModal');
                
            } catch (error) {
                console.error('Error loading draw results:', error);
                showNotification('Error loading draw results: ' + error.message, 'error');
            }
        }

        // Start countdown timer
        setInterval(updateCountdowns, 1000);

        function togglePrizeDetails(contestId) {
            const details = document.getElementById('prizes_' + contestId);
            details.classList.toggle('show');
        }

        function toggleConsolationPrizes(contestId) {
            const consolationDiv = document.getElementById(`consolation-prizes-${contestId}`);
            const chevron = document.getElementById(`consolation-toggle-${contestId}`);
            
            if (!consolationDiv || !chevron) return;
            
            if (consolationDiv.style.display === 'none' || !consolationDiv.style.display) {
                consolationDiv.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
            } else {
                consolationDiv.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        async function joinContest(contestId) {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            const contest = activeContests.find(c => c.id === contestId);
            if (!contest) {
                showNotification('Contest not found', 'error');
                return;
            }
            
            if (userBalance < contest.entryFee) {
                showNotification('Insufficient balance! Please add money to join this contest.', 'error');
                openModal('addMoneyModal');
                return;
            }

            // Extract the base template ID from the contest ID
            let templateId;
            if (contest.templateId) {
                templateId = contest.templateId;
            } else {
                // Extract from composite ID (format: templateId_timestamp_index)
                templateId = contest.id.split('_')[0];
            }
            
            // Find the template in CONTEST_TEMPLATES
            const template = CONTEST_TEMPLATES.find(t => t.id === templateId);
            if (!template) {
                console.error('Template not found for ID:', templateId, 'Available templates:', CONTEST_TEMPLATES.map(t => t.id));
                showNotification(`Contest template "${templateId}" not found. Please refresh the page.`, 'error');
                return;
            }
            
            // Initialize contest state if it doesn't exist or is invalid
            if (!globalContestState[templateId] || !globalContestState[templateId].endTime) {
                const endTime = getNextDrawTime(template);
                globalContestState[templateId] = {
                    ...template,
                    endTime: endTime,
                    participants: calculateRealisticParticipantCount(template, endTime),
                    startTime: new Date(),
                    initialParticipants: Math.floor(template.maxParticipants * 0.15)
                };
                saveGlobalContestState();
            }

            // Generate random lottery numbers for the user
            const lotteryNumbers = generateLotteryNumbers(templateId);
            
            try {
                // Ensure user document exists with proper structure
                const userRef = db.collection('users').doc(currentUser.uid);
                const userDoc = await userRef.get();
                
                if (!userDoc.exists) {
                    // Create user document if it doesn't exist
                    await userRef.set({
                        displayName: currentUser.displayName || 'Smart Player',
                        email: currentUser.email,
                        balance: userBalance,
                        referralCode: 'SL' + currentUser.uid.substr(0, 6).toUpperCase(),
                        referredBy: null,
                        referralEarnings: 0,
                        contestsJoined: 0,
                        contestsWon: 0,
                        totalWinnings: 0,
                        joinedContests: [],
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showNotification('User profile created successfully!', 'success');
                }
                
                const userData = userDoc.exists ? userDoc.data() : { joinedContests: [] };
                const currentJoinedContests = userData.joinedContests || [];
                
                const newJoinedContest = {
                    ...contest,
                    templateId: templateId,
                    joinedAt: new Date().toISOString(),
                    status: 'active',
                    entryId: Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    lotteryNumbers: lotteryNumbers,
                    drawStatus: 'pending'
                };
                
                // Add to global contest participants collection for admin management
                await db.collection('contestParticipants').add({
                    contestId: templateId,
                    userId: currentUser.uid,
                    userName: currentUser.displayName || 'Unknown User',
                    userEmail: currentUser.email,
                    lotteryNumbers: lotteryNumbers,
                    entryFee: contest.entryFee,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'active'
                });
                
                // Get current realistic count and real participants with safety check
                const currentRealisticCount = calculateRealisticParticipantCount(
                    template, 
                    new Date(globalContestState[templateId].endTime)
                );
                
                // Get real participant count from Firestore
                let realCount = 0;
                let baseCount = currentRealisticCount; // Define baseCount
                try {
                    const statsDoc = await db.collection('contestStats').doc(templateId).get();
                    if (statsDoc.exists) {
                        const data = statsDoc.data();
                        realCount = data.realParticipants || 0;
                        baseCount = data.baseCount || currentRealisticCount;
                    }
                } catch (error) {
                    console.log('Firestore stats not available, using local count');
                }
                
                // Increment real participant count
                const newRealCount = realCount + 1;
                const newTotalCount = baseCount + newRealCount;
                
                // Update Firestore with new counts using increment for better consistency
                await db.collection('contestStats').doc(templateId).update({
                    realParticipants: firebase.firestore.FieldValue.increment(1),
                    totalParticipants: firebase.firestore.FieldValue.increment(1),
                    participants: firebase.firestore.FieldValue.increment(1),
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
                    lastJoinerId: currentUser.uid,
                    lastJoinerName: currentUser.displayName || 'Unknown User'
                });
                
                // Update local counts immediately
                globalParticipantCounts[templateId] = newTotalCount;
                
                // Update global contest state immediately
                if (globalContestState[templateId]) {
                    globalContestState[templateId].participants = newTotalCount;
                }
                
                // Save updated state
                saveGlobalContestState();
                
                console.log(`Participant joined ${templateId}: Base=${baseCount}, Real=${newRealCount}, Total=${newTotalCount}`);
                
                // Broadcast participant count update globally with immediate effect
                broadcastDrawEvent('participant_joined', templateId, {
                    newCount: newTotalCount,
                    realCount: newRealCount,
                    baseCount: baseCount,
                    userJoined: currentUser.displayName || 'Unknown User',
                    userId: currentUser.uid,
                    immediate: true
                });
                
                // Force immediate UI update
                setTimeout(() => {
                    generateActiveContests();
                }, 100);
                
                // Update user document with new balance and joined contest
                await userRef.update({
                    balance: firebase.firestore.FieldValue.increment(-contest.entryFee),
                    contestsJoined: firebase.firestore.FieldValue.increment(1),
                    joinedContests: [...currentJoinedContests, newJoinedContest]
                });
                
                // Add transaction record
                await userRef.collection('transactions').add({
                    type: 'contest_entry',
                    amount: -contest.entryFee,
                    description: `Joined ${contest.title}`,
                    contestId: contestId,
                    lotteryNumbers: lotteryNumbers,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'completed'
                });
                
                // Update local state
                userBalance -= contest.entryFee;
                updateBalanceDisplay();
                userProfile.contestsJoined++;
                
                // Add to local joined contests
                joinedContests.push(newJoinedContest);
                
                // Show success with lottery number
                showNotification(` Successfully joined ${contest.title}! Your lottery number: ${lotteryNumbers[0]} `, 'success');
                
                // Show lottery numbers in a more prominent way
                setTimeout(() => {
                    showLotteryNumbersModal(contest.title, lotteryNumbers);
                }, 1000);
                
                // Force update contest grid with new participant counts
                setTimeout(() => {
                    generateActiveContests();
                }, 500);
                
                // Reload joined contests tab if it's active
                if (document.getElementById('joinedContestsTab').classList.contains('active')) {
                    loadJoinedContests();
                }
                
            } catch (error) {
                console.error('Error joining contest:', error);
                if (error.code === 'permission-denied') {
                    showNotification('Permission denied. Please ensure you are logged in properly and try again.', 'error');
                } else if (error.code === 'unavailable') {
                    showNotification('Service temporarily unavailable. Please try again in a moment.', 'error');
                } else {
                    showNotification(`Failed to join contest: ${error.message}. Please try again.`, 'error');
                }
            }
        }

        // Generate single 5-digit lottery number
        function generateLotteryNumbers(contestType) {
            const minNum = 10000; // 5-digit minimum
            const maxNum = 99999; // 5-digit maximum
            const number = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
            return [number]; // Return as array for consistency
        }

        // Helper function to get ordinal suffix (1st, 2nd, 3rd, etc.)
        function getOrdinalSuffix(num) {
            const lastDigit = num % 10;
            const lastTwoDigits = num % 100;
            
            if (lastTwoDigits >= 11 && lastTwoDigits <= 13) {
                return 'th';
            }
            
            switch (lastDigit) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        async function loadJoinedContests() {
            // Show admin contest management if user is admin
            if (isAdmin) {
                document.getElementById('adminContestManagement').style.display = 'block';
                loadAdminContestGrid();
            }
            
            // Refresh user data from database to get latest contest status
            if (currentUser) {
                try {
                    const userDoc = await db.collection('users').doc(currentUser.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        
                        // Update local joined contests with latest data
                        joinedContests = userData.joinedContests || [];
                        
                        // Update user balance if it changed due to winnings
                        if (userData.balance !== userBalance) {
                            userBalance = userData.balance || 0;
                            updateBalanceDisplay();
                        }
                        
                        // Update user profile stats
                        userProfile = {
                            contestsJoined: userData.contestsJoined || 0,
                            contestsWon: userData.contestsWon || 0,
                            totalWinnings: userData.totalWinnings || 0
                        };
                    }
                } catch (error) {
                    console.error('Error refreshing user data:', error);
                }
            }
            
            const activeList = document.getElementById('activeJoinedContestsList');
            const completedList = document.getElementById('completedJoinedContestsList');
            
            activeList.innerHTML = '';
            completedList.innerHTML = '';
            
            if (joinedContests.length === 0) {
                if (isAdmin) {
                    activeList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Admin Mode</div><div class="data-item-subtitle">You can manage all contests from the Admin Contest Management section above.</div></div></div>';
                } else {
                    activeList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No active contests found.</div><div class="data-item-subtitle">Join a contest from the Live Contests tab to see it here.</div></div></div>';
                }
                completedList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No completed contests found.</div></div></div>';
                return;
            }
            
            const activeContestsList = joinedContests.filter(c => c.status === 'active');
            const completedContestsList = joinedContests.filter(c => c.status === 'completed');
            
            if (activeContestsList.length === 0) {
                if (isAdmin) {
                    activeList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Admin Mode</div><div class="data-item-subtitle">You can manage all contests from the Admin Contest Management section above.</div></div></div>';
                } else {
                    activeList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No active contests found.</div><div class="data-item-subtitle">Join a contest from the Live Contests tab to see it here.</div></div></div>';
                }
            } else {
                activeContestsList.forEach(contest => {
                    const card = createJoinedContestCard(contest);
                    activeList.appendChild(card);
                });
            }
            
            if (completedContestsList.length === 0) {
                completedList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No completed contests found.</div></div></div>';
            } else {
                // Sort completed contests by completion date (most recent first)
                completedContestsList.sort((a, b) => {
                    const dateA = a.completedAt ? new Date(a.completedAt) : new Date(0);
                    const dateB = b.completedAt ? new Date(b.completedAt) : new Date(0);
                    return dateB - dateA;
                });
                
                completedContestsList.forEach(contest => {
                    const card = createJoinedContestCard(contest);
                    completedList.appendChild(card);
                });
            }
        }

        function createJoinedContestCard(contest) {
            const card = document.createElement('div');
            card.className = 'joined-contest-card';
            
            const joinedDate = contest.joinedAt ? new Date(contest.joinedAt).toLocaleDateString('en-GB') : 'Recent';
            const joinedTime = contest.joinedAt ? new Date(contest.joinedAt).toLocaleTimeString('en-GB', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            }) : 'Recent';
            
            const completedDate = contest.completedAt ? new Date(contest.completedAt).toLocaleDateString('en-GB') : null;
            
            const statusBadge = contest.status === 'active' ? 
                '<span class="status-badge status-active">Active</span>' : 
                '<span class="status-badge status-completed">Ended</span>';
            
            const lotteryNumbers = contest.lotteryNumbers ? contest.lotteryNumbers[0] : 'Not assigned';
            
            // Enhanced result display based on win/loss
            let resultSection = '';
            if (contest.status === 'completed') {
                if (contest.prizeWon && contest.prizeWon > 0) {
                    // Winner
                    resultSection = `
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px; border-radius: 12px; margin: 16px 0; text-align: center; box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 1.2rem; font-weight: 800; margin-bottom: 8px;"> CONGRATULATIONS! </div>
                            <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 8px;">You won ${contest.prizePosition || contest.rank}!</div>
                            <div style="font-size: 2rem; font-weight: 800; letter-spacing: 1px;">${formatIndianCurrency(contest.prizeWon)}</div>
                            <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 8px;">Prize added to your balance</div>
                        </div>
                        
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                                <div><strong>Your Number:</strong> ${lotteryNumbers}</div>
                                <div><strong>Winning Number:</strong> ${contest.winningNumbers ? contest.winningNumbers[0] : 'N/A'}</div>
                                <div><strong>Matches:</strong> ${contest.matches || 0} digits</div>
                                <div><strong>Your Rank:</strong> ${contest.rank || 'Winner'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    // Didn't win
                    resultSection = `
                        <div style="background: linear-gradient(135deg, #64748b, #475569); color: white; padding: 16px; border-radius: 12px; margin: 16px 0; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: 700; margin-bottom: 8px;"> Better Luck Next Time!</div>
                            <div style="font-size: 0.95rem; opacity: 0.9;">You didn't win this time, but don't give up!</div>
                        </div>
                        
                        <div style="background: rgba(100, 116, 139, 0.1); padding: 12px; border-radius: 8px; margin: 12px 0;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem;">
                                <div><strong>Your Number:</strong> ${lotteryNumbers}</div>
                                <div><strong>Winning Number:</strong> ${contest.winningNumbers ? contest.winningNumbers[0] : 'N/A'}</div>
                                <div><strong>Matches:</strong> ${contest.matches || 0} digits</div>
                                <div><strong>Result:</strong> No Prize</div>
                            </div>
                        </div>
                    `;
                }
            } else {
                // Active contest
                resultSection = `
                    <div style="background: linear-gradient(135deg, #4f46e5, #7c3aed); color: white; padding: 16px; border-radius: 12px; margin: 16px 0; text-align: center;">
                        <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;"> Your Lottery Number</div>
                        <div style="font-size: 1.8rem; font-weight: 800; letter-spacing: 2px; font-family: 'Courier New', monospace;">
                            ${lotteryNumbers}
                        </div>
                        <div style="font-size: 0.85rem; opacity: 0.8; margin-top: 8px;">Awaiting draw results...</div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="contest-header">
                    <h3 class="contest-name">${contest.title}</h3>
                    ${statusBadge}
                </div>
                
                ${resultSection}
                
                <div class="contest-details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Entry Fee</span>
                        <span class="detail-value">${formatIndianCurrency(contest.entryFee)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Prize Pool</span>
                        <span class="detail-value">${formatIndianCurrency(contest.prizePool)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Joined Date</span>
                        <span class="detail-value">${joinedDate}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Draw Status</span>
                        <span class="detail-value prize-status">${contest.drawStatus === 'completed' ? 'Draw Complete' : 'Awaiting Draw'}</span>
                    </div>
                    
                    ${contest.status === 'completed' && completedDate ? `
                    <div class="detail-item">
                        <span class="detail-label">Completed On</span>
                        <span class="detail-value">${completedDate}</span>
                    </div>
                    ` : ''}
                    
                    <div class="detail-item">
                        <span class="detail-label">Final Result</span>
                        <span class="detail-value contest-status">${
                            contest.status === 'completed' ? 
                                (contest.prizeWon ? `Won ${formatIndianCurrency(contest.prizeWon)}` : 'No Prize') : 
                                'Pending'
                        }</span>
                    </div>
                </div>
            `;
            
            return card;
        }

        // Global flag to prevent multiple simultaneous winner loading
        let winnersLoading = false;

        // Function to get realistic contest end times based on actual contest schedule  
        function getContestEndTime(contestName) {
            const now = new Date();
            
            // Map contest names to their actual schedules
            const contestSchedules = {
                '1 Crore Weekly Elite': 7 * 24 * 60 * 60 * 1000, // 7 days
                '60 Lakh Hexa-Daily': 6 * 24 * 60 * 60 * 1000, // 6 days  
                '25 Lakh Penta-Daily': 5 * 24 * 60 * 60 * 1000, // 5 days
                '10 Lakh Quad-Daily': 4 * 24 * 60 * 60 * 1000, // 4 days
                '5 Lakh Tri-Daily': 3 * 24 * 60 * 60 * 1000, // 3 days
                '3 Lakh Bi-Daily': 2 * 24 * 60 * 60 * 1000, // 2 days
                'Daily 1 Lakh Special': 24 * 60 * 60 * 1000, // 1 day
                'Daily 40K Express': 24 * 60 * 60 * 1000, // 1 day
                '25 Rupees Instant Fill': 0 // Instant when full
            };
            
            const schedule = contestSchedules[contestName] || 24 * 60 * 60 * 1000;
            
            // Calculate last actual end time (assuming contests end at 6 PM)
            const lastEnd = new Date(now.getTime() - (now.getTime() % schedule));
            lastEnd.setHours(18, 0, 0, 0);
            
            if (lastEnd > now) {
                lastEnd.setTime(lastEnd.getTime() - schedule);
            }
            
            return lastEnd;
        }

        // Function to format time ago more realistically
        function getRealisticTimeAgo(contestName) {
            const endTime = getContestEndTime(contestName);
            const now = new Date();
            const diff = now.getTime() - endTime.getTime();
            
            const hours = Math.floor(diff / (60 * 60 * 1000));
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                return 'Just now';
            }
        }

        // Store last contest results when admin ends contests
        function storeLastContestResults(contestId, winningNumbers, winners) {
            try {
                const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
                if (!template) return;
                
                const contestResult = {
                    contestId: contestId,
                    contestTitle: template.title,
                    winningNumbers: winningNumbers,
                    winners: winners.slice(0, 50), // Top 50 winners
                    endTime: new Date().toISOString(),
                    totalPrizeDistributed: winners.reduce((sum, w) => sum + w.prize, 0),
                    totalWinners: winners.length
                };
                
                // Get existing results
                let lastContestResults = JSON.parse(localStorage.getItem('smartLotteryLastContestResults') || '[]');
                
                // Add new result at the beginning
                lastContestResults.unshift(contestResult);
                
                // Keep only last 3 contest results
                if (lastContestResults.length > 3) {
                    lastContestResults = lastContestResults.slice(0, 3);
                }
                
                // Save to localStorage
                localStorage.setItem('smartLotteryLastContestResults', JSON.stringify(lastContestResults));
                
                console.log('Last contest results stored:', contestResult);
                
                // Immediately refresh current winners display for all users
                setTimeout(() => {
                    loadCurrentWinners();
                }, 500);
                
            } catch (error) {
                console.error('Error storing last contest results:', error);
            }
        }

        // Generate sample contest results for all 7 contests if none exist
        function generateSampleContestResult(template) {
            const winningNumbers = [Math.floor(Math.random() * 90000) + 10000];
            const winners = [];
            let rank = 1;
            
            // Generate winners based on actual prize structure
            template.prizeStructure.forEach(prize => {
                const count = getPrizeCount(prize);
                for (let i = 0; i < count && rank <= 50; i++) {
                    winners.push({
                        userName: getBotName(),
                        lotteryNumbers: [Math.floor(Math.random() * 90000) + 10000],
                        rank: rank,
                        prize: prize.amount, // Use actual prize amount from structure
                        prizePosition: prize.position,
                        isBot: true,
                        matches: rank <= 3 ? (6 - rank) : Math.floor(Math.random() * 3) + 1
                    });
                    rank++;
                }
            });
            
            return {
                contestId: template.id,
                contestTitle: template.title,
                winningNumbers: winningNumbers,
                winners: winners,
                endTime: new Date(Date.now() - Math.random() * 24 * 60 * 60 * 1000).toISOString(),
                totalPrizeDistributed: winners.reduce((sum, w) => sum + w.prize, 0),
                totalWinners: winners.length
            };
        }

        // Load current contest results (last ended contests)
        async function loadCurrentWinners() {
            const currentWinnersList = document.getElementById('currentWinnersList');
            if (!currentWinnersList) return;
            
            currentWinnersList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Loading current results...</div></div></div>';
            
            try {
                // Get stored last contest results
                let lastContestResults = JSON.parse(localStorage.getItem('smartLotteryLastContestResults') || '[]');
                
                // If no stored results or missing contests, generate sample results for all 7 contests
                if (lastContestResults.length === 0) {
                    lastContestResults = CONTEST_TEMPLATES.map(template => generateSampleContestResult(template));
                    localStorage.setItem('smartLotteryLastContestResults', JSON.stringify(lastContestResults));
                } else if (lastContestResults.length < 7) {
                    // Add missing contests
                    const existingContestIds = lastContestResults.map(r => r.contestId);
                    const missingTemplates = CONTEST_TEMPLATES.filter(t => !existingContestIds.includes(t.id));
                    const missingResults = missingTemplates.map(template => generateSampleContestResult(template));
                    lastContestResults = [...lastContestResults, ...missingResults];
                    localStorage.setItem('smartLotteryLastContestResults', JSON.stringify(lastContestResults));
                }
                
                currentWinnersList.innerHTML = '';
                
                if (lastContestResults.length === 0) {
                    currentWinnersList.innerHTML = `
                        <div class="data-item">
                            <div class="data-item-info">
                                <div class="data-item-title"> No Recent Results</div>
                                <div class="data-item-subtitle">Contest results will appear here when contests end. Current contests are still running.</div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Header with improved styling
                const header = document.createElement('div');
                header.style.cssText = `
                    background: linear-gradient(135deg, #6366f1, #8b5cf6);
                    color: white;
                    padding: 20px;
                    border-radius: 16px;
                    text-align: center;
                    margin-bottom: 24px;
                    font-weight: 700;
                    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
                `;
                header.innerHTML = `
                     <strong>Latest Contest Results</strong><br>
                    <span style="font-size: 0.9rem; opacity: 0.9;">
                        ${lastContestResults.length} Recently Ended Contest${lastContestResults.length > 1 ? 's' : ''}
                    </span>
                `;
                currentWinnersList.appendChild(header);
                
                // Remove duplicates based on contestId and endTime to prevent showing same contest twice
                const uniqueContests = lastContestResults.filter((contest, index, self) => 
                    index === self.findIndex(c => c.contestId === contest.contestId && 
                        Math.abs(new Date(c.endTime).getTime() - new Date(contest.endTime).getTime()) < 60000)
                );
                
                // Display each unique contest result with improved styling
                uniqueContests.forEach((contest, contestIndex) => {
                    const contestCard = document.createElement('div');
                    contestCard.style.cssText = `
                        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                        border-radius: 16px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                        border-left: 4px solid #6366f1;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;
                    
                    const endTime = new Date(contest.endTime);
                    const timeAgo = formatTimeAgo(Date.now() - endTime.getTime());
                    const contestCardId = `contest-${contest.contestId}-${contestIndex}`;
                    
                    contestCard.innerHTML = `
                        <div onclick="toggleContestResults('${contestCardId}')" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="color: #6366f1; font-size: 1.2rem; font-weight: 700;">${contest.contestTitle}</div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.8rem; color: #64748b;">Just announced  ${timeAgo}</div>
                                    <div style="font-size: 1rem; color: #10b981; font-weight: 700;">${formatIndianCurrency(contest.totalPrizeDistributed)}</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #64748b; font-size: 0.9rem;">
                                    <i class="fas fa-trophy"></i> ${contest.totalWinners} Total Winners
                                </span>
                                <i class="fas fa-chevron-down" id="chevron-${contestCardId}" style="color: #64748b; transition: transform 0.3s;"></i>
                            </div>
                        </div>
                        
                        <!-- Collapsible Contest Results -->
                        <div id="results-${contestCardId}" style="display: none; margin-top: 16px;">
                            <!-- Winning Numbers Display -->
                            <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px; border-radius: 12px; margin: 12px 0; text-align: center;">
                                <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;"> Winning Number:</div>
                                <div style="font-size: 2.2rem; font-weight: 800; letter-spacing: 3px; font-family: 'Courier New', monospace;">
                                    ${contest.winningNumbers[0]}
                                </div>
                            </div>
                            
                            <!-- Winners Cards Style -->
                            <div style="margin: 16px 0;">
                                <!-- 1st Prize Card -->
                                <div style="background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; padding: 16px; border-radius: 12px; margin: 8px 0; border-left: 4px solid #fbbf24;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 4px;"> ${contest.winners[0]?.userName || 'Suresh Yadav'} - 1st Prize</div>
                                            <div style="font-size: 0.9rem; opacity: 0.9;">Just announced  Number: ${contest.winners[0]?.lotteryNumbers[0] || '49247'}</div>
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.4rem;">${formatIndianCurrency(contest.winners[0]?.prize || 50000)}</div>
                                    </div>
                                </div>
                                
                                <!-- 2nd Prize Card -->
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px; border-radius: 12px; margin: 8px 0; border-left: 4px solid #10b981;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 4px;"> ${contest.winners[1]?.userName || 'Sudha Verma'} - 2nd Prize</div>
                                            <div style="font-size: 0.9rem; opacity: 0.9;">Just announced  Number: ${contest.winners[1]?.lotteryNumbers[0] || '58083'}</div>
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.4rem;">${formatIndianCurrency(contest.winners[1]?.prize || 25000)}</div>
                                    </div>
                                </div>
                                
                                <!-- 3rd Prize Card -->
                                <div style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 16px; border-radius: 12px; margin: 8px 0; border-left: 4px solid #6366f1;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 4px;"> ${contest.winners[2]?.userName || 'Geeta Sharma'} - 3rd Prize</div>
                                            <div style="font-size: 0.9rem; opacity: 0.9;">Just announced  Number: ${contest.winners[2]?.lotteryNumbers[0] || '93033'}</div>
                                        </div>
                                        <div style="font-weight: 800; font-size: 1.4rem;">${formatIndianCurrency(contest.winners[2]?.prize || 10000)}</div>
                                    </div>
                                </div>
                                
                                <!-- 4th Prize Card with Collapsible Consolation Prizes -->
                                <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 16px; border-radius: 12px; margin: 8px 0; border-left: 4px solid #10b981; cursor: pointer;" onclick="toggleConsolationWinners('${contestCardId}')">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 4px;"> ${contest.winners[3]?.userName || 'Asha Gupta'} - 4th Prize</div>
                                            <div style="font-size: 0.9rem; opacity: 0.9;">Just announced  Number: ${contest.winners[3]?.lotteryNumbers[0] || '60195'}</div>
                                            <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 4px;">Click to view all consolation prizes</div>
                                        </div>
                                        <div style="text-align: right;">
                                            <div style="font-weight: 800; font-size: 1.4rem;">${formatIndianCurrency(contest.winners[3]?.prize || 500)}</div>
                                            <i class="fas fa-chevron-down" id="consolation-chevron-${contestCardId}" style="transition: transform 0.3s; margin-top: 4px;"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Collapsible Consolation Prizes -->
                                    <div id="consolation-${contestCardId}" style="display: none; margin: 16px 0; background: rgba(255, 255, 255, 0.1); padding: 16px; border-radius: 8px;">
                                        ${(() => {
                                            // Get actual consolation prize data from contest template
                                            const template = CONTEST_TEMPLATES.find(t => t.id === contest.contestId);
                                            const consolationPrizeStructure = template?.prizeStructure[3];
                                            
                                            const consolationWinners = contest.winners ? contest.winners.slice(3) : [];
                                            const consolationPrize = consolationPrizeStructure?.amount || (consolationWinners.length > 0 ? consolationWinners[0].prize : 500);
                                            const consolationCount = consolationPrizeStructure?.count || consolationWinners.length || 30;
                                            const lastRank = 4 + consolationCount - 1;
                                            
                                            // Generate lottery numbers if needed
                                            const lotteryNumbers = consolationWinners.map(w => w.lotteryNumbers[0]);
                                            while (lotteryNumbers.length < consolationCount) {
                                                lotteryNumbers.push(Math.floor(Math.random() * 90000) + 10000);
                                            }
                                            
                                            return `
                                                <h4 style="margin: 0 0 12px 0; text-align: center; color: white;"> All Consolation Prize Winners (4th-${lastRank}${getOrdinalSuffix(lastRank)})</h4>
                                                <div style="text-align: center; margin-bottom: 16px;">
                                                    <div style="font-family: 'Courier New', monospace; font-weight: 700; font-size: 0.9rem; line-height: 1.8; color: white;">
                                                        ${lotteryNumbers.slice(0, consolationCount).join(', ')}
                                                    </div>
                                                </div>
                                                
                                                <div style="text-align: center; padding: 12px; background: rgba(255, 255, 255, 0.15); border-radius: 6px;">
                                                    <div style="font-weight: 700; margin-bottom: 4px; color: white;">Total: ${consolationCount} Consolation Winners</div>
                                                    <div style="font-size: 0.9rem; opacity: 0.9; color: white;">Each winner receives ${formatIndianCurrency(consolationPrize)}  Total: ${formatIndianCurrency(consolationCount * consolationPrize)}</div>
                                                </div>
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    currentWinnersList.appendChild(contestCard);
                });
                
            } catch (error) {
                console.error('Error loading current winners:', error);
                currentWinnersList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading results</div></div></div>';
            }
        }

        // Function to toggle contest results display
        function toggleContestResults(contestCardId) {
            const resultsDiv = document.getElementById(`results-${contestCardId}`);
            const chevron = document.getElementById(`chevron-${contestCardId}`);
            
            if (!resultsDiv || !chevron) return;
            
            if (resultsDiv.style.display === 'none' || !resultsDiv.style.display) {
                resultsDiv.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                
                // Smooth animation
                resultsDiv.style.opacity = '0';
                resultsDiv.style.maxHeight = '0px';
                resultsDiv.style.overflow = 'hidden';
                resultsDiv.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    resultsDiv.style.opacity = '1';
                    resultsDiv.style.maxHeight = '2000px';
                }, 10);
                
            } else {
                resultsDiv.style.opacity = '0';
                resultsDiv.style.maxHeight = '0px';
                chevron.style.transform = 'rotate(0deg)';
                
                setTimeout(() => {
                    resultsDiv.style.display = 'none';
                }, 300);
            }
        }

        // Function to toggle consolation winners display
        function toggleConsolationWinners(contestCardId) {
            const consolationDiv = document.getElementById(`consolation-${contestCardId}`);
            const chevron = document.getElementById(`consolation-chevron-${contestCardId}`);
            
            if (!consolationDiv || !chevron) return;
            
            if (consolationDiv.style.display === 'none' || !consolationDiv.style.display) {
                consolationDiv.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                
                // Smooth animation
                consolationDiv.style.opacity = '0';
                consolationDiv.style.maxHeight = '0px';
                consolationDiv.style.overflow = 'hidden';
                consolationDiv.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    consolationDiv.style.opacity = '1';
                    consolationDiv.style.maxHeight = '1500px';
                }, 10);
                
            } else {
                consolationDiv.style.opacity = '0';
                consolationDiv.style.maxHeight = '0px';
                chevron.style.transform = 'rotate(0deg)';
                
                setTimeout(() => {
                    consolationDiv.style.display = 'none';
                }, 300);
            }
        }
        
        // Load global winners (all-time)  
        async function loadGlobalWinners() {
            const globalWinnersList = document.getElementById('globalWinnersList');
            if (!globalWinnersList) return;
            
            globalWinnersList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Loading global winners...</div></div></div>';
            
            try {
                // Use existing sample winners for global display
                if (sampleWinners.length === 0) {
                    initializeSampleWinners();
                }
                
                globalWinnersList.innerHTML = '';
                
                // Add Global Top 3 Winners Section with improved styling
                const globalTop3 = document.createElement('div');
                globalTop3.style.cssText = `
                    background: linear-gradient(135deg, #6366f1, #8b5cf6);
                    color: white;
                    padding: 20px;
                    border-radius: 16px;
                    text-align: center;
                    margin-bottom: 24px;
                    box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
                `;
                
                // Get top 3 winners across all contests
                const top3Global = sampleWinners
                    .filter(w => w.rank <= 3)
                    .sort((a, b) => b.prize - a.prize)
                    .slice(0, 3);
                
                globalTop3.innerHTML = `
                    <h2 style="margin: 0 0 16px 0; font-size: 1.4rem;"> GLOBAL TOP 3 WINNERS </h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 16px;">
                        ${top3Global.map((winner, index) => {
                            const icons = ['', '', ''];
                            const colors = ['#fbbf24', '#10b981', '#6366f1'];
                            return `
                                <div style="background: rgba(255, 255, 255, 0.2); padding: 16px; border-radius: 12px; backdrop-filter: blur(10px); border: 2px solid ${colors[index]};">
                                    <div style="font-size: 2rem; margin-bottom: 8px;">${icons[index]}</div>
                                    <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 6px;">${winner.name}</div>
                                    <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 8px;">${winner.contest}</div>
                                    <div style="font-size: 1.3rem; font-weight: 800;">${formatIndianCurrency(winner.prize)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                globalWinnersList.appendChild(globalTop3);
                
                // Show all contest results in expandable format with actual winner cards
                const contestGroups = {};
                const allContests = [...new Set(sampleWinners.map(w => w.contest))];
                
                allContests.forEach(contestName => {
                    const contestWinners = sampleWinners.filter(w => w.contest === contestName);
                    if (contestWinners.length > 0) {
                        contestGroups[contestName] = contestWinners.sort((a, b) => (a.rank || 1) - (b.rank || 1));
                    }
                });
                
                // Display all contest groups with improved cards
                Object.keys(contestGroups).forEach((contestName, index) => {
                    const winners = contestGroups[contestName];
                    const contestCard = document.createElement('div');
                    contestCard.style.cssText = `
                        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
                        border-radius: 16px;
                        padding: 20px;
                        margin-bottom: 20px;
                        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
                        border-left: 4px solid #6366f1;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    `;
                    
                    const totalPrizeForContest = winners.reduce((sum, w) => sum + w.prize, 0);
                    const contestId = `global-${contestName.replace(/\s+/g, '-').toLowerCase()}`;
                    
                    contestCard.innerHTML = `
                        <div onclick="toggleContestWinners('${contestId}')" style="cursor: pointer;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="color: #6366f1; font-size: 1.2rem; font-weight: 700;">${contestName}</div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1rem; color: #10b981; font-weight: 700;">${formatIndianCurrency(totalPrizeForContest)}</div>
                                    <div style="font-size: 0.8rem; color: #64748b;">${winners.length} Total Winners</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                                <span style="color: #64748b; font-size: 0.9rem;">
                                    <i class="fas fa-trophy"></i> All-time results for this contest
                                </span>
                                <i class="fas fa-chevron-down" id="chevron-${contestId}" style="color: #64748b; transition: transform 0.3s;"></i>
                            </div>
                        </div>
                        
                        <!-- Collapsible Winners List -->
                        <div id="winners-${contestId}" style="display: none; margin-top: 16px;">
                            <!-- Display top winners -->
                            <div style="margin: 16px 0;">
                                ${winners.slice(0, 5).map((winner, winIndex) => {
                                    const colors = ['#fbbf24', '#10b981', '#6366f1', '#8b5cf6', '#10b981'];
                                    const medals = ['', '', '', '', ''];
                                    const positions = ['1st Prize', '2nd Prize', '3rd Prize', '4th Prize', '5th Prize'];
                                    
                                    return `
                                        <div style="background: linear-gradient(135deg, ${colors[winIndex]}, ${colors[winIndex]}dd); color: white; padding: 16px; border-radius: 12px; margin: 8px 0; border-left: 4px solid ${colors[winIndex]};">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-weight: 800; font-size: 1.1rem; margin-bottom: 4px;">${medals[winIndex]} ${winner.name} - ${positions[winIndex]}</div>
                                                    <div style="font-size: 0.9rem; opacity: 0.9;">${winner.date}  Number: ${winner.lotteryNumbers ? winner.lotteryNumbers[0] : Math.floor(Math.random() * 90000) + 10000}</div>
                                                </div>
                                                <div style="font-weight: 800; font-size: 1.4rem;">${formatIndianCurrency(winner.prize)}</div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                                
                                ${winners.length > 5 ? `
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; text-align: center; margin: 12px 0;">
                                    <div style="color: #10b981; font-weight: 700; margin-bottom: 4px;">+ ${winners.length - 5} More Winners</div>
                                    <div style="color: #64748b; font-size: 0.9rem;">Additional prizes ranging from ${formatIndianCurrency(Math.min(...winners.slice(5).map(w => w.prize)))} to ${formatIndianCurrency(Math.max(...winners.slice(5).map(w => w.prize)))}</div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    
                    globalWinnersList.appendChild(contestCard);
                });
                
            } catch (error) {
                console.error('Error loading global winners:', error);
                globalWinnersList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading global winners</div></div></div>';
            }
        }

        // Helper functions
        function getContestCycleDuration(contestId) {
            const durations = {
                'instant_25': 0,
                'daily_40k': 24 * 60 * 60 * 1000,
                'daily_1l': 24 * 60 * 60 * 1000,
                'bi_daily_3l': 2 * 24 * 60 * 60 * 1000,
                'tri_daily_5l': 3 * 24 * 60 * 60 * 1000,
                'quad_daily_10l': 4 * 24 * 60 * 60 * 1000,
                'penta_daily_25l': 5 * 24 * 60 * 60 * 1000,
                'hexa_daily_60l': 6 * 24 * 60 * 60 * 1000,
                'weekly_1cr': 7 * 24 * 60 * 60 * 1000
            };
            return durations[contestId] || 24 * 60 * 60 * 1000;
        }
        
        function formatTimeAgo(milliseconds) {
            const hours = Math.floor(milliseconds / (60 * 60 * 1000));
            const days = Math.floor(hours / 24);
            
            if (days > 0) {
                return `${days} day${days > 1 ? 's' : ''} ago`;
            } else if (hours > 0) {
                return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            } else {
                return 'Just now';
            }
        }
        
        function generateContestWinners(contest) {
            const winners = [];
            const prizeStructure = contest.prizeStructure || [];
            let rank = 1;
            
            prizeStructure.forEach(prize => {
                const count = getPrizeCount(prize);
                for (let i = 0; i < count; i++) {
                    winners.push({
                        name: rank <= 4 ? getBotName() : `Winner ${rank}`,
                        rank: rank,
                        prize: prize.amount,
                        number: Math.floor(Math.random() * 90000) + 10000,
                        prizePosition: prize.position
                    });
                    rank++;
                }
            });
            
            return winners.slice(0, 33); // Show up to 33 winners
        }

        // Update main loadWinners to call appropriate sub-function
        async function loadWinners() {
            // Load current winners by default
            await loadCurrentWinners();
        }

        // Function to toggle contest winners display
        function toggleContestWinners(contestId) {
            const winnersList = document.getElementById(`winners-${contestId}`);
            const chevron = document.getElementById(`chevron-${contestId}`);
            
            if (!winnersList || !chevron) return;
            
            if (winnersList.style.display === 'none' || !winnersList.style.display) {
                winnersList.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                
                // Smooth animation
                winnersList.style.opacity = '0';
                winnersList.style.maxHeight = '0px';
                winnersList.style.overflow = 'hidden';
                winnersList.style.transition = 'all 0.3s ease';
                
                setTimeout(() => {
                    winnersList.style.opacity = '1';
                    winnersList.style.maxHeight = '2000px';
                }, 10);
                
            } else {
                winnersList.style.opacity = '0';
                winnersList.style.maxHeight = '0px';
                chevron.style.transform = 'rotate(0deg)';
                
                setTimeout(() => {
                    winnersList.style.display = 'none';
                }, 300);
            }
        }

        // Switch between winners sub-tabs
        function switchWinnersTab(tabType) {
            // Update tab buttons
            document.querySelectorAll('.winners-sub-tab').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-light)';
            });
            
            // Hide all sub-contents
            document.querySelectorAll('.winners-sub-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Activate selected tab
            if (tabType === 'current') {
                document.querySelector('.winners-sub-tab[onClick*="current"]').classList.add('active');
                document.getElementById('currentWinnersContent').classList.add('active');
                document.getElementById('currentWinnersContent').style.display = 'block';
                loadCurrentWinners();
            } else {
                document.querySelector('.winners-sub-tab[onClick*="global"]').classList.add('active');
                document.getElementById('globalWinnersContent').classList.add('active');
                document.getElementById('globalWinnersContent').style.display = 'block';
                loadGlobalWinners();
            }
        }

        // Enhanced Firebase winner loading with real-time updates
        async function loadWinnersFromFirestore() {
            try {
                console.log('Loading winners from Firestore...');
                
                // Load from both globalWinners and recent draw results
                const [winnersSnapshot, drawResultsSnapshot] = await Promise.all([
                    db.collection('globalWinners')
                        .orderBy('timestamp', 'desc')
                        .limit(30)
                        .get(),
                    db.collection('drawResults')
                        .orderBy('drawCompletedAt', 'desc')
                        .limit(5)
                        .get()
                ]);
                
                const firestoreWinners = [];
                
                // Process globalWinners
                winnersSnapshot.forEach(doc => {
                    const winner = doc.data();
                    firestoreWinners.push({
                        name: winner.name,
                        contest: winner.contest,
                        prize: winner.prize,
                        date: winner.date || 'Recent',
                        rank: winner.rank || 1,
                        isBot: winner.isBot || false,
                        prizePosition: winner.prizePosition || `Position ${winner.rank || 1}`,
                        lotteryNumbers: winner.lotteryNumbers || [Math.floor(Math.random() * 90000) + 10000],
                        source: 'globalWinners'
                    });
                });
                
                // Process recent draw results - focus on latest contests only
                drawResultsSnapshot.forEach(doc => {
                    const drawResult = doc.data();
                    if (drawResult.winners && Array.isArray(drawResult.winners)) {
                        drawResult.winners.forEach(winner => {
                            const drawDate = drawResult.drawCompletedAt ? 
                                new Date(drawResult.drawCompletedAt.toDate()).toLocaleDateString() : 'Recent';
                            
                            firestoreWinners.push({
                                name: winner.userName,
                                contest: drawResult.contestTitle,
                                prize: winner.prize,
                                date: drawDate,
                                rank: winner.rank,
                                isBot: winner.isBot || false,
                                prizePosition: winner.prizePosition || `Position ${winner.rank}`,
                                lotteryNumbers: winner.lotteryNumbers || [Math.floor(Math.random() * 90000) + 10000],
                                source: 'drawResults',
                                contestId: drawResult.contestId
                            });
                        });
                    }
                });
                
                if (firestoreWinners.length > 0) {
                    console.log(`Loaded ${firestoreWinners.length} winners from Firestore`);
                    
                    // Merge with existing local winners and remove duplicates
                    const allWinners = [...firestoreWinners, ...sampleWinners];
                    const uniqueWinners = allWinners.filter((winner, index, self) => {
                        const key = `${winner.name}_${winner.contest}_${winner.prize}_${winner.rank}`;
                        return index === self.findIndex(w => `${w.name}_${w.contest}_${w.prize}_${w.rank}` === key);
                    });
                    
                    // Sort by most recent first
                    uniqueWinners.sort((a, b) => {
                        const timeA = a.date === 'Just now' || a.date === 'Recent' ? Date.now() : new Date(a.date).getTime() || 0;
                        const timeB = b.date === 'Just now' || b.date === 'Recent' ? Date.now() : new Date(b.date).getTime() || 0;
                        return timeB - timeA;
                    });
                    
                    sampleWinners = uniqueWinners.slice(0, 200);
                    
                    // Save to all localStorage locations for persistence
                    const winnersJson = JSON.stringify(sampleWinners);
                    localStorage.setItem('smartLotteryWinners', winnersJson);
                    localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
                    localStorage.setItem('smartLotteryAllWinners', winnersJson);
                    
                    console.log(`Updated local winners list with ${sampleWinners.length} total winners`);
                    
                    // Force refresh winners display
                    loadWinners();
                }
            } catch (error) {
                console.error('Error loading winners from Firestore:', error);
                // Fallback to local data if Firestore fails
                if (sampleWinners.length === 0) {
                    initializeSampleWinners();
                }
            }
        }

        // Set up real-time Firestore listeners for winners
        function setupWinnersListener() {
            if (!db) return;
            
            try {
                // Listen for new globalWinners
                db.collection('globalWinners')
                    .orderBy('timestamp', 'desc')
                    .limit(10)
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const winner = change.doc.data();
                                console.log('New winner detected from Firestore:', winner.name);
                                
                                const newWinner = {
                                    name: winner.name,
                                    contest: winner.contest,
                                    prize: winner.prize,
                                    date: winner.date || 'Just now',
                                    rank: winner.rank || 1,
                                    isBot: winner.isBot || false,
                                    prizePosition: winner.prizePosition || `Position ${winner.rank || 1}`
                                };
                                
                                // Add to beginning if not already exists
                                const exists = sampleWinners.some(w => 
                                    w.name === newWinner.name && 
                                    w.contest === newWinner.contest && 
                                    w.prize === newWinner.prize
                                );
                                
                                if (!exists) {
                                    sampleWinners.unshift(newWinner);
                                    if (sampleWinners.length > 100) {
                                        sampleWinners.splice(100);
                                    }
                                    
                                    // Save and refresh display
                                    localStorage.setItem('smartLotteryWinners', JSON.stringify(sampleWinners));
                                    loadWinners();
                                    
                                    showNotification(` New winner: ${winner.name} won ${formatIndianCurrency(winner.prize)}!`, 'success');
                                }
                            }
                        });
                    });
                    
                console.log('Firestore winners listener setup complete');
            } catch (error) {
                console.error('Error setting up winners listener:', error);
            }
        }

        async function loadTransactions() {
            if (!currentUser) return;
            
            try {
                const transactionsSnapshot = await db.collection('users').doc(currentUser.uid)
                    .collection('transactions')
                    .orderBy('timestamp', 'desc')
                    .limit(20)
                    .get();
                
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';
                
                if (transactionsSnapshot.empty) {
                    transactionsList.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No transactions found.</div></div></div>';
                    return;
                }
                
                transactionsSnapshot.forEach(doc => {
                    const transaction = doc.data();
                    const item = document.createElement('div');
                    item.className = 'data-item';
                    
                    const statusClass = transaction.status === 'pending' ? 'status-pending' : 
                                       transaction.status === 'approved' || transaction.status === 'completed' ? 'status-approved' : 
                                       transaction.status === 'rejected' ? 'status-rejected' : '';
                    
                    // Show better status for deposits and withdrawals
                    let statusText = transaction.status;
                    let statusIcon = '';
                    if (transaction.type === 'deposit') {
                        if (transaction.status === 'pending') {
                            statusText = 'Processing ';
                            statusIcon = '';
                        } else if (transaction.status === 'completed' || transaction.status === 'approved') {
                            statusText = 'Approved ';
                            statusIcon = '';
                        } else if (transaction.status === 'rejected') {
                            statusText = 'Rejected ';
                            statusIcon = '';
                        }
                    } else if (transaction.type === 'withdrawal') {
                        if (transaction.status === 'pending') {
                            statusText = 'Pending Approval ';
                            statusIcon = '';
                        } else if (transaction.status === 'completed' || transaction.status === 'approved') {
                            statusText = 'Approved & Paid ';
                            statusIcon = '';
                        } else if (transaction.status === 'rejected') {
                            statusText = 'Rejected & Refunded ';
                            statusIcon = '';
                        }
                    } else if (transaction.type === 'contest_win') {
                        statusText = 'Prize Won ';
                        statusIcon = '';
                    } else if (transaction.type === 'contest_entry') {
                        statusText = 'Contest Joined ';
                        statusIcon = '';
                    } else if (transaction.type === 'refund') {
                        statusText = 'Refunded ';
                        statusIcon = '';
                    }
                    
                    item.innerHTML = `
                        <div class="data-item-info">
                            <div class="data-item-title">${statusIcon} ${transaction.description}</div>
                            <div class="data-item-subtitle">
                                ${transaction.timestamp ? new Date(transaction.timestamp.toDate()).toLocaleDateString() : 'Recent'}
                                ${transaction.status ? ` <span class="transaction-status ${statusClass}" style="font-weight: 600;">${statusText}</span>` : ''}
                                ${transaction.transactionId ? `<br>TXN: ${transaction.transactionId}` : ''}
                            </div>
                        </div>
                        <div class="data-item-value transaction-amount ${transaction.amount > 0 ? 'positive' : 'negative'}">
                            ${transaction.amount > 0 ? '+' : ''}${formatIndianCurrency(Math.abs(transaction.amount))}
                        </div>
                    `;
                    transactionsList.appendChild(item);
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        function updateProfile() {
            document.getElementById('profileContestsJoined').textContent = userProfile.contestsJoined;
            document.getElementById('profileContestsWon').textContent = userProfile.contestsWon;
            document.getElementById('profileTotalWinnings').textContent = `${formatIndianCurrency(userProfile.totalWinnings)}`;
            
            const winRate = userProfile.contestsJoined > 0 ? 
                ((userProfile.contestsWon / userProfile.contestsJoined) * 100).toFixed(1) : 0;
            document.getElementById('profileWinRate').textContent = `${winRate}%`;
        }

        function loadReferrals() {
            document.getElementById('userReferralCode').textContent = userReferralCode;
            document.getElementById('referralEarnings').textContent = `${formatIndianCurrency(referralData.earnings)}`;
            document.getElementById('referredUsers').textContent = referralData.referredUsers.length;
            document.getElementById('pendingReferrals').textContent = referralData.pendingReferrals;
            
            const referralHistory = document.getElementById('referralHistory');
            referralHistory.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title">No referral history found.</div></div></div>';
        }

        function copyReferralCode() {
            navigator.clipboard.writeText(userReferralCode);
            showNotification('Referral code copied to clipboard!', 'success');
        }

        function shareOnWhatsApp() {
            const message = `Join Smart Lottery Pro with my referral code ${userReferralCode} and get 50 bonus! https://smartlottery.pro`;
            const url = `https://wa.me/?text=${encodeURIComponent(message)}`;
            window.open(url, '_blank');
        }

        function shareReferralCode() {
            if (navigator.share) {
                navigator.share({
                    title: 'Smart Lottery Pro',
                    text: `Join Smart Lottery Pro with my referral code ${userReferralCode} and get 50 bonus!`,
                    url: 'https://smartlottery.pro'
                });
            } else {
                copyReferralCode();
            }
        }

        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showLotteryNumbersModal(contestName, lotteryNumbers) {
            document.getElementById('contestNameDisplay').textContent = contestName;
            document.getElementById('displayLotteryNumbers').textContent = lotteryNumbers[0];
            openModal('lotteryNumbersModal');
        }

        function showWinnersAnnouncement(contestId, winningNumbers, allWinners) {
            const template = CONTEST_TEMPLATES.find(t => t.id === contestId);
            if (!template) {
                console.error('Template not found for contest:', contestId);
                return;
            }
            
            // Set contest name
            const contestNameEl = document.getElementById('winnersContestName');
            if (contestNameEl) {
                contestNameEl.textContent = template.title + ' - Results';
            }
            
            // Show countdown section and hide winners initially
            document.getElementById('countdownSection').style.display = 'block';
            document.getElementById('winnersRevealSection').style.display = 'none';
            
            // Show modal
            const modal = document.getElementById('winnersAnnouncementModal');
            if (modal) {
                modal.style.display = 'block';
                modal.style.zIndex = '9999';
                console.log(' Winners announcement modal opened');
            }
            
            // Start countdown
            startWinnersCountdown(winningNumbers, allWinners);
            
            // Global notification
            showNotification(' Contest ended! Winners being announced...', 'success');
        }

        function startWinnersCountdown(winningNumbers, allWinners) {
            let countdown = 10;
            const timerEl = document.getElementById('countdownTimer');
            
            const countdownInterval = setInterval(() => {
                countdown--;
                if (timerEl) {
                    timerEl.textContent = countdown;
                    
                    // Add special effects for final countdown
                    if (countdown <= 3) {
                        timerEl.style.color = '#ff4444';
                        timerEl.style.fontSize = '5rem';
                    }
                }
                
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    revealWinners(winningNumbers, allWinners);
                }
            }, 1000);
        }

        function revealWinners(winningNumbers, allWinners) {
            // Hide countdown and show winners
            document.getElementById('countdownSection').style.display = 'none';
            document.getElementById('winnersRevealSection').style.display = 'block';
            
            // Populate top 3 winners
            const top3Container = document.getElementById('top3Winners');
            const top3Winners = allWinners.slice(0, 3);
            const consolationWinners = allWinners.slice(3, 13); // Show top 10 consolation winners
            
            top3Container.innerHTML = '';
            
            top3Winners.forEach((winner, index) => {
                const positions = [' 1st Place', ' 2nd Place', ' 3rd Place'];
                const cardClasses = ['gold', 'silver', 'bronze'];
                
                const winnerCard = document.createElement('div');
                winnerCard.className = `winner-card ${cardClasses[index]}`;
                winnerCard.style.animationDelay = `${index * 0.2}s`;
                
                winnerCard.innerHTML = `
                    <div style="font-size: clamp(1.5rem, 4vw, 2rem); margin-bottom: 8px;">${positions[index].split(' ')[0]}</div>
                    <div style="font-size: clamp(1rem, 3vw, 1.2rem); font-weight: 700; color: var(--text); margin-bottom: 6px;">${winner.userName}</div>
                    <div style="font-size: clamp(0.8rem, 2.5vw, 0.9rem); color: var(--text-light); margin-bottom: 8px;">Number: ${winner.lotteryNumbers[0]}</div>
                    <div style="font-size: clamp(1.2rem, 4vw, 1.5rem); font-weight: 800; color: var(--success);">${formatIndianCurrency(winner.prize)}</div>
                `;
                
                top3Container.appendChild(winnerCard);
            });
            
            // Populate consolation winners after a delay
            setTimeout(() => {
                const consolationContainer = document.getElementById('consolationWinners');
                consolationContainer.innerHTML = '';
                
                consolationWinners.forEach((winner, index) => {
                    const winnerCard = document.createElement('div');
                    winnerCard.className = 'consolation-winner';
                    winnerCard.style.animationDelay = `${index * 0.1}s`;
                    
                    winnerCard.innerHTML = `
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 3px; font-size: clamp(0.85rem, 2.5vw, 0.9rem);">${winner.rank}${getOrdinalSuffix(winner.rank)} Place</div>
                        <div style="font-weight: 600; color: var(--text); margin-bottom: 3px; font-size: clamp(0.8rem, 2.5vw, 0.85rem);">${winner.userName}</div>
                        <div style="font-size: clamp(0.7rem, 2vw, 0.75rem); color: var(--text-light); margin-bottom: 4px;">Number: ${winner.lotteryNumbers[0]}</div>
                        <div style="font-weight: 700; color: var(--success); font-size: clamp(0.85rem, 2.5vw, 0.9rem);">${formatIndianCurrency(winner.prize)}</div>
                    `;
                    
                    consolationContainer.appendChild(winnerCard);
                });
            }, 1000);
            
            // Show final notification
            showNotification(' Winners revealed! Congratulations to all winners!', 'success');
        }

        function displayWinners(allWinners) {
            const winnersDisplay = document.getElementById('winnersDisplay');
            const winnersList = document.getElementById('winnersList');
            
            winnersList.innerHTML = '';
            
            // Generate additional consolation prize winners (mix of bots and real users)
            const additionalConsolationWinners = [];
            for (let i = 4; i <= 20; i++) {
                const isBot = Math.random() > 0.3; // 70% chance of bot winner
                additionalConsolationWinners.push({
                    id: `consolation_${i}_${Date.now()}`,
                    userId: isBot ? `bot_consolation_${i}` : `user_consolation_${i}`,
                    userName: isBot ? getBotName() : `Player ${i}`,
                    userEmail: isBot ? `bot${i}@smartlottery.in` : `player${i}@example.com`,
                    lotteryNumbers: [Math.floor(Math.random() * 90000) + 10000],
                    isBot: isBot,
                    rank: i,
                    prize: allWinners[3]?.prize || 1546, // Use 4th place prize or default
                    prizePosition: allWinners[3]?.prizePosition || '4th-100th Prize',
                    matches: Math.floor(Math.random() * 3) + 1 // 1-3 matches
                });
            }
            
            // Combine all winners
            const extendedWinners = [...allWinners, ...additionalConsolationWinners];
            
            // Separate winners by type
            const top3Winners = extendedWinners.slice(0, 3);
            const consolationWinners = extendedWinners.slice(3, 23); // Show top 20 consolation winners
            const remainingWinners = extendedWinners.slice(23);
            
            // Update global winners list with all winners for Winners tab
            const allWinnersForDisplay = extendedWinners.map(winner => ({
                name: winner.userName,
                contest: CONTEST_TEMPLATES.find(t => extendedWinners[0]?.contestId?.startsWith(t.id))?.title || 'Contest',
                prize: winner.prize,
                date: 'Just now',
                isBot: winner.isBot,
                rank: winner.rank,
                prizePosition: winner.prizePosition,
                winningNumbers: allWinners[0]?.lotteryNumbers || [0],
                lotteryNumbers: winner.lotteryNumbers
            }));
            
            // Force update global winners list for Winners tab
            sampleWinners.splice(0, 0, ...allWinnersForDisplay);
            if (sampleWinners.length > 200) {
                sampleWinners.splice(200);
            }
            
            // Save to all localStorage locations for persistence
            const winnersJson = JSON.stringify(sampleWinners);
            localStorage.setItem('smartLotteryWinners', winnersJson);
            localStorage.setItem('smartLotteryGlobalWinners', winnersJson);
            localStorage.setItem('smartLotteryAllWinners', winnersJson);
            
            // Force update Winners tab immediately
            setTimeout(() => {
                loadWinners();
            }, 500);
            
            // Show winning numbers prominently first
            const winningNumbersDisplay = document.createElement('div');
            winningNumbersDisplay.style.cssText = `
                background: linear-gradient(135deg, #1e3c72, #2a5298);
                color: white;
                padding: 20px;
                border-radius: 16px;
                text-align: center;
                margin-bottom: 20px;
                box-shadow: 0 8px 25px rgba(30, 60, 114, 0.4);
            `;
            winningNumbersDisplay.innerHTML = `
                <div style="font-size: 1.1rem; opacity: 0.9; margin-bottom: 10px;"> WINNING NUMBERS</div>
                <div style="font-size: 3rem; font-weight: 800; letter-spacing: 4px; font-family: 'Courier New', monospace; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    ${allWinners[0]?.lotteryNumbers ? allWinners[0].lotteryNumbers[0] : '00000'}
                </div>
                <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 10px;">Contest has ended - Results declared!</div>
            `;
            winnersList.appendChild(winningNumbersDisplay);
            
            // Header for top 3 winners
            const topWinnersHeader = document.createElement('div');
            topWinnersHeader.style.cssText = `
                background: linear-gradient(135deg, #ffd700, #ffed4e);
                color: #000;
                padding: 16px;
                border-radius: 12px;
                text-align: center;
                font-weight: 800;
                margin-bottom: 16px;
                font-size: 1.2rem;
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            `;
            topWinnersHeader.innerHTML = ` TOP 3 WINNERS `;
            winnersList.appendChild(topWinnersHeader);
            
            // Display top 3 winners with enhanced styling
            top3Winners.forEach((winner, index) => {
                const winnerItem = document.createElement('div');
                winnerItem.className = 'winner-item';
                
                // Different colors for each position
                const bgColors = [
                    'linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 193, 7, 0.2))', // Gold
                    'linear-gradient(135deg, rgba(192, 192, 192, 0.3), rgba(169, 169, 169, 0.2))', // Silver
                    'linear-gradient(135deg, rgba(205, 127, 50, 0.3), rgba(184, 115, 51, 0.2))' // Bronze
                ];
                
                const borderColors = ['#ffd700', '#c0c0c0', '#cd7f32'];
                const icons = ['', '', ''];
                
                winnerItem.style.background = bgColors[index];
                winnerItem.style.border = `3px solid ${borderColors[index]}`;
                winnerItem.style.marginBottom = '12px';
                winnerItem.style.transform = 'scale(1.02)';
                winnerItem.style.boxShadow = `0 6px 20px rgba(0,0,0,0.15)`;
                
                winnerItem.innerHTML = `
                    <div>
                        <div style="font-weight: 800; color: var(--text); margin-bottom: 8px; font-size: 1.2rem;">
                            ${icons[index]} ${winner.prizePosition}
                        </div>
                        <div style="font-weight: 700; color: var(--primary); margin-bottom: 6px; font-size: 1.1rem;">${winner.userName}</div>
                        <div class="winner-numbers" style="font-size: 1.1rem; font-weight: 700;">Number: ${winner.lotteryNumbers[0]}</div>
                        <div style="font-size: 0.95rem; color: var(--text-light); font-weight: 600;">Matches: ${winner.matches} digits</div>
                    </div>
                    <div class="winner-prize" style="font-size: 1.4rem; font-weight: 800;">${formatIndianCurrency(winner.prize)}</div>
                `;
                
                winnersList.appendChild(winnerItem);
            });
            
            // Display consolation winners (4th onwards) - Show up to 20 consolation winners
            if (consolationWinners.length > 0) {
                const consolationHeader = document.createElement('div');
                consolationHeader.style.cssText = `
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                    padding: 14px;
                    border-radius: 12px;
                    text-align: center;
                    font-weight: 700;
                    margin: 20px 0 16px 0;
                    font-size: 1.1rem;
                    box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
                `;
                consolationHeader.innerHTML = ` CONSOLATION PRIZE WINNERS (Top ${Math.min(consolationWinners.length, 15)} shown)`;
                winnersList.appendChild(consolationHeader);
                
                // Show up to 15 consolation winners in a more compact format
                consolationWinners.slice(0, 15).forEach((winner, index) => {
                    const winnerItem = document.createElement('div');
                    winnerItem.className = 'winner-item';
                    winnerItem.style.background = winner.isBot ? 'rgba(16, 185, 129, 0.1)' : 'rgba(59, 130, 246, 0.1)';
                    winnerItem.style.border = winner.isBot ? '2px solid rgba(16, 185, 129, 0.3)' : '2px solid rgba(59, 130, 246, 0.3)';
                    winnerItem.style.marginBottom = '8px';
                    winnerItem.style.padding = '12px';
                    
                    const winnerType = winner.isBot ? '' : '';
                    const winnerTypeLabel = winner.isBot ? '(Featured)' : '(Real Player)';
                    
                    winnerItem.innerHTML = `
                        <div>
                            <div style="font-weight: 700; color: ${winner.isBot ? 'var(--success)' : 'var(--primary)'}; margin-bottom: 4px; font-size: 0.95rem;">
                                ${winnerType} ${winner.rank}${getOrdinalSuffix(winner.rank)} Place ${winnerTypeLabel}
                            </div>
                            <div style="font-weight: 600; color: var(--text); margin-bottom: 3px; font-size: 0.9rem;">${winner.userName}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light); font-weight: 500;">
                                Number: ${winner.lotteryNumbers[0]}  ${winner.matches} matches
                            </div>
                        </div>
                        <div style="font-weight: 700; color: ${winner.isBot ? 'var(--success)' : 'var(--primary)'}; font-size: 1rem;">${formatIndianCurrency(winner.prize)}</div>
                    `;
                    
                    winnersList.appendChild(winnerItem);
                });
                
                // Show summary if there are more consolation winners
                if (consolationWinners.length > 15) {
                    const moreWinnersMsg = document.createElement('div');
                    moreWinnersMsg.style.cssText = `
                        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(59, 130, 246, 0.1));
                        border: 2px dashed rgba(16, 185, 129, 0.3);
                        color: var(--success);
                        padding: 16px;
                        border-radius: 12px;
                        text-align: center;
                        font-weight: 600;
                        margin: 12px 0;
                        font-size: 0.95rem;
                    `;
                    
                    const remainingWinners = consolationWinners.length - 15;
                    const totalPrizeDistributed = consolationWinners.slice(15).reduce((sum, w) => sum + w.prize, 0);
                    
                    moreWinnersMsg.innerHTML = `
                         <strong>+${remainingWinners} more consolation winners</strong><br>
                        <span style="font-size: 0.85rem; opacity: 0.8;">
                            Additional ${formatIndianCurrency(totalPrizeDistributed)} distributed  All updated in Winners tab
                        </span>
                    `;
                    winnersList.appendChild(moreWinnersMsg);
                }
            }
            
            // Show message about remaining winners being updated in contests
            if (remainingWinners.length > 0) {
                const remainingMessage = document.createElement('div');
                remainingMessage.style.cssText = `
                    background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(124, 58, 237, 0.05));
                    border: 2px dashed rgba(79, 70, 229, 0.3);
                    color: var(--primary);
                    padding: 16px;
                    border-radius: 12px;
                    text-align: center;
                    font-weight: 600;
                    margin-top: 16px;
                    font-size: 1rem;
                `;
                remainingMessage.innerHTML = `
                     <strong>${remainingWinners.length} additional winners</strong><br>
                    <span style="font-size: 0.9rem; opacity: 0.8;">All winners and their prizes have been updated in their "My Contests" tab</span>
                `;
                winnersList.appendChild(remainingMessage);
            }
            
            // Global display note
            const globalNote = document.createElement('div');
            globalNote.style.cssText = `
                background: rgba(79, 70, 229, 0.1);
                border-left: 4px solid var(--primary);
                padding: 12px 16px;
                margin: 16px 0;
                border-radius: 8px;
                font-size: 0.9rem;
                color: var(--text);
            `;
            globalNote.innerHTML = `
                <i class="fas fa-globe"></i> <strong>Global Update:</strong> All winners are now visible in the Winners tab for everyone to see.
            `;
            winnersList.appendChild(globalNote);
            
            // Add close button
            const closeButton = document.createElement('div');
            closeButton.style.cssText = `
                text-align: center;
                margin-top: 20px;
            `;
            closeButton.innerHTML = `
                <button class="btn btn-primary" onclick="closeModal('slotMachineModal')" style="font-size: 1.1rem; padding: 12px 24px;">
                    <i class="fas fa-check"></i> Close Draw Results
                </button>
            `;
            winnersList.appendChild(closeButton);
            
            winnersDisplay.style.display = 'block';
        }

        function openChatModal() {
            openModal('chatModal');
        }

        function setAmount(amount) {
            document.getElementById('amountInput').value = amount;
            updatePaymentSummary();
        }

        function updatePaymentSummary() {
            const amount = parseInt(document.getElementById('amountInput').value) || 0;
            document.getElementById('totalAmount').textContent = `${formatIndianCurrency(amount)}`;
            document.getElementById('paymentAmount').textContent = `${formatIndianCurrency(amount)}`;
        }

        async function handlePayment() {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('amountInput').value);
            const transactionId = document.getElementById('transactionId').value.trim();
            
            if (!amount || amount < 10) {
                showNotification('Please enter a valid amount (minimum 10)', 'error');
                return;
            }
            
            if (!transactionId || transactionId.length < 5) {
                showNotification('Please enter a valid transaction ID from your payment receipt', 'error');
                return;
            }
            
            try {
                console.log('Submitting deposit request:', { amount, transactionId });
                
                // Create a unique document ID using timestamp and user ID
                const depositId = `${currentUser.uid}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                
                // Add to user's transactions collection with proper structure
                await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                    type: 'deposit',
                    amount: amount,
                    description: `Deposit request - ${formatIndianCurrency(amount)}`,
                    transactionId: transactionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending',
                    depositId: depositId
                });
                
                // Add to deposits collection for admin approval
                await db.collection('deposits').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || 'Unknown User',
                    amount: amount,
                    transactionId: transactionId,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeModal('addMoneyModal');
                showNotification(` Deposit request submitted! Your deposit of ${formatIndianCurrency(amount)} is pending admin approval.`, 'success');
                
                // Reset form
                document.getElementById('amountInput').value = '';
                document.getElementById('transactionId').value = '';
                updatePaymentSummary();
                
                // Reload transactions
                loadTransactions();
                
            } catch (error) {
                console.error('Error submitting deposit:', error);
                showNotification('Error submitting deposit. Please try again.', 'error');
            }
        }

        async function handleWithdrawal() {
            if (!currentUser) {
                showNotification('Please login first', 'error');
                return;
            }

            const amount = parseInt(document.getElementById('withdrawalAmount').value);
            const upiId = document.getElementById('withdrawalUPI').value.trim();
            
            if (!amount || amount < 500) {
                showNotification('Minimum withdrawal amount is 500', 'error');
                return;
            }
            
            if (amount > userBalance) {
                showNotification('Insufficient balance for withdrawal', 'error');
                return;
            }
            
            if (!upiId || upiId.length < 5) {
                showNotification('Please enter a valid UPI ID', 'error');
                return;
            }
            
            // Validate UPI format (basic check)
            if (!upiId.includes('@') || upiId.indexOf('@') === 0 || upiId.indexOf('@') === upiId.length - 1) {
                showNotification('Please enter a valid UPI ID format (e.g., name@bank)', 'error');
                return;
            }
            
            try {
                console.log('Submitting withdrawal request:', { amount, upiId, userBalance });
                
                // Deduct amount from user balance first
                await db.collection('users').doc(currentUser.uid).update({
                    balance: firebase.firestore.FieldValue.increment(-amount)
                });
                
                // Update local balance
                userBalance -= amount;
                updateBalanceDisplay();
                
                // Add to user's transactions
                await db.collection('users').doc(currentUser.uid).collection('transactions').add({
                    type: 'withdrawal',
                    amount: -amount,
                    description: `Withdrawal request to ${upiId}`,
                    upiId: upiId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'pending'
                });
                
                // Add to withdrawals collection for admin approval
                await db.collection('withdrawals').add({
                    userId: currentUser.uid,
                    userEmail: currentUser.email,
                    userName: currentUser.displayName || 'Unknown User',
                    amount: amount,
                    upiId: upiId,
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`Withdrawal request of ${formatIndianCurrency(amount)} submitted! Amount deducted from balance. Pending admin approval.`, 'success');
                
                // Reset form
                document.getElementById('withdrawalAmount').value = '';
                document.getElementById('withdrawalUPI').value = '';
                
                // Reload transactions
                loadTransactions();
                
            } catch (error) {
                console.error('Error submitting withdrawal:', error);
                showNotification('Error submitting withdrawal. Please try again.', 'error');
            }
        }

        async function loadPendingApprovals() {
            if (!isAdmin) {
                console.log('User is not admin, cannot load approvals');
                return;
            }
            
            console.log('Loading pending approvals for admin user:', currentUser.email);
            
            const pendingDepositsDiv = document.getElementById('pendingDeposits');
            const pendingWithdrawalsDiv = document.getElementById('pendingWithdrawals');
            
            // Show loading state
            if (pendingDepositsDiv) {
                pendingDepositsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Loading deposits...</div></div></div>';
            }
            if (pendingWithdrawalsDiv) {
                pendingWithdrawalsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Loading withdrawals...</div></div></div>';
            }
            
            try {
                // Load pending deposits directly from Firestore
                const depositsSnapshot = await db.collection('deposits')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (pendingDepositsDiv) {
                    pendingDepositsDiv.innerHTML = '';
                    
                    if (depositsSnapshot.empty) {
                        pendingDepositsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> No pending deposits</div><div class="data-item-subtitle">All deposit requests have been processed</div></div></div>';
                    } else {
                        depositsSnapshot.forEach(doc => {
                            const deposit = doc.data();
                            const item = document.createElement('div');
                            item.className = 'data-item';
                            
                            const createdTime = deposit.createdAt ? new Date(deposit.createdAt.toDate()).toLocaleString() : 'Recent';
                            
                            item.innerHTML = `
                                <div class="data-item-info">
                                    <div class="data-item-title">${deposit.userName || 'Unknown User'} - ${formatIndianCurrency(deposit.amount)}</div>
                                    <div class="data-item-subtitle">
                                        Transaction ID: ${deposit.transactionId || 'N/A'}<br>
                                        Email: ${deposit.userEmail || 'N/A'}<br>
                                        Submitted: ${createdTime}<br>
                                        Status: ${deposit.status}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-direction: column;">
                                    <button class="btn btn-success" onclick="approveDeposit('${doc.id}', '${deposit.userId}', ${deposit.amount}, '${deposit.transactionId}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-secondary" onclick="rejectDeposit('${doc.id}', '${deposit.userId}', '${deposit.transactionId}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            `;
                            pendingDepositsDiv.appendChild(item);
                        });
                    }
                    
                    // Update admin stats
                    document.getElementById('adminPendingDeposits').textContent = depositsSnapshot.size;
                }
                
                // Load pending withdrawals directly from Firestore
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .orderBy('createdAt', 'desc')
                    .get();
                
                if (pendingWithdrawalsDiv) {
                    pendingWithdrawalsDiv.innerHTML = '';
                    
                    if (withdrawalsSnapshot.empty) {
                        pendingWithdrawalsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> No pending withdrawals</div><div class="data-item-subtitle">All withdrawal requests have been processed</div></div></div>';
                    } else {
                        withdrawalsSnapshot.forEach(doc => {
                            const withdrawal = doc.data();
                            const item = document.createElement('div');
                            item.className = 'data-item';
                            
                            const createdTime = withdrawal.createdAt ? new Date(withdrawal.createdAt.toDate()).toLocaleString() : 'Recent';
                            
                            item.innerHTML = `
                                <div class="data-item-info">
                                    <div class="data-item-title">${withdrawal.userName || 'Unknown User'} - ${formatIndianCurrency(withdrawal.amount)}</div>
                                    <div class="data-item-subtitle">
                                        UPI ID: ${withdrawal.upiId || 'N/A'}<br>
                                        Email: ${withdrawal.userEmail || 'N/A'}<br>
                                        Submitted: ${createdTime}<br>
                                        Status: ${withdrawal.status}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 8px; flex-direction: column;">
                                    <button class="btn btn-success" onclick="approveWithdrawal('${doc.id}', '${withdrawal.userId}', ${withdrawal.amount}, '${withdrawal.upiId}')">
                                        <i class="fas fa-check"></i> Approve
                                    </button>
                                    <button class="btn btn-secondary" onclick="rejectWithdrawal('${doc.id}', '${withdrawal.userId}', '${withdrawal.upiId}')">
                                        <i class="fas fa-times"></i> Reject
                                    </button>
                                </div>
                            `;
                            pendingWithdrawalsDiv.appendChild(item);
                        });
                    }
                    
                    // Update admin stats
                    document.getElementById('adminPendingWithdrawals').textContent = withdrawalsSnapshot.size;
                }
                
                console.log('Admin panel loaded successfully from Firestore');
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                
                // Show error message
                if (pendingDepositsDiv) {
                    pendingDepositsDiv.innerHTML = `<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading deposits</div><div class="data-item-subtitle">Error: ${error.message}</div></div></div>`;
                }
                
                if (pendingWithdrawalsDiv) {
                    pendingWithdrawalsDiv.innerHTML = `<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading withdrawals</div><div class="data-item-subtitle">Error: ${error.message}</div></div></div>`;
                }
                
                showNotification('Error loading admin data: ' + error.message, 'error');
            }
        }

        async function approveDeposit(depositId, userId, amount, transactionId) {
            try {
                console.log('Approving deposit:', { depositId, userId, amount, transactionId });
                
                // Update deposit status
                await db.collection('deposits').doc(depositId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.email
                });
                
                // Update user balance
                await db.collection('users').doc(userId).update({
                    balance: firebase.firestore.FieldValue.increment(amount)
                });
                
                // Add approved transaction to user's transactions
                await db.collection('users').doc(userId).collection('transactions').add({
                    type: 'deposit',
                    amount: amount,
                    description: `Deposit approved - ${transactionId}`,
                    status: 'completed',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`Deposit of ${formatIndianCurrency(amount)} approved successfully!`, 'success');
                loadAdminApprovals();
                
            } catch (error) {
                console.error('Error approving deposit:', error);
                showNotification('Error approving deposit: ' + error.message, 'error');
            }
        }

        async function rejectDeposit(depositId, userId, transactionId) {
            try {
                console.log('Rejecting deposit:', { depositId, userId, transactionId });
                
                // Update deposit status
                await db.collection('deposits').doc(depositId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: currentUser.email,
                    rejectionReason: 'Admin rejected'
                });
                
                showNotification('Deposit rejected successfully!', 'success');
                loadAdminApprovals();
                
            } catch (error) {
                console.error('Error rejecting deposit:', error);
                showNotification('Error rejecting deposit: ' + error.message, 'error');
            }
        }

        async function approveWithdrawal(withdrawalId, userId, amount, upiId) {
            try {
                console.log('Approving withdrawal:', { withdrawalId, userId, amount, upiId });
                
                // Update withdrawal status
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'approved',
                    approvedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    approvedBy: currentUser.email
                });
                
                // Add approved transaction to user's transactions
                await db.collection('users').doc(userId).collection('transactions').add({
                    type: 'withdrawal',
                    amount: -amount,
                    description: `Withdrawal approved to ${upiId}`,
                    status: 'completed',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification(`Withdrawal of ${formatIndianCurrency(amount)} approved successfully!`, 'success');
                loadAdminApprovals();
                
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                showNotification('Error approving withdrawal: ' + error.message, 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId, userId, upiId) {
            try {
                console.log('Rejecting withdrawal:', { withdrawalId, userId, upiId });
                
                const withdrawalDoc = await db.collection('withdrawals').doc(withdrawalId).get();
                const withdrawal = withdrawalDoc.data();
                
                // Update withdrawal status
                await db.collection('withdrawals').doc(withdrawalId).update({
                    status: 'rejected',
                    rejectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    rejectedBy: currentUser.email,
                    rejectionReason: 'Admin rejected'
                });
                
                // Refund amount to user balance
                await db.collection('users').doc(userId).update({
                    balance: firebase.firestore.FieldValue.increment(withdrawal.amount)
                });
                
                // Add refund transaction
                await db.collection('users').doc(userId).collection('transactions').add({
                    type: 'refund',
                    amount: withdrawal.amount,
                    description: `Withdrawal rejected - refund to ${upiId}`,
                    status: 'completed',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showNotification('Withdrawal rejected and amount refunded!', 'success');
                loadAdminApprovals();
                
            } catch (error) {
                console.error('Error rejecting withdrawal:', error);
                showNotification('Error rejecting withdrawal: ' + error.message, 'error');
            }
        }

        function updateLiveStats() {
            const totalUsers = document.getElementById('totalUsers');
            const winnersToday = document.getElementById('winnersToday');
            
            if (totalUsers) {
                const currentCount = parseInt(totalUsers.textContent.replace(/,/g, ''));
                totalUsers.textContent = (currentCount + Math.floor(Math.random() * 5)).toLocaleString('en-IN');
            }
            
            if (winnersToday) {
                const currentWinners = parseInt(winnersToday.textContent);
                winnersToday.textContent = currentWinners + Math.floor(Math.random() * 3);
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        function getFirebaseErrorMessage(error) {
            switch (error.code) {
                case 'auth/user-not-found':
                    return 'No account found with this email address.';
                case 'auth/wrong-password':
                    return 'Incorrect password. Please try again.';
                case 'auth/email-already-in-use':
                    return 'An account with this email already exists.';
                case 'auth/weak-password':
                    return 'Password should be at least 6 characters.';
                case 'auth/invalid-email':
                    return 'Please enter a valid email address.';
                default:
                    return error.message;
            }
        }

        // Simplified admin functions
        function loadAdminContestGrid() {
            const adminGrid = document.getElementById('adminContestGrid');
            adminGrid.innerHTML = '';
            
            CONTEST_TEMPLATES.forEach(template => {
                const contest = globalContestState[template.id] || template;
                const card = document.createElement('div');
                card.className = 'contest-card';
                card.style.background = 'rgba(255, 255, 255, 0.95)';
                card.style.border = '2px solid var(--warning)';
                
                const endTime = contest.endTime ? new Date(contest.endTime).toLocaleString() : 'Not scheduled';
                const timeLeft = contest.endTime ? getTimeLeft(contest.endTime, template.id) : 'No timer';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="contest-title" style="margin: 0; font-size: 1.1rem;">
                            <i class="fas fa-cog"></i> ${template.title}
                        </div>
                        <div style="background: var(--warning); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                            ADMIN
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 8px;">
                            <strong>Prize Pool:</strong> ${formatIndianCurrency(template.prizePool)}<br>
                            <strong>Entry Fee:</strong> ${template.entryFee}<br>
                            <strong>Participants:</strong> ${contest.participants || 0}/${template.maxParticipants}<br>
                            <strong>Time Left:</strong> ${timeLeft}
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="btn btn-success" onclick="declareContestWinner('${template.id}')" style="font-size: 0.85rem; padding: 10px;">
                            <i class="fas fa-crown"></i> End & Draw
                        </button>
                        <button class="btn btn-outline" onclick="restartContest('${template.id}')" style="font-size: 0.85rem; padding: 10px;">
                            <i class="fas fa-restart"></i> Restart
                        </button>
                    </div>
                    
                    <button class="btn btn-primary btn-full" onclick="simulateContestDraw()" style="margin-top: 8px; font-size: 0.85rem; padding: 8px; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        <i class="fas fa-play"></i> Test Draw Simulation
                    </button>
                `;
                
                adminGrid.appendChild(card);
            });
        }

        async function loadAdminApprovals() {
            if (!isAdmin) return;
            
            const depositsDiv = document.getElementById('adminDeposits');
            const withdrawalsDiv = document.getElementById('adminWithdrawals');
            
            try {
                // Load deposits with simple query
                const depositsSnapshot = await db.collection('deposits')
                    .where('status', '==', 'pending')
                    .limit(10)
                    .get();
                
                depositsDiv.innerHTML = '';
                if (depositsSnapshot.empty) {
                    depositsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> No pending deposits</div></div></div>';
                } else {
                    depositsSnapshot.forEach(doc => {
                        const deposit = doc.data();
                        const item = document.createElement('div');
                        item.className = 'data-item';
                        
                        item.innerHTML = `
                            <div class="data-item-info">
                                <div class="data-item-title">${deposit.userName || 'User'} - ${formatIndianCurrency(deposit.amount)}</div>
                                <div class="data-item-subtitle">
                                    Transaction: ${deposit.transactionId || 'N/A'}<br>
                                    Email: ${deposit.userEmail || 'N/A'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success" onclick="approveDeposit('${doc.id}', '${deposit.userId}', ${deposit.amount}, '${deposit.transactionId}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                     Approve
                                </button>
                                <button class="btn btn-secondary" onclick="rejectDeposit('${doc.id}', '${deposit.userId}', '${deposit.transactionId}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                     Reject
                                </button>
                            </div>
                        `;
                        depositsDiv.appendChild(item);
                    });
                }
                
                // Update admin stats
                document.getElementById('adminStatsDeposits').textContent = depositsSnapshot.size;
                
                // Load withdrawals with simple query
                const withdrawalsSnapshot = await db.collection('withdrawals')
                    .where('status', '==', 'pending')
                    .limit(10)
                    .get();
                
                withdrawalsDiv.innerHTML = '';
                if (withdrawalsSnapshot.empty) {
                    withdrawalsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> No pending withdrawals</div></div></div>';
                } else {
                    withdrawalsSnapshot.forEach(doc => {
                        const withdrawal = doc.data();
                        const item = document.createElement('div');
                        item.className = 'data-item';
                        
                        item.innerHTML = `
                            <div class="data-item-info">
                                <div class="data-item-title">${withdrawal.userName || 'User'} - ${formatIndianCurrency(withdrawal.amount)}</div>
                                <div class="data-item-subtitle">
                                    UPI: ${withdrawal.upiId || 'N/A'}<br>
                                    Email: ${withdrawal.userEmail || 'N/A'}
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-success" onclick="approveWithdrawal('${doc.id}', '${withdrawal.userId}', ${withdrawal.amount}, '${withdrawal.upiId}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                     Approve
                                </button>
                                <button class="btn btn-secondary" onclick="rejectWithdrawal('${doc.id}', '${withdrawal.userId}', '${withdrawal.upiId}')" style="font-size: 0.8rem; padding: 6px 12px;">
                                     Reject
                                </button>
                            </div>
                        `;
                        withdrawalsDiv.appendChild(item);
                    });
                }
                
                // Update admin stats
                document.getElementById('adminStatsWithdrawals').textContent = withdrawalsSnapshot.size;
                
            } catch (error) {
                console.error('Error loading admin data:', error);
                depositsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading deposits</div></div></div>';
                withdrawalsDiv.innerHTML = '<div class="data-item"><div class="data-item-info"><div class="data-item-title"> Error loading withdrawals</div></div></div>';
            }
        }

        async function loadAdminStats() {
            if (!isAdmin) return;
            
            try {
                // Load user count
                const usersSnapshot = await db.collection('users').get();
                document.getElementById('adminStatsUsers').textContent = usersSnapshot.size;
                
                // Load pending counts
                loadAdminApprovals();
                
            } catch (error) {
                console.error('Error loading admin stats:', error);
            }
        }
    </script>
<footer style="background: linear-gradient(135deg, #1e3c72, #2a5298); color: white; padding: 40px 20px; margin-top: 50px; border-top-left-radius: 25px; border-top-right-radius: 25px;">
<div style="max-width: 1200px; margin: auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px;">
<div>
<h3 style="margin-bottom: 15px; font-size: 1.2rem;">Smart Lottery</h3>
<p style="font-size: 0.95rem;">India's most trusted lottery platform. Play responsibly and win big!</p>
</div>
<div>
<h4 style="margin-bottom: 10px;">Quick Links</h4>
<ul style="list-style: none; padding: 0; font-size: 0.95rem;">
<li><a href="#contestsTab" style="color: white; text-decoration: none;">Contests</a></li>
<li><a href="#winnersTab" style="color: white; text-decoration: none;">Winners</a></li>
<li><a href="#referralsTab" style="color: white; text-decoration: none;">Referral Program</a></li>
<li><a href="#withdrawalTab" style="color: white; text-decoration: none;">Withdrawals</a></li>
<li><a href="#termsAgreement" style="color: white; text-decoration: none;">Terms &amp; Conditions</a></li>
</ul>
</div>
<div>
<h4 style="margin-bottom: 10px;">Support</h4>
<p style="font-size: 0.95rem;"><i class="fas fa-envelope"></i> support@smartlottery.in</p>
<p style="font-size: 0.95rem;"><i class="fab fa-telegram"></i> <a href="https://t.me/+K-Ro-WZBF7FmMTA1" style="color: white; text-decoration: none;" target="_blank">Join Telegram Channel</a></p>
</div>
<div>
<h4 style="margin-bottom: 10px;">Follow Us</h4>
<div style="display: flex; gap: 10px;">
<a href="#" style="color: white; font-size: 1.2rem;"><i class="fab fa-facebook-f"></i></a>
<a href="#" style="color: white; font-size: 1.2rem;"><i class="fab fa-instagram"></i></a>
<a href="#" style="color: white; font-size: 1.2rem;"><i class="fab fa-twitter"></i></a>
</div>
</div>
</div>
<div style="text-align: center; margin-top: 30px; font-size: 0.85rem; color: #ccc;">
     2025 Smart Lottery. All Rights Reserved.
  </div>
</footer>
<script>
// ========================== FIX: Prevent 0 participants ==========================
function ensureContestParticipants() {
    for (const id in globalContestState) {
        if (globalContestState[id].participants === 0) {
            globalContestState[id].participants = Math.floor(Math.random() * 300) + 200;
        }
    }
    generateActiveContests();
}
ensureContestParticipants();

// ========================== FIX: Update participants count after join ==========================
async function updateParticipantsAfterJoin(templateId) {
    const contestRef = db.collection('contestStats').doc(templateId);
    await contestRef.update({
        realParticipants: firebase.firestore.FieldValue.increment(1),
        totalParticipants: firebase.firestore.FieldValue.increment(1),
        participants: firebase.firestore.FieldValue.increment(1),
        lastUpdated: firebase.firestore.FieldValue.serverTimestamp(),
        lastJoinerId: currentUser.uid,
        lastJoinerName: currentUser.displayName || 'Unknown User'
    });
    if (globalContestState[templateId]) {
        globalContestState[templateId].participants += 1;
    }
    generateActiveContests();
}

// ========================== FIX: Ensure winners tab always loads ==========================
if (!localStorage.getItem('smartLotteryWinners')) {
    initializeSampleWinners();
}
loadWinners();
window.addEventListener('winners_updated', () => {
    setTimeout(loadWinners, 500);
});

// ========================== FIX: Global slot machine ==========================
window.addEventListener('storage', (e) => {
    if (e.key === 'activeDraw') {
        const drawData = JSON.parse(e.newValue || '{}');
        if (drawData.contestId) {
            showSlotMachineDraw(drawData.contestId, []);
        }
    }
});
</script>

<script>
// ========================== FIX: Prevent duplicate winner declarations ==========================
if (!window.lastWinnerUpdate) window.lastWinnerUpdate = {};

async function safeDeclareWinner(contestId) {
    const now = Date.now();
    const key = 'declaration_' + contestId;
    if (window.lastWinnerUpdate[key] && (now - window.lastWinnerUpdate[key]) < 60000) {
        console.log('Skipping duplicate winner declaration for', contestId);
        return;
    }
    window.lastWinnerUpdate[key] = now;
    await declareContestWinner(contestId);
}

// ========================== FIX: Winners tab refresh ==========================
window.addEventListener('message', (event) => {
    if (event.data?.type === 'draw_completed' && event.data.winners) {
        // Update winners tab
        sampleWinners.unshift(...event.data.winners);
        if (sampleWinners.length > 100) sampleWinners.length = 100;
        localStorage.setItem('smartLotteryWinners', JSON.stringify(sampleWinners));
        loadWinners();

        // Open slot machine globally
        showSlotMachineDraw(event.data.contestId, []);
        updateSlotMachineResults(event.data.winningNumbers, event.data.winners);

        // Refresh profiles for all users
        if (currentUser) {
            setTimeout(async () => {
                await loadUserData(currentUser);
                updateBalanceDisplay();
                updateProfile();
                loadJoinedContests();
            }, 2000);
        }
    }
});
</script>
</body>
</html>